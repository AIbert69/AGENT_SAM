<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Singh Automation - AI Contract Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --green: #9ACD32; --green-dark: #7BA428;
            --dark: #0a0a0a; --card: #141414; --card-hover: #1a1a1a; --border: #2a2a2a;
            --gray: #888; --blue: #3b82f6; --purple: #8b5cf6; --orange: #f59e0b; --red: #ef4444;
        }
        body { font-family: 'Inter', sans-serif; background: var(--dark); color: #fff; min-height: 100vh; }
        
        .header { 
            background: linear-gradient(180deg, #111 0%, var(--dark) 100%);
            padding: 0.75rem 1.5rem; display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 1px solid var(--border); position: sticky; top: 0; z-index: 100;
        }
        .logo { display: flex; align-items: center; gap: 0.6rem; }
        .logo-icon { width: 38px; height: 38px; background: linear-gradient(135deg, var(--green), var(--green-dark)); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #000; }
        .logo-text { font-size: 1.2rem; font-weight: 700; }
        .logo-text span { color: var(--green); }
        
        .nav { display: flex; gap: 0.25rem; background: var(--card); padding: 0.25rem; border-radius: 8px; }
        .nav-btn { padding: 0.5rem 1rem; background: transparent; border: none; border-radius: 6px; color: var(--gray); cursor: pointer; font-weight: 500; font-size: 0.8rem; transition: all 0.2s; }
        .nav-btn:hover { color: #fff; background: rgba(255,255,255,0.05); }
        .nav-btn.active { background: var(--green); color: #000; }
        
        .status { display: flex; align-items: center; gap: 0.4rem; font-size: 0.75rem; color: var(--gray); }
        .status-dot { width: 6px; height: 6px; border-radius: 50%; background: var(--gray); }
        .status-dot.live { background: var(--green); box-shadow: 0 0 8px var(--green); }
        
        /* Mode indicator - Production Mode */
        .mode-indicator { display: flex; align-items: center; gap: 0.4rem; padding: 0.25rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        .mode-indicator .mode-dot { width: 8px; height: 8px; border-radius: 50%; }
        .mode-ready { background: rgba(107, 114, 128, 0.2); color: var(--gray); }
        .mode-ready .mode-dot { background: var(--gray); }
        .mode-live { background: rgba(154, 205, 50, 0.2); color: var(--green); border: 1px solid var(--green); }
        .mode-live .mode-dot { background: var(--green); box-shadow: 0 0 6px var(--green); }
        .mode-error { background: rgba(239, 68, 68, 0.2); color: var(--red); border: 1px solid var(--red); }
        .mode-error .mode-dot { background: var(--red); animation: pulse 1s infinite; }
        
        /* Hard error display */
        .hard-error { background: rgba(239, 68, 68, 0.1); border: 2px solid var(--red); border-radius: 8px; padding: 1rem; margin: 1rem 0; }
        .hard-error-title { color: var(--red); font-weight: 700; font-size: 1rem; margin: 0 0 0.5rem; }
        .hard-error-details { font-family: monospace; font-size: 0.75rem; background: #0a0a0a; padding: 0.75rem; border-radius: 4px; overflow-x: auto; }
        .hard-error-field { display: flex; gap: 0.5rem; margin: 0.25rem 0; }
        .hard-error-field label { color: var(--gray); min-width: 100px; }
        .hard-error-field span { color: #fff; word-break: break-all; }
        
        .btn { padding: 0.5rem 1rem; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 0.8rem; transition: all 0.15s; display: inline-flex; align-items: center; gap: 0.3rem; }
        .btn-primary { background: var(--green); color: #000; }
        .btn-primary:hover { background: var(--green-dark); }
        .btn-secondary { background: var(--card); color: #fff; border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--card-hover); }
        .btn-sm { padding: 0.35rem 0.7rem; font-size: 0.75rem; }
        .btn-go { background: var(--green); color: #000; }
        .btn-review { background: var(--orange); color: #000; }
        .btn-nogo { background: var(--red); color: #fff; }
        .btn-proposal { background: linear-gradient(135deg, var(--green), var(--green-dark)); color: #000; }
        .btn-proposal:hover { box-shadow: 0 0 12px rgba(154, 205, 50, 0.4); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .config-bar { background: rgba(154,205,50,0.03); border-bottom: 1px solid var(--border); padding: 0.6rem 1.5rem; display: flex; align-items: center; gap: 0.75rem; flex-wrap: wrap; }
        .config-bar label { font-size: 0.75rem; color: var(--green); font-weight: 500; }
        .config-bar input { padding: 0.4rem 0.6rem; background: var(--card); border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.8rem; }
        .config-bar input:focus { outline: none; border-color: var(--green); }
        
        .stats-bar { display: grid; grid-template-columns: repeat(6, 1fr); gap: 0.75rem; padding: 1rem 1.5rem; background: #0d0d0d; }
        .stat { background: var(--card); padding: 0.75rem; border-radius: 8px; text-align: center; border: 1px solid var(--border); }
        .stat-value { font-size: 1.5rem; font-weight: 700; color: var(--green); }
        .stat-label { font-size: 0.65rem; color: var(--gray); text-transform: uppercase; }
        
        .main { display: grid; grid-template-columns: 180px 1fr 240px; gap: 1rem; padding: 1rem 1.5rem; min-height: calc(100vh - 180px); }
        .main-full { grid-template-columns: 1fr; max-width: 1000px; margin: 0 auto; }
        
        .panel { background: var(--card); border-radius: 8px; padding: 0.75rem; border: 1px solid var(--border); }
        .panel-title { font-size: 0.7rem; color: var(--green); margin-bottom: 0.6rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; }
        
        .sidebar { display: flex; flex-direction: column; gap: 0.75rem; }
        .source-item { display: flex; justify-content: space-between; padding: 0.4rem 0; border-bottom: 1px solid #1a1a1a; font-size: 0.8rem; }
        .badge { font-size: 0.55rem; padding: 0.15rem 0.4rem; border-radius: 3px; font-weight: 600; }
        .badge-live { background: var(--green); color: #000; }
        .cert-badge { display: inline-block; background: #1a1a1a; padding: 0.2rem 0.4rem; border-radius: 3px; font-size: 0.6rem; margin: 0.1rem; }
        
        .tabs { display: flex; gap: 0.3rem; flex-wrap: wrap; }
        .tab { padding: 0.4rem 0.8rem; background: var(--card); border: 1px solid var(--border); border-radius: 6px; color: #aaa; cursor: pointer; font-size: 0.75rem; font-weight: 500; transition: all 0.15s; }
        .tab:hover { background: var(--card-hover); color: #fff; }
        .tab.active { background: var(--green); color: #000; border-color: var(--green); }
        
        .filter-bar { display: flex; gap: 0.4rem; flex-wrap: wrap; align-items: center; background: var(--card); padding: 0.5rem; border-radius: 6px; border: 1px solid var(--border); }
        .search-input { flex: 1; min-width: 150px; padding: 0.4rem 0.75rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.8rem; }
        .filter-pill { padding: 0.3rem 0.6rem; background: #1a1a1a; border: none; border-radius: 12px; color: #aaa; cursor: pointer; font-size: 0.7rem; }
        .filter-pill:hover { background: #222; color: #fff; }
        .filter-pill.active { background: var(--green); color: #000; }
        
        .opp-list { display: flex; flex-direction: column; gap: 0.5rem; max-height: calc(100vh - 350px); overflow-y: auto; }
        .opp-list::-webkit-scrollbar { width: 4px; }
        .opp-list::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        
        .opp-card { background: var(--card); border-radius: 8px; padding: 0.75rem; border: 1px solid var(--border); position: relative; cursor: pointer; transition: all 0.15s; }
        .opp-card:hover { background: var(--card-hover); border-color: #333; }
        .opp-card.qualified { border-left: 3px solid var(--green); }
        .opp-card.not-qualified { opacity: 0.5; border-left: 3px solid var(--red); }
        .opp-card.review { border-left: 3px solid var(--orange); }
        .opp-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.4rem; }
        .opp-title { font-size: 0.85rem; font-weight: 600; flex: 1; margin-right: 3.5rem; line-height: 1.3; }
        .opp-type { font-size: 0.55rem; padding: 0.15rem 0.4rem; border-radius: 3px; text-transform: uppercase; font-weight: 600; }
        .opp-type.contract { background: var(--blue); }
        .opp-type.sbir { background: var(--purple); }
        .opp-type.state { background: var(--orange); }
        .opp-meta { display: flex; gap: 0.75rem; font-size: 0.65rem; color: var(--gray); margin-bottom: 0.4rem; flex-wrap: wrap; }
        .opp-desc { font-size: 0.7rem; color: #777; margin-bottom: 0.4rem; line-height: 1.4; }
        .opp-tags { display: flex; gap: 0.2rem; flex-wrap: wrap; }
        .tag { font-size: 0.55rem; padding: 0.1rem 0.35rem; border-radius: 3px; background: rgba(154,205,50,0.1); color: var(--green); }
        .tag-nq { background: rgba(239,68,68,0.1); color: #f87171; }
        .match-score { position: absolute; top: 0.75rem; right: 0.75rem; background: var(--green); color: #000; padding: 0.15rem 0.4rem; border-radius: 4px; font-weight: 700; font-size: 0.75rem; }
        .match-score.medium { background: var(--orange); }
        .match-score.low { background: #333; color: #888; }
        
        .right-panel { display: flex; flex-direction: column; gap: 0.75rem; }
        .alert-item { display: flex; align-items: center; gap: 0.4rem; padding: 0.4rem; background: #1a1a1a; border-radius: 4px; font-size: 0.7rem; margin-bottom: 0.3rem; cursor: pointer; }
        .alert-item:hover { background: #222; }
        .alert-dot { width: 6px; height: 6px; border-radius: 50%; }
        .alert-dot.red { background: var(--red); }
        .alert-dot.green { background: var(--green); }
        .alert-dot.orange { background: var(--orange); }
        
        /* Modal */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 1000; align-items: flex-start; justify-content: center; padding: 2rem; overflow-y: auto; }
        .modal-overlay.active { display: flex; }
        .modal { background: var(--card); border-radius: 12px; max-width: 900px; width: 100%; border: 1px solid var(--border); }
        .modal-header { padding: 1rem; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .modal-header h2 { font-size: 1rem; font-weight: 600; }
        .modal-close { background: none; border: none; color: var(--gray); font-size: 1.25rem; cursor: pointer; }
        .modal-body { padding: 1rem; max-height: 70vh; overflow-y: auto; }
        .modal-footer { padding: 1rem; border-top: 1px solid var(--border); display: flex; gap: 0.5rem; flex-wrap: wrap; }
        
        .modal-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; margin-bottom: 1rem; }
        .modal-item { background: #1a1a1a; padding: 0.6rem; border-radius: 6px; }
        .modal-item label { font-size: 0.6rem; color: var(--gray); display: block; text-transform: uppercase; margin-bottom: 0.2rem; }
        .modal-item strong { font-size: 0.85rem; }
        
        .eligibility-banner { padding: 0.75rem; border-radius: 8px; margin-bottom: 1rem; display: flex; align-items: center; gap: 0.6rem; }
        .eligibility-banner.go { background: rgba(154,205,50,0.1); border: 1px solid var(--green); }
        .eligibility-banner.review { background: rgba(245,158,11,0.1); border: 1px solid var(--orange); }
        .eligibility-banner.nogo { background: rgba(239,68,68,0.1); border: 1px solid var(--red); }
        .eligibility-banner .icon { font-size: 1.5rem; }
        .eligibility-banner .text strong { display: block; font-size: 1rem; }
        .eligibility-banner.go strong { color: var(--green); }
        .eligibility-banner.review strong { color: var(--orange); }
        .eligibility-banner.nogo strong { color: var(--red); }
        .eligibility-banner .text p { font-size: 0.75rem; color: var(--gray); margin: 0.2rem 0 0; }
        
        /* Validation Results */
        .validation-section { background: #0d0d0d; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .validation-section h3 { font-size: 0.85rem; color: var(--green); margin-bottom: 0.75rem; display: flex; align-items: center; gap: 0.4rem; }
        .check-list { display: flex; flex-direction: column; gap: 0.5rem; }
        .check-item { display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: var(--card); border-radius: 6px; }
        .check-status { width: 24px; height: 24px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.75rem; flex-shrink: 0; }
        .check-status.pass { background: rgba(154,205,50,0.2); color: var(--green); }
        .check-status.fail { background: rgba(239,68,68,0.2); color: var(--red); }
        .check-status.warn { background: rgba(245,158,11,0.2); color: var(--orange); }
        .check-status.review { background: rgba(59,130,246,0.2); color: var(--blue); }
        .check-content { flex: 1; }
        .check-content strong { font-size: 0.8rem; display: block; }
        .check-content span { font-size: 0.7rem; color: var(--gray); }
        
        /* Context Summary & Compliance Checklist */
        .context-summary { background: rgba(59,130,246,0.1); border: 1px solid rgba(59,130,246,0.3); border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem; font-size: 0.8rem; }
        .context-summary strong { color: var(--blue); }
        .compliance-checklist { background: rgba(154,205,50,0.05); border: 1px solid rgba(154,205,50,0.2); border-radius: 6px; padding: 1rem; margin-top: 1.5rem; }
        .compliance-checklist h3 { color: var(--green); font-size: 0.9rem; margin-bottom: 0.75rem; }
        .compliance-checklist ul { list-style: none; padding: 0; margin: 0; }
        .compliance-checklist li { padding: 0.3rem 0; font-size: 0.8rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .compliance-checklist li:last-child { border-bottom: none; }
        .gen-info { margin-top: 1rem; padding-top: 0.75rem; border-top: 1px solid var(--border); text-align: center; color: var(--gray); }
        
        .timeline-item { display: flex; gap: 0.75rem; padding: 0.5rem 0; border-left: 2px solid var(--border); margin-left: 0.5rem; padding-left: 1rem; position: relative; }
        .timeline-item::before { content: ''; position: absolute; left: -5px; top: 0.65rem; width: 8px; height: 8px; border-radius: 50%; background: var(--border); }
        .timeline-item.critical::before { background: var(--green); }
        .timeline-date { font-size: 0.7rem; color: var(--green); font-weight: 600; min-width: 80px; }
        .timeline-task { font-size: 0.8rem; }
        .timeline-days { font-size: 0.65rem; color: var(--gray); }
        
        .next-steps { display: flex; flex-direction: column; gap: 0.3rem; }
        .next-step { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; padding: 0.4rem; background: var(--card); border-radius: 4px; }
        .next-step::before { content: '‚Üí'; color: var(--green); }
        
        /* Page sections */
        .page { display: none; }
        .page.active { display: block; }
        
        .form-group { margin-bottom: 1rem; }
        .form-group label { display: block; font-size: 0.75rem; color: var(--green); margin-bottom: 0.4rem; font-weight: 500; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 0.6rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 6px; color: #fff; font-size: 0.85rem; }
        .form-group input:focus { outline: none; border-color: var(--green); }
        .form-hint { font-size: 0.65rem; color: var(--gray); margin-top: 0.3rem; }
        .form-hint a { color: var(--green); }
        
        .loading-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; flex-direction: column; gap: 0.75rem; }
        .loading-overlay.active { display: flex; }
        .spinner { width: 40px; height: 40px; border: 3px solid #333; border-top-color: var(--green); border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-4px); } }
        
        /* Score breakdown tooltip */
        .score-badge { position: relative; cursor: help; }
        .score-tooltip { 
            display: none; position: absolute; bottom: 100%; left: 50%; transform: translateX(-50%); 
            background: #1a1a1a; border: 1px solid var(--border); border-radius: 6px; padding: 0.5rem;
            min-width: 180px; z-index: 100; box-shadow: 0 4px 12px rgba(0,0,0,0.5);
        }
        .score-badge:hover .score-tooltip { display: block; }
        .score-tooltip-title { font-size: 0.65rem; color: var(--green); margin-bottom: 0.3rem; font-weight: 600; }
        .score-tooltip-row { display: flex; justify-content: space-between; font-size: 0.7rem; padding: 0.15rem 0; }
        .score-tooltip-row span:first-child { color: var(--gray); }
        .score-tooltip-row span:last-child { color: var(--green); font-weight: 600; }
        
        .log-panel { background: #0a0a0a; border-radius: 4px; padding: 0.4rem; font-family: monospace; font-size: 0.6rem; max-height: 60px; overflow-y: auto; }
        .log-entry { padding: 0.1rem 0; color: #555; }
        .log-entry.success { color: var(--green); }
        .log-entry.error { color: var(--red); }
        .log-entry.info { color: var(--blue); }
        
        @media (max-width: 1000px) { .main { grid-template-columns: 1fr; } .sidebar, .right-panel { display: none; } .stats-bar { grid-template-columns: repeat(3, 1fr); } }
        
        /* Quote Request Button & Modal */
        .btn-quote { background: linear-gradient(135deg, #4a90d9 0%, #357abd 100%); color: white; }
        .btn-quote:hover { box-shadow: 0 4px 12px rgba(74,144,217,0.4); transform: translateY(-1px); }
        
        /* Quote Modal Styles */
        #quoteRequestModal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.85);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            overflow-y: auto;
        }
        .quote-modal {
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 12px;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        .quote-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: rgba(154,205,50,0.05);
        }
        .quote-modal-body {
            padding: 1.5rem;
        }
        .quote-modal-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border);
            background: rgba(0,0,0,0.2);
        }
        .quote-warning {
            background: rgba(245,158,11,0.1);
            border: 1px solid var(--orange);
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 1rem;
        }
        .quote-section {
            background: rgba(0,0,0,0.2);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .quote-items-table {
            width: 100%;
            border-collapse: collapse;
        }
        .quote-items-table th,
        .quote-items-table td {
            padding: 0.5rem;
            text-align: left;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
        }
        .quote-items-table th {
            color: var(--gray);
            font-weight: 500;
        }
        .quote-type-badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .quote-type-badge.dist { background: rgba(16,185,129,0.2); color: #34d399; }
        .quote-type-badge.integ { background: rgba(139,92,246,0.2); color: #a78bfa; }
        .quote-type-badge.service { background: rgba(59,130,246,0.2); color: #60a5fa; }
        .quote-type-badge.unclear { background: rgba(100,100,100,0.2); color: #888; }
        .quote-warning { background: rgba(245,158,11,0.1); border: 1px solid var(--orange); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; }
        .quote-section { background: #1a1a1a; border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
        .quote-items-table { width: 100%; border-collapse: collapse; font-size: 0.8rem; }
        .quote-items-table th, .quote-items-table td { padding: 0.5rem; text-align: left; border-bottom: 1px solid #252525; }
        .quote-items-table th { color: var(--gray); font-size: 0.7rem; }
        .quote-type-badge { padding: 0.125rem 0.5rem; border-radius: 4px; font-size: 0.7rem; }
        .quote-type-badge.dist { background: #064e3b; color: #34d399; }
        .quote-type-badge.integ { background: #1e3a5f; color: #60a5fa; }
        .quote-type-badge.service { background: #3f3f46; color: #a1a1aa; }
        .quote-type-badge.unclear { background: #451a03; color: #fbbf24; }
    </style>
    <!-- Document parsing libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
</head>
<body>
    <header class="header">
        <div class="logo">
            <div class="logo-icon">SA</div>
            <div class="logo-text"><span>SINGH</span> AUTO</div>
        </div>
        <nav class="nav">
            <button class="nav-btn active" data-page="scanner" data-testid="nav-scanner">üì° Scanner</button>
            <button class="nav-btn" data-page="purchasing" data-testid="nav-purchasing">üõí Purchasing</button>
            <button class="nav-btn" data-page="subcontracting" data-testid="nav-subcontracting">üéØ Subcontracting</button>
            <button class="nav-btn" data-page="pipeline" data-testid="nav-pipeline">üìä Pipeline</button>
            <button class="nav-btn" data-page="agent" data-testid="nav-agent">ü§ñ Agent_SAM</button>
            <button class="nav-btn" data-page="train" data-testid="nav-train">üß† Train Agent</button>
        </nav>
        <div style="display: flex; align-items: center; gap: 0.75rem;">
            <div id="modeIndicator" class="mode-indicator mode-ready" title="Production Mode">
                <span class="mode-dot"></span>
                <span class="mode-text">PRODUCTION</span>
            </div>
            <div class="status"><span class="status-dot" id="statusDot"></span><span id="statusText">Ready</span></div>
            <button class="btn btn-primary btn-sm" onclick="scanAll()" data-testid="btn-scan-live">üîÑ Scan Live Data</button>
        </div>
    </header>

    <div class="config-bar" id="configBar">
        <div id="authStatus" style="display: flex; align-items: center; gap: 0.5rem;">
            <span style="color: var(--red); font-size: 0.75rem;">‚ö†Ô∏è Backend authentication required</span>
            <button class="btn btn-sm btn-primary" onclick="checkBackendAuth()">üîå Check Connection</button>
        </div>
        <input type="hidden" id="apiUrl" value="https://singh-automation.vercel.app/api/sam">
    </div>

    <!-- SCANNER PAGE -->
    <div class="page active" id="page-scanner">
        <div class="stats-bar">
            <div class="stat" data-testid="stat-live"><div class="stat-value" id="statLive">0</div><div class="stat-label">Live</div></div>
            <div class="stat" data-testid="stat-total"><div class="stat-value" id="statTotal">0</div><div class="stat-label">Total</div></div>
            <div class="stat" data-testid="stat-qualified"><div class="stat-value" id="statQualified">0</div><div class="stat-label">Qualified</div></div>
            <div class="stat" data-testid="stat-urgent"><div class="stat-value" id="statUrgent">0</div><div class="stat-label">Urgent</div></div>
            <div class="stat" data-testid="stat-value"><div class="stat-value" id="statValue">$0</div><div class="stat-label">Value</div></div>
            <div class="stat" data-testid="stat-match"><div class="stat-value" id="statMatch">0%</div><div class="stat-label">Avg Match</div></div>
        </div>
        
        <div class="main">
            <div class="sidebar">
                <div class="panel">
                    <div class="panel-title">üèõÔ∏è Sources</div>
                    <div class="source-item"><span>SAM.gov</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>SBIR/STTR</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>Grants.gov</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>DIBBS</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>CA eProcure</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>MI SIGMA</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>TX SmartBuy</span><span class="badge badge-live">LIVE</span></div>
                    <div class="source-item"><span>Forecasts</span><span class="badge" style="background: #555;">BETA</span></div>
                </div>
                <div class="panel">
                    <div class="panel-title">üìß Email Alerts</div>
                    <input type="email" id="alertEmail" placeholder="your@email.com" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: var(--darker); border: 1px solid var(--border); border-radius: 4px; color: var(--light);">
                    <select id="alertFreq" style="width: 100%; padding: 0.5rem; margin-bottom: 0.5rem; background: var(--darker); border: 1px solid var(--border); border-radius: 4px; color: var(--light);">
                        <option value="daily">Daily Digest</option>
                        <option value="weekly">Weekly Summary</option>
                        <option value="instant">Instant (New Opps)</option>
                    </select>
                    <button class="btn btn-primary btn-sm" onclick="subscribeAlerts()" style="width: 100%;">üîî Subscribe</button>
                    <button class="btn btn-sm btn-secondary" onclick="testDigest()" style="width: 100%; margin-top: 0.5rem;">üì¨ Test Digest Now</button>
                    <div id="digestStatus" style="font-size: 0.7rem; color: var(--gray); margin-top: 0.5rem;"></div>
                </div>
                <div class="panel">
                    <div class="panel-title">üèÜ Certs</div>
                    <span class="cert-badge">FANUC ASI</span>
                    <span class="cert-badge">UR CSP</span>
                    <span class="cert-badge">MBE</span>
                    <span class="cert-badge">WBENC</span>
                </div>
            </div>
            
            <div class="content" style="display: flex; flex-direction: column; gap: 0.75rem;">
                <div class="tabs" id="tabsContainer"></div>
                <div class="filter-bar">
                    <input type="text" class="search-input" placeholder="üîç Search..." id="searchInput">
                    <button class="filter-pill active" data-filter="all">All</button>
                    <button class="filter-pill" data-filter="contract" data-testid="filter-federal">Federal</button>
                    <button class="filter-pill" data-filter="sbir" data-testid="filter-sbir">SBIR</button>
                    <button class="filter-pill" data-filter="grant" data-testid="filter-grants">Grants</button>
                    <button class="filter-pill" data-filter="state" data-testid="filter-state">State</button>
                    <button class="filter-pill" data-filter="dibbs">DIBBS</button>
                    <button class="filter-pill" data-filter="forecast">Forecast</button>
                </div>
                <div class="opp-list" id="oppList" data-testid="opp-list">
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <div style="font-size: 2rem; opacity: 0.4;">üì°</div>
                        <h3 style="margin: 0.5rem 0;">Ready to Scan</h3>
                        <p style="font-size: 0.8rem;">Click Scan to load opportunities</p>
                    </div>
                </div>
                <div class="log-panel" id="logPanel"></div>
            </div>
            
            <div class="right-panel">
                <div class="panel">
                    <div class="panel-title">‚ö° Quick Actions</div>
                    <div id="qualifiedList"></div>
                </div>
                <div class="panel">
                    <div class="panel-title">üìã Pipeline</div>
                    <div id="pipelineSummary">
                        <div style="font-size: 0.75rem; color: var(--gray);">
                            <div>üü¢ GO: <span id="pipelineGo">0</span></div>
                            <div>üü° Review: <span id="pipelineReview">0</span></div>
                            <div>üî¥ No-Go: <span id="pipelineNoGo">0</span></div>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-title">üéØ Revenue Target</div>
                    <div style="font-size: 0.7rem; margin-bottom: 0.5rem;">
                        <label style="color: var(--gray);">Annual Goal</label>
                        <input type="text" id="revenueGoal" value="500000" style="width: 100%; padding: 0.3rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.75rem;" onchange="updateRevenueCalculator()">
                    </div>
                    <div style="font-size: 0.7rem; margin-bottom: 0.5rem;">
                        <label style="color: var(--gray);">Win Rate (%)</label>
                        <input type="number" id="winRate" value="25" min="1" max="100" style="width: 100%; padding: 0.3rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.75rem;" onchange="updateRevenueCalculator()">
                    </div>
                    <div id="revenueCalcResult" style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                        <div style="font-size: 0.65rem; color: var(--gray);">Pipeline Needed:</div>
                        <div id="pipelineNeeded" style="font-size: 1rem; font-weight: 700; color: var(--green);">$2M</div>
                        <div style="font-size: 0.65rem; color: var(--gray); margin-top: 0.3rem;">Current GO Pipeline:</div>
                        <div id="currentPipeline" style="font-size: 0.9rem; font-weight: 600; color: #fff;">$0</div>
                        <div style="font-size: 0.65rem; margin-top: 0.3rem;" id="pipelineGapMsg">
                            <span style="color: var(--red);">Gap: $2M needed</span>
                        </div>
                    </div>
                </div>
                <div class="panel">
                    <div class="panel-title">üìà Win/Loss Record</div>
                    <div id="winLossStats" style="font-size: 0.7rem;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: var(--gray);">Submitted:</span>
                            <span id="outcomeSubmitted">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: var(--green);">Won:</span>
                            <span id="outcomeWon" style="color: var(--green);">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 0.3rem;">
                            <span style="color: var(--red);">Lost:</span>
                            <span id="outcomeLost" style="color: var(--red);">0</span>
                        </div>
                        <div style="display: flex; justify-content: space-between; padding-top: 0.3rem; border-top: 1px solid var(--border);">
                            <span style="color: var(--gray);">Actual Win Rate:</span>
                            <span id="actualWinRate" style="color: var(--green); font-weight: 600;">--</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-secondary" style="width: 100%; margin-top: 0.5rem;" onclick="openOutcomeModal()">
                        üìù Record Outcome
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- OUTCOME RECORDING MODAL -->
    <div id="outcomeModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 3000; align-items: center; justify-content: center;">
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; max-width: 400px; width: 90%;">
            <h3 style="margin: 0 0 1rem; color: var(--green);">üìù Record Bid Outcome</h3>
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--gray);">Opportunity</label>
                <select id="outcomeOppSelect" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.85rem;">
                    <option value="">-- Select GO opportunity --</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--gray);">Outcome</label>
                <select id="outcomeResult" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.85rem;">
                    <option value="">-- Select outcome --</option>
                    <option value="submitted">üì§ Submitted (awaiting result)</option>
                    <option value="won">üèÜ Won</option>
                    <option value="lost">‚ùå Lost</option>
                    <option value="no-bid">‚è≠Ô∏è No-Bid (decided not to pursue)</option>
                </select>
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--gray);">Contract Value (if won)</label>
                <input type="text" id="outcomeValue" placeholder="e.g., $250,000" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.85rem;">
            </div>
            <div style="margin-bottom: 1rem;">
                <label style="font-size: 0.75rem; color: var(--gray);">Lessons Learned (optional)</label>
                <textarea id="outcomeLessons" rows="3" placeholder="What worked? What could improve?" style="width: 100%; padding: 0.5rem; background: #1a1a1a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.85rem; resize: vertical;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeOutcomeModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveOutcome()">üíæ Save Outcome</button>
            </div>
        </div>
    </div>
    <div class="page" id="page-purchasing">
        <div class="stats-bar" style="grid-template-columns: repeat(5, 1fr);">
            <div class="stat"><div class="stat-value" id="purchTotal">0</div><div class="stat-label">Total Eligible</div></div>
            <div class="stat"><div class="stat-value" id="purchPLC">0</div><div class="stat-label">PLC/Controls</div></div>
            <div class="stat"><div class="stat-value" id="purchRobotics">0</div><div class="stat-label">Robotics</div></div>
            <div class="stat"><div class="stat-value" id="purchVision">0</div><div class="stat-label">Vision/Sensors</div></div>
            <div class="stat"><div class="stat-value" id="purchMotion">0</div><div class="stat-label">Motion/VFD</div></div>
        </div>
        
        <div class="main main-full" style="max-width: 1200px;">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div>
                        <div class="panel-title" style="margin-bottom: 0;">üõí Purchasing Eligibility</div>
                        <p style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">Opportunities with purchasable automation hardware or standard equipment</p>
                    </div>
                    <button class="btn btn-primary btn-sm" onclick="loadPurchasing()">üîÑ Analyze</button>
                </div>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem; flex-wrap: wrap;">
                    <button class="filter-pill active" data-purchfilter="all" onclick="filterPurchasing('all', this)">All Eligible</button>
                    <button class="filter-pill" data-purchfilter="PLC/Controls" onclick="filterPurchasing('PLC/Controls', this)">PLC/Controls</button>
                    <button class="filter-pill" data-purchfilter="Robotics" onclick="filterPurchasing('Robotics', this)">Robotics</button>
                    <button class="filter-pill" data-purchfilter="Vision/Sensors" onclick="filterPurchasing('Vision/Sensors', this)">Vision/Sensors</button>
                    <button class="filter-pill" data-purchfilter="Motion/VFD" onclick="filterPurchasing('Motion/VFD', this)">Motion/VFD</button>
                    <button class="filter-pill" data-purchfilter="Mixed" onclick="filterPurchasing('Mixed', this)">Mixed</button>
                </div>
                
                <div id="purchasingList" class="opp-list" style="max-height: calc(100vh - 350px);">
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <div style="font-size: 2rem; opacity: 0.4;">üõí</div>
                        <h3 style="margin: 0.5rem 0;">Ready to Analyze</h3>
                        <p style="font-size: 0.8rem;">Click Analyze to scan opportunities for purchasable equipment</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SUBCONTRACTING PAGE -->
    <div class="page" id="page-subcontracting">
        <div class="main main-full" style="max-width: 1200px;">
            <div class="panel">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <div class="panel-title" style="margin-bottom: 0;">üéØ Subcontracting Opportunities</div>
                    <div style="display: flex; gap: 0.5rem; align-items: center;">
                        <span id="subSource" style="font-size: 0.7rem; color: var(--orange);">üìä Demo</span>
                        <button class="btn btn-primary btn-sm" onclick="loadSubcontracting()">üîÑ Refresh</button>
                    </div>
                </div>
                <p style="font-size: 0.75rem; color: var(--gray); margin-bottom: 1rem;">Prime contractors with recent awards who may need robotics/automation subcontractors</p>
                
                <div style="display: flex; gap: 0.5rem; margin-bottom: 1rem;">
                    <button class="filter-pill active" data-subfilter="all" onclick="filterSubs('all', this)">All</button>
                    <button class="filter-pill" data-subfilter="hot" onclick="filterSubs('hot', this)">üî• Hot</button>
                    <button class="filter-pill" data-subfilter="warm" onclick="filterSubs('warm', this)">üå°Ô∏è Warm</button>
                </div>
                
                <div id="subList" class="opp-list" style="max-height: calc(100vh - 300px);">
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <p>Click Refresh to load subcontracting opportunities</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- PIPELINE PAGE -->
    <div class="page" id="page-pipeline">
        <div class="main main-full">
            <div class="panel">
                <div class="panel-title">üìä Application Pipeline</div>
                <div id="pipelineContent">
                    <div style="text-align: center; padding: 2rem; color: var(--gray);">
                        <p>Review opportunities in Scanner to build your pipeline</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI AGENT PAGE -->
    <div class="page" id="page-agent">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; padding: 0; max-width: 1800px; margin: 0 auto; height: calc(100vh - 180px);">
            
            <!-- LEFT: Chat Area -->
            <div class="panel" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div style="display: flex; align-items: center; gap: 0.75rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);">
                    <div style="width: 40px; height: 40px; background: linear-gradient(135deg, var(--green), #2E86AB); border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">ü§ñ</div>
                    <div>
                        <div style="font-weight: 700; font-size: 1rem;">Agent_SAM</div>
                        <div style="font-size: 0.7rem; color: var(--green);">Singh Automation BD Assistant</div>
                    </div>
                    <div style="margin-left: auto; display: flex; gap: 0.5rem; align-items: center;">
                        <!-- Opportunity Selector inline -->
                        <select id="agentContext" style="padding: 0.4rem 0.6rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 6px; color: #fff; font-size: 0.75rem; max-width: 200px;" onchange="updateAgentContext()">
                            <option value="">-- Select Opportunity --</option>
                        </select>
                        <span class="badge badge-live">ONLINE</span>
                    </div>
                </div>
                
                <!-- Pipeline Stats Row -->
                <div style="display: flex; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 1px solid var(--border);">
                    <div style="flex: 1; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center;">
                        <span style="font-weight: 700; color: var(--green);" id="agentGoCount">0</span>
                        <span style="font-size: 0.6rem; color: var(--gray);"> GO</span>
                    </div>
                    <div style="flex: 1; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center;">
                        <span style="font-weight: 700; color: var(--orange);" id="agentReviewCount">0</span>
                        <span style="font-size: 0.6rem; color: var(--gray);"> REVIEW</span>
                    </div>
                    <div style="flex: 1; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center;">
                        <span style="font-weight: 700; color: var(--blue);" id="agentTotalValue">$0</span>
                        <span style="font-size: 0.6rem; color: var(--gray);"> PIPELINE</span>
                    </div>
                    <div style="flex: 1; background: #0a0a0a; padding: 0.4rem; border-radius: 4px; text-align: center;">
                        <span style="font-weight: 700; color: var(--red);" id="agentUrgentCount">0</span>
                        <span style="font-size: 0.6rem; color: var(--gray);"> URGENT</span>
                    </div>
                </div>
                
                <!-- Chat Messages -->
                <div id="agentChat" style="flex: 1; overflow-y: auto; padding: 1rem 0; display: flex; flex-direction: column; gap: 1rem;">
                    <!-- Welcome Message -->
                    <div class="agent-message">
                        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                            <div style="width: 28px; height: 28px; background: linear-gradient(135deg, var(--green), #2E86AB); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0;">ü§ñ</div>
                            <div style="background: #1a1a1a; border-radius: 12px; border-top-left-radius: 4px; padding: 0.75rem 1rem; max-width: 90%;">
                                <div style="font-size: 0.85rem; line-height: 1.5;">
                                    <strong>Welcome! I'm Agent_SAM</strong>, your AI Business Development Assistant.<br><br>
                                    I can help you with:
                                    <ul style="margin: 0.5rem 0 0.5rem 1.2rem; padding: 0;">
                                        <li>üìä <strong>Analyze opportunities</strong> - GO/NO-GO recommendations</li>
                                        <li>üìù <strong>Proposal guidance</strong> - Win themes & compliance</li>
                                        <li>üéØ <strong>Strategy advice</strong> - Prioritization & teaming</li>
                                        <li>üìà <strong>Pipeline review</strong> - Status & next actions</li>
                                    </ul>
                                    Select an opportunity above, then ask me anything or generate a proposal ‚Üí
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div style="display: flex; gap: 0.4rem; padding: 0.5rem 0; border-top: 1px solid var(--border); flex-wrap: wrap;">
                    <button class="btn btn-sm btn-secondary" style="font-size: 0.7rem;" onclick="askAgent('What are my top 5 opportunities right now?')">üéØ Top Opps</button>
                    <button class="btn btn-sm btn-secondary" style="font-size: 0.7rem;" onclick="askAgent('What needs immediate attention?')">‚ö†Ô∏è Urgent</button>
                    <button class="btn btn-sm btn-secondary" style="font-size: 0.7rem;" onclick="askAgent('Give me a GO/NO-GO recommendation for the selected opportunity')">‚úÖ GO/NO-GO</button>
                    <button class="btn btn-sm btn-secondary" style="font-size: 0.7rem;" onclick="askAgent('What are the key risks?')">üî¥ Risks</button>
                    <button class="btn btn-sm btn-secondary" style="font-size: 0.7rem;" onclick="askAgent('What win themes should we emphasize?')">üí° Win Themes</button>
                    <button class="btn btn-sm" style="font-size: 0.7rem; background: #2E86AB; color: #fff;" onclick="askAgent('What subcontracting opportunities look best for Singh? Show the top 5 primes we should reach out to.')">ü§ù Best Subs</button>
                    <button class="btn btn-sm" style="font-size: 0.7rem; background: #2E86AB; color: #fff;" onclick="askAgent('Estimate equipment costs for the selected opportunity based on our price catalog')">üí∞ Cost Est</button>
                </div>
                
                <!-- Input Area -->
                <div style="border-top: 1px solid var(--border); padding-top: 0.75rem;">
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="agentInput" placeholder="Ask Agent_SAM anything..." 
                               style="flex: 1; padding: 0.75rem 1rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 8px; color: #fff; font-size: 0.85rem;"
                               onkeypress="if(event.key==='Enter')sendToAgent()"
                               data-testid="agent-input">
                        <button class="btn btn-primary" onclick="sendToAgent()" id="agentSendBtn" style="padding: 0.75rem 1.25rem;" data-testid="agent-send-btn">
                            Send ‚Üí
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- RIGHT: Proposal Panel -->
            <div class="panel" style="display: flex; flex-direction: column; height: 100%; overflow: hidden;">
                <div style="display: flex; align-items: center; gap: 0.5rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);">
                    <div style="font-weight: 700; font-size: 1rem;">üìù Proposal Generator</div>
                    <div style="margin-left: auto; display: flex; gap: 0.5rem;">
                        <button class="btn btn-primary btn-sm" onclick="generateProposalInAgent()" id="agentGenerateBtn">
                            üöÄ Generate
                        </button>
                        <button class="btn btn-sm" style="background: linear-gradient(135deg, #1B4F72, #2E86AB); color: #fff;" onclick="downloadProposalFromAgent()" id="agentDownloadBtn">
                            üìÑ .docx
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="copyProposal()">üìã</button>
                        <button class="btn btn-secondary btn-sm" onclick="downloadProposalTxt()">txt</button>
                    </div>
                </div>
                
                <!-- Selected Opportunity Info -->
                <div id="selectedOppInfo" style="font-size: 0.75rem; padding: 0.5rem; background: #0a0a0a; border-radius: 4px; margin: 0.5rem 0; color: var(--gray);">
                    Select an opportunity to generate a proposal
                </div>
                
                <!-- Proposal Preview -->
                <div id="agentProposalPreview" style="flex: 1; background: #fff; color: #000; border-radius: 6px; padding: 1rem; overflow-y: auto; font-family: 'Times New Roman', serif; font-size: 0.85rem;">
                    <div style="color: #888; text-align: center; padding: 3rem;">
                        <div style="font-size: 3rem; margin-bottom: 1rem;">üìù</div>
                        <div style="font-size: 1rem;">Select an opportunity and click<br><strong>üöÄ Generate</strong><br>to create a proposal</div>
                    </div>
                </div>
                
                <!-- Proposal Edit Input -->
                <div style="border-top: 1px solid var(--border); padding-top: 0.75rem; margin-top: 0.5rem;">
                    <div style="font-size: 0.7rem; color: var(--gray); margin-bottom: 0.5rem;">‚ú® Edit or improve the proposal:</div>
                    <div style="display: flex; gap: 0.5rem;">
                        <input type="text" id="proposalEditInput" placeholder="e.g., 'Make exec summary shorter' or 'Add more about FANUC partnership'" 
                               style="flex: 1; padding: 0.6rem 0.75rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 6px; color: #fff; font-size: 0.8rem;"
                               onkeypress="if(event.key==='Enter')editProposal()">
                        <button class="btn btn-sm" style="background: var(--purple); color: #fff;" onclick="editProposal()">
                            ‚ú® Edit
                        </button>
                    </div>
                    <div style="display: flex; gap: 0.3rem; margin-top: 0.5rem; flex-wrap: wrap;">
                        <button class="btn btn-sm btn-secondary" style="font-size: 0.65rem; padding: 0.25rem 0.5rem;" onclick="quickEditProposal('Make the executive summary more concise')">Shorter Summary</button>
                        <button class="btn btn-sm btn-secondary" style="font-size: 0.65rem; padding: 0.25rem 0.5rem;" onclick="quickEditProposal('Add more emphasis on our FANUC partnership')">+ FANUC</button>
                        <button class="btn btn-sm btn-secondary" style="font-size: 0.65rem; padding: 0.25rem 0.5rem;" onclick="quickEditProposal('Make the technical approach more detailed')">+ Technical</button>
                        <button class="btn btn-sm btn-secondary" style="font-size: 0.65rem; padding: 0.25rem 0.5rem;" onclick="quickEditProposal('Add cost savings benefits')">+ Cost Savings</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TRAIN AGENT PAGE -->
    <div class="page" id="page-train">
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; max-width: 1600px; margin: 0 auto;">
            
            <!-- LEFT COLUMN -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                
                <!-- Past Performance -->
                <div class="panel">
                    <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìã Past Performance Library</span>
                        <button class="btn btn-sm btn-primary" onclick="addPastPerformance()">+ Add Project</button>
                    </div>
                    <div id="pastPerformanceList" style="max-height: 300px; overflow-y: auto;">
                        <div style="color: var(--gray); text-align: center; padding: 1rem;">Loading...</div>
                    </div>
                </div>
                
                <!-- Win Themes -->
                <div class="panel">
                    <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üèÜ Win Themes Library</span>
                        <button class="btn btn-sm btn-primary" onclick="addWinTheme()">+ Add Theme</button>
                    </div>
                    <div id="winThemesList" style="max-height: 200px; overflow-y: auto;">
                        <div style="color: var(--gray); text-align: center; padding: 1rem;">Loading...</div>
                    </div>
                </div>
                
                <!-- Lessons Learned -->
                <div class="panel">
                    <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìö Lessons Learned</span>
                        <button class="btn btn-sm btn-primary" onclick="addLesson()">+ Add Lesson</button>
                    </div>
                    <div id="lessonsList" style="max-height: 200px; overflow-y: auto;">
                        <div style="color: var(--gray); text-align: center; padding: 1rem;">Loading...</div>
                    </div>
                </div>
                
            </div>
            
            <!-- RIGHT COLUMN -->
            <div style="display: flex; flex-direction: column; gap: 1rem;">
                
                <!-- Outcome Tracking -->
                <div class="panel">
                    <div class="panel-title">üìä Outcome Tracking</div>
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 0.5rem; margin-bottom: 1rem;">
                        <div style="background: #0a0a0a; padding: 0.75rem; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--green);" id="trainWonCount">0</div>
                            <div style="font-size: 0.7rem; color: var(--gray);">WON</div>
                        </div>
                        <div style="background: #0a0a0a; padding: 0.75rem; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--red);" id="trainLostCount">0</div>
                            <div style="font-size: 0.7rem; color: var(--gray);">LOST</div>
                        </div>
                        <div style="background: #0a0a0a; padding: 0.75rem; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--orange);" id="trainPendingCount">0</div>
                            <div style="font-size: 0.7rem; color: var(--gray);">PENDING</div>
                        </div>
                        <div style="background: #0a0a0a; padding: 0.75rem; border-radius: 6px; text-align: center;">
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--blue);" id="trainWinRate">0%</div>
                            <div style="font-size: 0.7rem; color: var(--gray);">WIN RATE</div>
                        </div>
                    </div>
                    <div id="outcomesList" style="max-height: 250px; overflow-y: auto;">
                        <div style="color: var(--gray); text-align: center; padding: 1rem;">
                            Mark opportunities as WON/LOST in the Pipeline to track outcomes
                        </div>
                    </div>
                </div>
                
                <!-- Document Upload -->
                <div class="panel">
                    <div class="panel-title">üìÑ Document Library</div>
                    <div id="documentDropZone" style="border: 2px dashed var(--border); border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: all 0.2s;" 
                         onclick="document.getElementById('documentUpload').click()"
                         ondragover="event.preventDefault(); this.style.borderColor='var(--green)'; this.style.background='rgba(154,205,50,0.1)';"
                         ondragleave="this.style.borderColor='var(--border)'; this.style.background='transparent';"
                         ondrop="handleDocumentDrop(event)">
                        <div style="font-size: 2rem; margin-bottom: 0.5rem;">üìé</div>
                        <div style="color: var(--gray);">Drop files here or click to upload</div>
                        <div style="font-size: 0.7rem; color: var(--gray); margin-top: 0.5rem;">PDF, Word, Text files ‚Ä¢ Max 5MB each</div>
                        <input type="file" id="documentUpload" style="display: none;" multiple accept=".pdf,.doc,.docx,.txt,.md" onchange="handleDocumentUpload(event)">
                    </div>
                    <div id="documentsList" style="margin-top: 1rem; max-height: 200px; overflow-y: auto;"></div>
                </div>
                
                <!-- Proposal Templates -->
                <div class="panel">
                    <div class="panel-title" style="display: flex; justify-content: space-between; align-items: center;">
                        <span>üìù Proposal Templates</span>
                        <button class="btn btn-sm btn-primary" onclick="addProposalTemplate()">+ Add Template</button>
                    </div>
                    <div style="font-size: 0.7rem; color: var(--gray); margin-bottom: 0.5rem;">
                        Agent_SAM uses these as reference when generating proposals
                    </div>
                    <div id="proposalTemplatesList" style="max-height: 150px; overflow-y: auto;"></div>
                </div>
                
                <!-- Agent Memory Status -->
                <div class="panel">
                    <div class="panel-title">üß† Agent Memory Status</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem;">
                        <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px;">
                            <span style="color: var(--gray); font-size: 0.7rem;">Past Performance:</span>
                            <span style="color: var(--green); font-weight: 600;" id="memoryPPCount">0</span>
                        </div>
                        <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px;">
                            <span style="color: var(--gray); font-size: 0.7rem;">Win Themes:</span>
                            <span style="color: var(--green); font-weight: 600;" id="memoryWTCount">0</span>
                        </div>
                        <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px;">
                            <span style="color: var(--gray); font-size: 0.7rem;">Documents:</span>
                            <span style="color: var(--green); font-weight: 600;" id="memoryDocCount">0</span>
                        </div>
                        <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px;">
                            <span style="color: var(--gray); font-size: 0.7rem;">Templates:</span>
                            <span style="color: var(--green); font-weight: 600;" id="memoryTemplateCount">0</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem; margin-top: 1rem;">
                        <button class="btn btn-sm btn-secondary" style="flex: 1;" onclick="exportAgentMemory()">üì§ Export Memory</button>
                        <button class="btn btn-sm btn-secondary" style="flex: 1;" onclick="document.getElementById('importMemory').click()">üì• Import Memory</button>
                        <input type="file" id="importMemory" style="display: none;" accept=".json" onchange="importAgentMemory(event)">
                        <button class="btn btn-sm" style="background: var(--red); color: #fff;" onclick="clearAgentMemory()">üóëÔ∏è Clear</button>
                    </div>
                </div>
                
            </div>
        </div>
    </div>

    <!-- DETAIL MODAL -->
    <div class="modal-overlay" id="detailModal" data-testid="modal-overlay">
        <div class="modal" data-testid="modal-container">
            <div class="modal-header">
                <h2 id="modalTitle" data-testid="modal-title">Opportunity Details</h2>
                <button class="modal-close" onclick="closeModal()" data-testid="modal-close">&times;</button>
            </div>
            <div class="modal-body" id="modalBody" data-testid="modal-body"></div>
            <div class="modal-footer" id="modalFooter" data-testid="modal-footer"></div>
        </div>
    </div>

    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
        <div id="loadingText" style="color: var(--gray);">Loading...</div>
        <div id="loadingActions" style="display: flex; gap: 0.5rem; margin-top: 1rem;">
            <button class="btn btn-secondary btn-sm" onclick="cancelScan()">‚úï Cancel</button>
            <button class="btn btn-sm" style="background: var(--card); color: var(--gray); border: 1px solid var(--border);" onclick="runInBackground()">Run in Background</button>
        </div>
        <div id="loadingProgress" style="color: var(--gray); font-size: 0.7rem; margin-top: 0.5rem;"></div>
    </div>

<script>
// ========== STATE ==========
const SINGH = { 
    naics: ['333249','333922','541330','541512','541715','238210'], 
    excluded: ['8(a)','hubzone','wosb','edwosb','sdvosb','vosb'],
    badIndustries: ['food','janitorial','medical','pharmaceutical','apparel','custodial','landscaping']
};
let opportunities = [];
let pipeline = {};
let outcomes = {};
// Initialize from storage safely
try {
    pipeline = JSON.parse(localStorage.getItem('pipeline') || '{}');
    outcomes = JSON.parse(localStorage.getItem('bidOutcomes') || '{}');
} catch (e) {
    console.warn('Could not load saved state:', e);
    pipeline = {};
    outcomes = {};
}
let currentTab = 'all';
let currentFilter = 'all';
let currentProposal = '';
let scanController = null; // AbortController for cancellable scans
let scanningInBackground = false;

// Price lookup table for common automation equipment
const PRICE_CATALOG = {
    'plc': [
        { name: 'Allen-Bradley CompactLogix 5380', partNum: '5069-L306ER', price: 2850, category: 'PLC' },
        { name: 'Siemens S7-1500', partNum: '6ES7 515-2AM02-0AB0', price: 3200, category: 'PLC' },
        { name: 'Allen-Bradley Micro850', partNum: '2080-LC50-48QWB', price: 890, category: 'PLC' }
    ],
    'hmi': [
        { name: 'Allen-Bradley PanelView Plus 7', partNum: '2711P-T10C22D9P', price: 4500, category: 'HMI' },
        { name: 'Siemens KTP700 Basic', partNum: '6AV2 123-2GB03-0AX0', price: 1200, category: 'HMI' }
    ],
    'robot': [
        { name: 'FANUC LR Mate 200iD/7L', partNum: 'A05B-1142-B201', price: 32000, category: 'Robot' },
        { name: 'FANUC M-20iD/25', partNum: 'A05B-1149-B201', price: 45000, category: 'Robot' },
        { name: 'Universal Robots UR10e', partNum: 'UR10e', price: 35000, category: 'Cobot' },
        { name: 'Universal Robots UR5e', partNum: 'UR5e', price: 27000, category: 'Cobot' }
    ],
    'vision': [
        { name: 'Cognex In-Sight 2000', partNum: 'IS2000M-110-40-125', price: 3800, category: 'Vision' },
        { name: 'Keyence IV3-500CA', partNum: 'IV3-500CA', price: 2900, category: 'Vision' },
        { name: 'FANUC iRVision 2D', partNum: 'A05B-1405-J901', price: 8500, category: 'Vision' }
    ],
    'vfd': [
        { name: 'Allen-Bradley PowerFlex 525', partNum: '25B-D010N104', price: 650, category: 'VFD' },
        { name: 'Siemens SINAMICS G120C', partNum: '6SL3210-1KE21-7UF1', price: 720, category: 'VFD' }
    ],
    'servo': [
        { name: 'Allen-Bradley Kinetix 5500', partNum: '2198-H040-ERS', price: 2400, category: 'Servo' },
        { name: 'FANUC Œ±i-F Servo', partNum: 'A06B-6290-H102', price: 3100, category: 'Servo' }
    ]
};

// ========== INIT ==========
// ========== PRODUCTION MODE ENFORCEMENT ==========
const APP_MODE = 'production';
const BACKEND_BASE = 'https://singh-automation.vercel.app';

document.addEventListener('DOMContentLoaded', () => {
    // Production mode enforcement
    if (APP_MODE !== 'production') {
        document.body.innerHTML = '<div style="padding: 2rem; color: red; font-size: 1.5rem;">FATAL: APP_MODE must be "production". Current: ' + APP_MODE + '</div>';
        throw new Error('APP_MODE must be production');
    }
    
    // Initialize
    updatePipelineStats();
    updateRevenueCalculator();
    updateWinLossStats();
    
    // Check backend connectivity
    checkBackendAuth();
    
    log('Production mode initialized', 'success');
});

// ========== HARD ERROR DISPLAY ==========
function showHardError(component, endpoint, status, message, requestId = null) {
    const timestamp = new Date().toISOString();
    const errorHtml = `
        <div class="hard-error">
            <div class="hard-error-title">üö´ HARD FAILURE: ${component}</div>
            <div class="hard-error-details">
                <div class="hard-error-field"><label>Endpoint:</label><span>${endpoint}</span></div>
                <div class="hard-error-field"><label>Status:</label><span>${status}</span></div>
                <div class="hard-error-field"><label>Error:</label><span>${message}</span></div>
                <div class="hard-error-field"><label>Timestamp:</label><span>${timestamp}</span></div>
                ${requestId ? `<div class="hard-error-field"><label>Request ID:</label><span>${requestId}</span></div>` : ''}
            </div>
        </div>
    `;
    return errorHtml;
}

function setModeIndicator(mode, text) {
    const indicator = document.getElementById('modeIndicator');
    if (!indicator) return;
    indicator.className = 'mode-indicator mode-' + mode;
    const modeText = indicator.querySelector('.mode-text');
    if (modeText) modeText.textContent = text;
}

async function checkBackendAuth() {
    const authStatus = document.getElementById('authStatus');
    if (!authStatus) return;

    try {
        const r = await fetch(BACKEND_BASE + '/api/health', {
            method: 'GET',
            signal: AbortSignal.timeout(10000)
        });

        if (r.ok) {
            const data = await r.json();
            authStatus.innerHTML = `
                <span style="color: var(--green); font-size: 0.75rem;">‚úÖ Backend connected</span>
                <span style="color: var(--gray); font-size: 0.65rem; margin-left: 0.5rem;">SAM: ${data.sam ? '‚úì' : '‚úó'} | Claude: ${data.claude ? '‚úì' : '‚úó'}</span>
            `;
            setModeIndicator('live', 'CONNECTED');
            log('Backend connected', 'success');
        } else {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
    } catch (e) {
        authStatus.innerHTML = `
            <span style="color: var(--red); font-size: 0.75rem;">‚ùå Backend unavailable: ${e.message}</span>
            <button class="btn btn-sm" style="margin-left: 0.5rem;" onclick="checkBackendAuth()">Retry</button>
        `;
        setModeIndicator('error', 'DISCONNECTED');
        log('Backend check failed: ' + e.message, 'error');
    }
}

function log(msg, type = 'info') {
    const p = document.getElementById('logPanel');
    if (!p) return;
    const e = document.createElement('div');
    e.className = 'log-entry ' + type;
    e.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
    p.appendChild(e);
    p.scrollTop = p.scrollHeight;
}

function showLoading(t, showActions = true) {
    const loadingText = document.getElementById('loadingText');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingActions = document.getElementById('loadingActions');
    const loadingProgress = document.getElementById('loadingProgress');
    if (loadingText) loadingText.textContent = t;
    if (loadingOverlay) loadingOverlay.classList.add('active');
    if (loadingActions) loadingActions.style.display = showActions ? 'flex' : 'none';
    if (loadingProgress) loadingProgress.textContent = '';
}
function hideLoading() {
    const loadingOverlay = document.getElementById('loadingOverlay');
    if (loadingOverlay) loadingOverlay.classList.remove('active');
    scanningInBackground = false;
}
function updateLoadingProgress(text) {
    const loadingProgress = document.getElementById('loadingProgress');
    if (loadingProgress) loadingProgress.textContent = text;
}
function cancelScan() {
    if (scanController) {
        scanController.abort();
        scanController = null;
    }
    if (proposalController) {
        proposalController.abort();
        proposalController = null;
    }
    hideLoading();
    // Reset status indicator
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    if (statusText) statusText.textContent = 'Ready';
    if (statusDot) statusDot.style.animation = '';
    log('Operation cancelled', 'info');
}
function runInBackground() {
    scanningInBackground = true;
    hideLoading();
    log('Scan running in background...', 'info');
    // Show subtle indicator in header
    const statusText = document.getElementById('statusText');
    const statusDot = document.getElementById('statusDot');
    if (statusText) statusText.textContent = 'Scanning...';
    if (statusDot) statusDot.style.animation = 'pulse 1s infinite';
}

// ========== API ==========
async function scanAll() {
    const url = BACKEND_BASE + '/api/sam';
    const MAX_RETRIES = 3;
    const TIMEOUT_MS = 30000;
    
    // Cancel any existing scan
    if (scanController) {
        scanController.abort();
    }
    scanController = new AbortController();
    
    showLoading('Scanning live opportunities...', true);
    log('Connecting to SAM.gov feed: ' + url, 'info');
    setModeIndicator('ready', 'SCANNING...');
    
    let lastError = null;
    let requestId = crypto.randomUUID();
    
    for (let attempt = 1; attempt <= MAX_RETRIES; attempt++) {
        try {
            updateLoadingProgress(`Attempt ${attempt}/${MAX_RETRIES}...`);
            
            const timeoutSignal = AbortSignal.timeout(TIMEOUT_MS);
            const r = await fetch(url, { 
                signal: AbortSignal.any([scanController.signal, timeoutSignal]),
                headers: {
                    'X-Request-ID': requestId,
                    'X-Client-Version': 'production-1.0'
                }
            });
            
            if (!r.ok) {
                throw new Error(`HTTP ${r.status}: ${r.statusText}`);
            }
            
            updateLoadingProgress('Validating response schema...');
            const d = await r.json();
            
            // Schema validation
            if (!d.success) {
                throw new Error(d.error || 'API returned success=false');
            }
            if (!Array.isArray(d.opportunities)) {
                throw new Error('Invalid schema: opportunities must be an array');
            }
            
            // Validate required fields on each opportunity
            const validationErrors = validateOpportunitySchema(d.opportunities);
            if (validationErrors.length > 0) {
                log(`Schema warnings: ${validationErrors.length} issues`, 'info');
                console.warn('Opportunity validation issues:', validationErrors);
            }
            
            processOpportunities(d.opportunities, 'Live');
            setModeIndicator('live', 'LIVE DATA');
            hideLoading();
            return; // Success - exit function
            
        } catch (e) {
            lastError = e;
            log(`Attempt ${attempt} failed: ${e.message}`, 'error');
            
            if (e.name === 'AbortError' && scanController.signal.aborted) {
                // User cancelled
                break;
            }
            
            // Exponential backoff before retry
            if (attempt < MAX_RETRIES) {
                const backoffMs = Math.pow(2, attempt) * 1000;
                updateLoadingProgress(`Retry in ${backoffMs/1000}s...`);
                await new Promise(r => setTimeout(r, backoffMs));
            }
        }
    }
    
    // All retries exhausted - HARD FAIL (no demo fallback)
    hideLoading();
    setModeIndicator('error', 'API FAILED');
    
    const errorHtml = showHardError(
        'SAM.gov Opportunity Scanner',
        url,
        lastError?.message || 'Unknown error',
        `Failed after ${MAX_RETRIES} attempts. Check backend connectivity.`,
        requestId
    );
    
    document.getElementById('oppList').innerHTML = errorHtml;
    log(`HARD FAILURE: Scanner failed after ${MAX_RETRIES} retries`, 'error');
}

// Schema validation for opportunity data
function validateOpportunitySchema(opps) {
    const required = ['id', 'title', 'agency'];
    const recommended = ['value', 'closeDate', 'naicsCode', 'setAside', 'solicitation'];
    const errors = [];
    
    opps.forEach((opp, idx) => {
        required.forEach(field => {
            if (!opp[field]) {
                errors.push({ index: idx, field, severity: 'ERROR', message: `Missing required field: ${field}` });
            }
        });
        recommended.forEach(field => {
            if (!opp[field]) {
                errors.push({ index: idx, field, severity: 'WARN', message: `Missing recommended field: ${field}` });
            }
        });
        // Validate date format
        if (opp.closeDate && isNaN(new Date(opp.closeDate).getTime())) {
            errors.push({ index: idx, field: 'closeDate', severity: 'ERROR', message: 'Invalid date format' });
        }
        // Validate value is numeric
        if (opp.value && typeof opp.value !== 'number') {
            errors.push({ index: idx, field: 'value', severity: 'WARN', message: 'Value should be numeric' });
        }
    });
    
    return errors;
}

function processOpportunities(rawOpps, source) {
    updateLoadingProgress(`Processing ${rawOpps.length} opportunities...`);
    
    // PRODUCTION: Reject any demo data that somehow got through
    const demoOpps = rawOpps.filter(o => o.id?.startsWith('DEMO-'));
    if (demoOpps.length > 0) {
        throw new Error(`FATAL: ${demoOpps.length} demo opportunities detected in production. IDs: ${demoOpps.map(o => o.id).join(', ')}`);
    }
    
    opportunities = rawOpps.map(o => {
        const match = calcMatch(o);
        return {
            ...o,
            matchScore: match.score,
            matchBreakdown: match.breakdown,
            eligibility: checkElig(o),
            link: getSamLink(o)
        };
    });
    opportunities.sort((a, b) => b.matchScore - a.matchScore);
    
    // Track for recompete detection
    trackSeenOpportunities(rawOpps);
    
    // Update status indicators
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    if (statusDot) {
        statusDot.className = 'status-dot live';
        statusDot.style.animation = '';
    }
    if (statusText) statusText.textContent = source;
    
    // PRODUCTION: Always live mode
    setModeIndicator('live', 'LIVE DATA');
    
    log(`Loaded ${opportunities.length} opportunities (${source})`, 'success');
    
    renderTabs();
    renderOpps();
    updateStats();
    renderQualifiedList();
    updateOppSelect();
    updateRevenueCalculator();
    initAgent();
}

// PRODUCTION: Demo data removed - all data must come from live sources
function loadDemoData() {
    throw new Error('FATAL: loadDemoData called in production mode. Demo functions are disabled.');
}

// Generate proper source link from opportunity data
function getSamLink(o) {
    // If we have a proper uiLink from API, use it
    if (o.uiLink && o.uiLink.startsWith('http')) {
        return o.uiLink;
    }
    // If link exists and is a valid URL, use it (covers state portals, DIBBS, etc.)
    if (o.link && o.link.startsWith('http')) {
        return o.link;
    }
    // For SAM.gov opportunities, construct from noticeId if it's a real SAM ID (32+ chars)
    if (o.noticeId && o.noticeId.length >= 32) {
        return `https://sam.gov/opp/${o.noticeId}/view`;
    }
    // For SAM.gov opportunities, construct from id if it's a real SAM ID (32+ chars)
    if (o.id && o.id.length >= 32) {
        return `https://sam.gov/opp/${o.id}/view`;
    }
    // Fallback to generic search based on source
    const searchTerm = encodeURIComponent(o.solicitation || o.title || '');
    if (o.source === 'SBIR.gov') {
        return `https://www.sbir.gov/topics`;
    }
    return `https://sam.gov/search/?keywords=${searchTerm}&index=opp`;
}

/**
 * CANONICAL ELIGIBILITY - Single Source of Truth
 * All UI, pipeline, purchasing, and proposal logic MUST reference ONLY this object.
 * Priority: Hard rules > API qualification > Local analysis
 */
function computeCanonicalEligibility(o) {
    const sa = (o.setAside || '').toLowerCase();
    const txt = ((o.title || '') + ' ' + (o.description || '')).toLowerCase();
    
    // ==========================================
    // HARD NO-GO RULES (Cannot be overridden)
    // ==========================================
    
    // Set-aside restrictions Singh cannot meet
    if (sa.includes('sdvosb') || sa.includes('service-disabled veteran')) {
        return { 
            ok: false, 
            status: 'NO-GO', 
            reason: 'Restricted to SDVOSB primes; Singh is not SDVOSB certified.',
            source: 'set-aside-restriction',
            canPursue: false,
            canQuote: false
        };
    }
    if (sa.includes('8(a)') || sa.includes('8a')) {
        return { 
            ok: false, 
            status: 'NO-GO', 
            reason: 'Restricted to 8(a) firms; Singh is not 8(a) certified.',
            source: 'set-aside-restriction',
            canPursue: false,
            canQuote: false
        };
    }
    if (sa.includes('hubzone')) {
        return { 
            ok: false, 
            status: 'NO-GO', 
            reason: 'Restricted to HUBZone firms; Singh is not HUBZone certified.',
            source: 'set-aside-restriction',
            canPursue: false,
            canQuote: false
        };
    }
    if (sa.includes('wosb') || sa.includes('women-owned')) {
        return { 
            ok: false, 
            status: 'NO-GO', 
            reason: 'Restricted to WOSB/EDWOSB firms.',
            source: 'set-aside-restriction',
            canPursue: false,
            canQuote: false
        };
    }
    if (sa.includes('vosb') && !sa.includes('sdvosb')) {
        return { 
            ok: false, 
            status: 'NO-GO', 
            reason: 'Restricted to VOSB firms.',
            source: 'set-aside-restriction',
            canPursue: false,
            canQuote: false
        };
    }
    
    // Contract vehicle lockouts
    const vehicles = ['seaport nxg', 'seaport-e', 'oasis', 'gsa mas', 'gsa schedule', 'sewp', 'cio-sp3', 'stars iii', 'alliant', 'ites-sw2', 'cio-cs'];
    for (const v of vehicles) {
        if (txt.includes(v) && (txt.includes('holders only') || txt.includes('contract holders') || txt.includes('task order under') || txt.includes('bpa call'))) {
            return { 
                ok: false, 
                status: 'NO-GO', 
                reason: `Restricted to ${v.toUpperCase()} contract holders; Singh is not a holder.`,
                source: 'vehicle-restriction',
                canPursue: false,
                canQuote: false
            };
        }
    }
    
    // ==========================================
    // REVIEW CONDITIONS (Needs human decision)
    // ==========================================
    
    // Unregistered NAICS
    const naics = o.naicsCode || '';
    if (naics && naics.length >= 6 && !SINGH.naics.some(x => naics.startsWith(x.substring(0, 4)))) {
        return { 
            ok: false, 
            status: 'REVIEW', 
            reason: `NAICS ${naics} not in Singh registrations. Verify if applicable.`,
            source: 'naics-mismatch',
            canPursue: false, // Must be manually approved
            canQuote: false
        };
    }
    
    // Bad industry signals (unless automation context)
    for (const industry of SINGH.badIndustries) {
        if (txt.includes(industry) && !txt.includes('robot') && !txt.includes('automation') && !txt.includes('plc')) {
            return { 
                ok: false, 
                status: 'REVIEW', 
                reason: `Industry "${industry}" detected. Review if automation scope exists.`,
                source: 'industry-mismatch',
                canPursue: false,
                canQuote: false
            };
        }
    }
    
    // Services-only indicators
    const servicesOnly = ['professional services', 'consulting only', 'advisory services', 'staffing', 'labor hours only', 'study and analysis'];
    for (const svc of servicesOnly) {
        if (txt.includes(svc) && !txt.includes('equipment') && !txt.includes('hardware') && !txt.includes('install')) {
            return { 
                ok: false, 
                status: 'REVIEW', 
                reason: `Appears to be services-only ("${svc}"). Verify hardware component exists.`,
                source: 'services-only',
                canPursue: false,
                canQuote: false
            };
        }
    }
    
    // ==========================================
    // GO CONDITIONS (Eligible to pursue)
    // ==========================================
    
    // Small business set-aside (Singh qualifies)
    if (sa.includes('small business') && !sa.includes('8(a)') && !sa.includes('hubzone') && !sa.includes('sdvosb') && !sa.includes('wosb')) {
        return { 
            ok: true, 
            status: 'GO', 
            reason: 'Small Business set-aside; Singh is SB certified.',
            source: 'sb-setaside',
            canPursue: true,
            canQuote: true
        };
    }
    
    // Full and open competition
    if (sa === '' || sa.includes('full and open') || sa.includes('unrestricted')) {
        return { 
            ok: true, 
            status: 'GO', 
            reason: 'Full & Open competition; no restrictions.',
            source: 'full-open',
            canPursue: true,
            canQuote: true
        };
    }
    
    // ==========================================
    // UNCERTAIN - Default to REVIEW (conservative)
    // ==========================================
    return { 
        ok: false, 
        status: 'REVIEW', 
        reason: 'Eligibility unclear. Manual review required before pursuit.',
        source: 'uncertain',
        canPursue: false,
        canQuote: false
    };
}

// Legacy function name for compatibility - now calls canonical
function checkElig(o) {
    return computeCanonicalEligibility(o);
}

function calcMatch(o) {
    let s = 30; // Lower base to make room for more signals
    const breakdown = [{ label: 'Base', points: 30 }];
    const t = ((o.title || '') + ' ' + (o.description || '')).toLowerCase();
    
    // === KEYWORD SIGNALS ===
    if (t.includes('robot')) { s += 15; breakdown.push({ label: 'Robot keyword', points: 15 }); }
    if (t.includes('vision') || t.includes('inspection')) { s += 12; breakdown.push({ label: 'Vision/Inspection', points: 12 }); }
    if (t.includes('automation')) { s += 10; breakdown.push({ label: 'Automation keyword', points: 10 }); }
    if (t.includes('plc') || t.includes('scada')) { s += 10; breakdown.push({ label: 'PLC/SCADA', points: 10 }); }
    if (t.includes('welding')) { s += 10; breakdown.push({ label: 'Welding', points: 10 }); }
    if (t.includes('conveyor') || t.includes('material handling')) { s += 8; breakdown.push({ label: 'Conveyor/MH', points: 8 }); }
    if (t.includes('fanuc')) { s += 15; breakdown.push({ label: 'FANUC match', points: 15 }); }
    if (t.includes('universal robot') || t.includes('ur10') || t.includes('ur5') || t.includes('cobot')) { s += 12; breakdown.push({ label: 'UR/Cobot', points: 12 }); }
    if (t.includes('integrat')) { s += 8; breakdown.push({ label: 'Integration scope', points: 8 }); }
    
    // === NAICS ALIGNMENT ===
    if (o.naicsCode && SINGH.naics.includes(o.naicsCode)) { 
        s += 12; breakdown.push({ label: 'NAICS match', points: 12 }); 
    }
    
    // === CONTRACT VALUE SIGNALS ===
    const value = parseFloat(o.value) || 0;
    if (value >= 5000000) { s += 10; breakdown.push({ label: 'Value ‚â•$5M', points: 10 }); }
    else if (value >= 1000000) { s += 8; breakdown.push({ label: 'Value ‚â•$1M', points: 8 }); }
    else if (value >= 250000) { s += 5; breakdown.push({ label: 'Value ‚â•$250K', points: 5 }); }
    else if (value > 0 && value < 50000) { s -= 5; breakdown.push({ label: 'Low value (<$50K)', points: -5 }); }
    
    // === TIME-TO-BID SIGNALS ===
    const days = daysUntil(o.closeDate);
    if (days <= 5 && days > 0) { s -= 10; breakdown.push({ label: 'Very short deadline (‚â§5d)', points: -10 }); }
    else if (days <= 10 && days > 0) { s -= 5; breakdown.push({ label: 'Short deadline (‚â§10d)', points: -5 }); }
    else if (days >= 30 && days <= 60) { s += 5; breakdown.push({ label: 'Good lead time (30-60d)', points: 5 }); }
    
    // === SET-ASIDE ALIGNMENT ===
    const setAside = (o.setAside || '').toLowerCase();
    if (setAside.includes('small business') && !setAside.includes('8(a)') && !setAside.includes('hubzone') && !setAside.includes('sdvosb')) {
        s += 8; breakdown.push({ label: 'SB set-aside (eligible)', points: 8 });
    }
    if (setAside.includes('full and open') || setAside === '') {
        s += 3; breakdown.push({ label: 'Full & Open', points: 3 });
    }
    
    // === RECOMPETE DETECTION ===
    try {
        const seenOpps = JSON.parse(localStorage.getItem('seenOpportunities') || '{}');
        if (seenOpps[o.id || o.noticeId]) {
            const firstSeen = new Date(seenOpps[o.id || o.noticeId]);
            const daysSeen = Math.floor((new Date() - firstSeen) / 86400000);
            if (daysSeen > 7) {
                breakdown.push({ label: 'üîÑ Recompete detected', points: 0, info: true });
            }
        }
    } catch (e) { /* localStorage unavailable */ }
    
    return { score: Math.max(0, Math.min(s, 99)), breakdown };
}

// Track seen opportunities for recompete detection
function trackSeenOpportunities(opps) {
    try {
        const seen = JSON.parse(localStorage.getItem('seenOpportunities') || '{}');
        const now = new Date().toISOString();
        opps.forEach(o => {
            const id = o.id || o.noticeId;
            if (id && !seen[id]) {
                seen[id] = now;
            }
        });
        // Prune old entries (> 90 days)
        const cutoff = Date.now() - (90 * 24 * 60 * 60 * 1000);
        Object.keys(seen).forEach(k => {
            if (new Date(seen[k]).getTime() < cutoff) delete seen[k];
        });
        safeStorage('seenOpportunities', seen);
    } catch (e) {
        console.warn('Could not track opportunities:', e);
    }
}

function fmtCurrency(v) {
    if (!v) return 'TBD';
    const n = parseFloat(v);
    if (isNaN(n)) return 'TBD';
    return n >= 1e6 ? '$' + (n/1e6).toFixed(1) + 'M' : n >= 1e3 ? '$' + (n/1e3).toFixed(0) + 'K' : '$' + n.toLocaleString();
}

function fmtDate(d) { if (!d) return 'N/A'; try { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); } catch { return 'N/A'; } }
function daysUntil(d) { if (!d) return 999; try { return Math.ceil((new Date(d) - new Date()) / 86400000); } catch { return 999; } }

// ========== RENDERING ==========
function renderTabs() {
    const c = { all: opportunities.length, contract: 0, sbir: 0, grant: 0, state: 0, dibbs: 0, forecast: 0, qualified: 0 };
    opportunities.forEach(o => {
        if (o.type === 'contract') c.contract++;
        if (o.type === 'sbir') c.sbir++;
        if (o.type === 'grant') c.grant++;
        if (o.type === 'state') c.state++;
        if (o.type === 'dibbs') c.dibbs++;
        if (o.type === 'forecast') c.forecast++;
        if (o.eligibility.ok) c.qualified++;
    });
    
    // Only show tabs with items (always show All and Qualified)
    let tabs = `<button class="tab ${currentTab==='all'?'active':''}" data-tab="all">All ${c.all}</button>`;
    if (c.contract > 0) tabs += `<button class="tab ${currentTab==='contract'?'active':''}" data-tab="contract">Federal ${c.contract}</button>`;
    if (c.sbir > 0) tabs += `<button class="tab ${currentTab==='sbir'?'active':''}" data-tab="sbir">SBIR ${c.sbir}</button>`;
    if (c.grant > 0) tabs += `<button class="tab ${currentTab==='grant'?'active':''}" data-tab="grant">Grants ${c.grant}</button>`;
    if (c.state > 0) tabs += `<button class="tab ${currentTab==='state'?'active':''}" data-tab="state">State ${c.state}</button>`;
    if (c.dibbs > 0) tabs += `<button class="tab ${currentTab==='dibbs'?'active':''}" data-tab="dibbs">DIBBS ${c.dibbs}</button>`;
    if (c.forecast > 0) tabs += `<button class="tab ${currentTab==='forecast'?'active':''}" data-tab="forecast">Forecast ${c.forecast}</button>`;
    tabs += `<button class="tab ${currentTab==='qualified'?'active':''}" data-tab="qualified">‚úÖ Qualified ${c.qualified}</button>`;
    
    const tabsContainer = document.getElementById('tabsContainer');
    if (tabsContainer) tabsContainer.innerHTML = tabs;
}

function renderOpps() {
    const c = document.getElementById('oppList');
    if (!c) return;
    const searchInput = document.getElementById('searchInput');
    const s = (searchInput?.value || '').toLowerCase();
    
    let f = opportunities.filter(o => {
        // Tab filtering
        if (currentTab === 'qualified' && !o.eligibility.ok) return false;
        if (currentTab === 'contract' && o.type !== 'contract') return false;
        if (currentTab === 'sbir' && o.type !== 'sbir') return false;
        if (currentTab === 'grant' && o.type !== 'grant') return false;
        if (currentTab === 'state' && o.type !== 'state') return false;
        if (currentTab === 'dibbs' && o.type !== 'dibbs') return false;
        if (currentTab === 'forecast' && o.type !== 'forecast') return false;
        
        // Category filter (from filter pills)
        if (currentFilter !== 'all') {
            if (currentFilter === 'contract' && o.type !== 'contract') return false;
            if (currentFilter === 'sbir' && o.type !== 'sbir') return false;
            if (currentFilter === 'grant' && o.type !== 'grant') return false;
            if (currentFilter === 'state' && o.type !== 'state') return false;
            if (currentFilter === 'dibbs' && o.type !== 'dibbs') return false;
            if (currentFilter === 'forecast' && o.type !== 'forecast') return false;
        }
        
        // Search filter
        if (s && !((o.title||'')+' '+(o.description||'')+' '+(o.agency||'')).toLowerCase().includes(s)) return false;
        return true;
    });
    
    if (!f.length) {
        c.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><h3>No matches</h3></div>';
        return;
    }
    
    c.innerHTML = f.map(o => {
        const d = daysUntil(o.closeDate);
        const sc = o.matchScore >= 70 ? '' : o.matchScore >= 50 ? 'medium' : 'low';
        const status = pipeline[o.id]?.status || null;
        const typeBadge = getTypeBadgeColor(o.type);
        
        // CANONICAL: Use ONLY o.eligibility (single source of truth)
        const eligStatus = o.eligibility.status; // GO, REVIEW, or NO-GO
        
        // Determine card border based on canonical eligibility
        let cardClass = 'opp-card';
        if (eligStatus === 'GO') cardClass += ' qualified';
        else if (eligStatus === 'NO-GO') cardClass += ' not-qualified';
        else cardClass += ' review';
        
        return `<div class="${cardClass}" data-id="${o.id}" data-testid="opp-card">
            <div class="opp-header">
                <div class="opp-title" data-testid="opp-title">${o.title}</div>
                <span class="opp-type" style="background: ${typeBadge.bg}; color: ${typeBadge.color}" data-testid="opp-type">${(o.category || o.type || 'contract').toUpperCase()}</span>
            </div>
            <div class="opp-meta" data-testid="opp-meta">
                <span data-testid="opp-agency">üèõÔ∏è ${(o.agency||'Agency').substring(0,40)}</span>
                <span data-testid="opp-value">üí∞ ${fmtCurrency(o.value)}</span>
                <span data-testid="opp-close-date">üìÖ ${fmtDate(o.closeDate)} ${d > 0 && d < 14 ? '‚ö†Ô∏è' : ''}</span>
                ${o.source ? `<span style="color: var(--gray); font-size: 0.7rem;" data-testid="opp-source">via ${o.source}</span>` : ''}
            </div>
            <div class="opp-desc">${(o.description||'').substring(0,120)}...</div>
            <div class="opp-tags">
                ${o.isLive ? '<span class="tag">üü¢ LIVE</span>' : ''}
                ${eligStatus === 'GO' ? '<span class="tag" style="background: rgba(154,205,50,0.2);">‚úÖ GO</span>' : ''}
                ${eligStatus === 'REVIEW' ? '<span class="tag" style="background: rgba(245,158,11,0.2); color: var(--orange);">üîç REVIEW</span>' : ''}
                ${eligStatus === 'NO-GO' ? '<span class="tag tag-nq">üö´ NO-GO</span>' : ''}
                ${status === 'go' ? '<span class="tag" style="background: rgba(154,205,50,0.3);">üìå MARKED GO</span>' : ''}
                ${status === 'review' ? '<span class="tag" style="background: rgba(245,158,11,0.3); color: var(--orange);">üìå MARKED REVIEW</span>' : ''}
                ${status === 'nogo' ? '<span class="tag" style="background: rgba(239,68,68,0.3); color: var(--red);">üìå MARKED NO-GO</span>' : ''}
            </div>
            <div class="match-score ${sc} score-badge">
                ${o.matchScore}%
                <div class="score-tooltip">
                    <div class="score-tooltip-title">üìä Score Breakdown</div>
                    ${(o.matchBreakdown || []).map(b => b.info 
                        ? `<div class="score-tooltip-row" style="color: var(--blue);"><span>${b.label}</span><span>‚ÑπÔ∏è</span></div>`
                        : `<div class="score-tooltip-row">
                            <span>${b.label}</span>
                            <span style="color: ${b.points >= 0 ? 'var(--green)' : 'var(--red)'};">${b.points >= 0 ? '+' : ''}${b.points}</span>
                          </div>`
                    ).join('')}
                    <div class="score-tooltip-row" style="border-top: 1px solid var(--border); margin-top: 0.3rem; padding-top: 0.3rem;">
                        <span>Total</span>
                        <span>${o.matchScore}%</span>
                    </div>
                </div>
            </div>
        </div>`;
    }).join('');
}

function renderQualifiedList() {
    const list = document.getElementById('qualifiedList');
    if (!list) return;
    const qual = opportunities.filter(o => o.eligibility?.ok).slice(0, 5);

    if (!qual.length) {
        list.innerHTML = '<div style="font-size: 0.75rem; color: var(--gray);">No qualified opportunities</div>';
        return;
    }
    
    list.innerHTML = qual.map(o => {
        const status = pipeline[o.id]?.status;
        return `<div class="alert-item" onclick="showDetail('${o.id}')">
            <span class="alert-dot ${status === 'go' ? 'green' : status === 'review' ? 'orange' : 'green'}"></span>
            <span style="flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${o.title.substring(0,30)}...</span>
            <span style="color: var(--green); font-weight: 600;">${o.matchScore}%</span>
        </div>`;
    }).join('');
}

function updateStats() {
    const q = opportunities.filter(o => o.eligibility?.ok);
    const u = opportunities.filter(o => { const d = daysUntil(o.closeDate); return d <= 14 && d > 0; });
    const tv = opportunities.reduce((s, o) => s + (parseFloat(o.value) || 0), 0);
    const am = opportunities.length ? Math.round(opportunities.reduce((s, o) => s + (o.matchScore || 0), 0) / opportunities.length) : 0;

    const els = {
        statLive: document.getElementById('statLive'),
        statTotal: document.getElementById('statTotal'),
        statQualified: document.getElementById('statQualified'),
        statUrgent: document.getElementById('statUrgent'),
        statValue: document.getElementById('statValue'),
        statMatch: document.getElementById('statMatch')
    };
    if (els.statLive) els.statLive.textContent = opportunities.filter(o => o.isLive).length;
    if (els.statTotal) els.statTotal.textContent = opportunities.length;
    if (els.statQualified) els.statQualified.textContent = q.length;
    if (els.statUrgent) els.statUrgent.textContent = u.length;
    if (els.statValue) els.statValue.textContent = fmtCurrency(tv);
    if (els.statMatch) els.statMatch.textContent = am + '%';
}

function updateOppSelect() {
    const sel = document.getElementById('oppSelect');
    if (!sel) return; // Element may not exist in new Agent_SAM UI
    
    // Only show opportunities marked as GO in pipeline
    const goOpps = opportunities.filter(o => pipeline[o.id]?.status === 'go');
    
    if (goOpps.length > 0) {
        sel.innerHTML = `<option value="">-- ${goOpps.length} GO opportunities --</option>` +
            goOpps.map(o => `<option value="${o.id}">${o.title.substring(0,50)}... | ${fmtCurrency(o.value)}</option>`).join('');
    } else {
        // Fallback to qualified if no GO marked yet
        const qual = opportunities.filter(o => o.eligibility.ok);
        sel.innerHTML = `<option value="">-- ${qual.length} qualified (mark GO to proceed) --</option>` +
            qual.map(o => `<option value="${o.id}">${o.title.substring(0,50)}... | ${fmtCurrency(o.value)}</option>`).join('');
    }
}

function updatePipelineStats() {
    const goCount = Object.values(pipeline).filter(p => p.status === 'go').length;
    const reviewCount = Object.values(pipeline).filter(p => p.status === 'review').length;
    const nogoCount = Object.values(pipeline).filter(p => p.status === 'nogo').length;

    const pipelineGo = document.getElementById('pipelineGo');
    const pipelineReview = document.getElementById('pipelineReview');
    const pipelineNoGo = document.getElementById('pipelineNoGo');
    if (pipelineGo) pipelineGo.textContent = goCount;
    if (pipelineReview) pipelineReview.textContent = reviewCount;
    if (pipelineNoGo) pipelineNoGo.textContent = nogoCount;

    // Update revenue calculator when pipeline changes
    updateRevenueCalculator();
}

function renderPipelinePage() {
    const container = document.getElementById('pipelineContent');
    if (!container) return;
    const pipelineEntries = Object.entries(pipeline);

    if (pipelineEntries.length === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 2rem; color: var(--gray);">
                <p>Review opportunities in Scanner to build your pipeline</p>
            </div>`;
        return;
    }
    
    // Group by status
    const goItems = pipelineEntries.filter(([id, p]) => p.status === 'go');
    const reviewItems = pipelineEntries.filter(([id, p]) => p.status === 'review');
    const nogoItems = pipelineEntries.filter(([id, p]) => p.status === 'nogo');
    
    const renderGroup = (items, label, color, icon) => {
        if (items.length === 0) return '';
        
        const totalValue = items.reduce((sum, [id, p]) => {
            const opp = opportunities.find(o => o.id === id);
            return sum + (parseFloat(opp?.value || p.value) || 0);
        }, 0);
        
        return `
            <div style="margin-bottom: 1.5rem;">
                <h3 style="color: ${color}; margin: 0 0 0.75rem; font-size: 0.9rem; display: flex; justify-content: space-between; align-items: center;">
                    <span>${icon} ${label} (${items.length})</span>
                    <span style="font-size: 0.8rem;">${fmtCurrency(totalValue)}</span>
                </h3>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    ${items.map(([id, p]) => {
                        const opp = opportunities.find(o => o.id === id);
                        const title = opp?.title || p.title || 'Unknown Opportunity';
                        const value = opp?.value || p.value || 0;
                        const agency = opp?.agency || p.agency || 'Unknown';
                        const closeDate = opp?.closeDate ? fmtDate(opp.closeDate) : 'N/A';
                        const daysLeft = opp?.closeDate ? daysUntil(opp.closeDate) : 999;
                        
                        return `
                            <div style="background: var(--dark); border: 1px solid var(--border); border-left: 3px solid ${color}; border-radius: 6px; padding: 0.75rem; cursor: pointer;" onclick="showDetail('${id}')">
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem;">
                                    <div style="flex: 1; min-width: 0;">
                                        <div style="font-weight: 600; font-size: 0.85rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">${title}</div>
                                        <div style="font-size: 0.75rem; color: var(--gray); margin-top: 0.25rem;">${agency}</div>
                                    </div>
                                    <div style="text-align: right; flex-shrink: 0;">
                                        <div style="color: var(--green); font-weight: 600; font-size: 0.85rem;">${fmtCurrency(value)}</div>
                                        <div style="font-size: 0.7rem; color: ${daysLeft <= 7 ? 'var(--red)' : daysLeft <= 14 ? 'var(--orange)' : 'var(--gray)'};">
                                            ${daysLeft <= 0 ? 'Closed' : daysLeft + 'd left'}
                                        </div>
                                    </div>
                                </div>
                                ${p.timestamp ? `<div style="font-size: 0.65rem; color: var(--gray); margin-top: 0.5rem;">Added: ${new Date(p.timestamp).toLocaleDateString()}</div>` : ''}
                            </div>`;
                    }).join('')}
                </div>
            </div>`;
    };
    
    container.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; padding-bottom: 0.75rem; border-bottom: 1px solid var(--border);">
            <div style="font-size: 0.85rem; color: var(--gray);">
                ${pipelineEntries.length} opportunities tracked
            </div>
            <div style="display: flex; gap: 0.5rem;">
                <button class="btn btn-sm btn-secondary" onclick="exportPipelineCSV()" title="Export as CSV">üìä Export CSV</button>
                <button class="btn btn-sm btn-secondary" onclick="exportPipelinePDF()" title="Export as PDF">üìÑ Export PDF</button>
                <button class="btn btn-sm btn-secondary" onclick="clearPipeline()">üóëÔ∏è Clear All</button>
            </div>
        </div>
        ${renderGroup(goItems, 'GO - Ready to Pursue', 'var(--green)', 'üü¢')}
        ${renderGroup(reviewItems, 'REVIEW - Needs Evaluation', 'var(--orange)', 'üü°')}
        ${renderGroup(nogoItems, 'NO-GO - Declined', 'var(--red)', 'üî¥')}
    `;
}

function clearPipeline() {
    if (!confirm('Clear all pipeline entries? This cannot be undone.')) return;
    pipeline = {};
    safeStorage('pipeline', pipeline);
    updatePipelineStats();
    renderPipelinePage();
    renderOpps();
    log('Pipeline cleared', 'info');
}

function exportPipelineCSV() {
    const pipelineEntries = Object.entries(pipeline)
        .map(([id, status]) => {
            const opp = opportunities.find(o => o.id === id || o.noticeId === id);
            return opp ? { ...opp, pipelineStatus: status } : null;
        })
        .filter(Boolean);
    
    if (pipelineEntries.length === 0) {
        alert('No pipeline entries to export');
        return;
    }
    
    // CSV headers
    const headers = ['Title', 'Agency', 'Value', 'Status', 'Pipeline Decision', 'NAICS', 'Set-Aside', 'Close Date', 'Source', 'Match Score'];
    
    // CSV rows
    const rows = pipelineEntries.map(o => [
        `"${(o.title || '').replace(/"/g, '""')}"`,
        `"${(o.agency || '').replace(/"/g, '""')}"`,
        o.value || 0,
        o.status || 'Review',
        o.pipelineStatus || '',
        o.naicsCode || '',
        `"${(o.setAside || '').replace(/"/g, '""')}"`,
        o.closeDate || '',
        o.source || '',
        o.qualification?.score || o.matchScore || ''
    ]);
    
    const csvContent = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
    
    // Download
    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `singh_pipeline_${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    URL.revokeObjectURL(url);
    
    log(`Exported ${pipelineEntries.length} opportunities to CSV`, 'success');
}

function exportPipelinePDF() {
    const pipelineEntries = Object.entries(pipeline)
        .map(([id, status]) => {
            const opp = opportunities.find(o => o.id === id || o.noticeId === id);
            return opp ? { ...opp, pipelineStatus: status } : null;
        })
        .filter(Boolean);
    
    if (pipelineEntries.length === 0) {
        alert('No pipeline entries to export');
        return;
    }
    
    const goItems = pipelineEntries.filter(o => o.pipelineStatus === 'go');
    const reviewItems = pipelineEntries.filter(o => o.pipelineStatus === 'review');
    const nogoItems = pipelineEntries.filter(o => o.pipelineStatus === 'nogo');
    
    const goValue = goItems.reduce((sum, o) => sum + (o.value || 0), 0);
    const reviewValue = reviewItems.reduce((sum, o) => sum + (o.value || 0), 0);
    const totalValue = goValue + reviewValue;
    
    const formatValue = v => v >= 1000000 ? '$' + (v/1000000).toFixed(1) + 'M' : '$' + (v/1000).toFixed(0) + 'K';
    
    const renderOpp = o => `
        <tr>
            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${o.title}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${o.agency}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${formatValue(o.value || 0)}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${o.closeDate || 'TBD'}</td>
            <td style="padding: 8px; border-bottom: 1px solid #ddd;">${o.pipelineStatus?.toUpperCase()}</td>
        </tr>
    `;
    
    const html = `
        <!DOCTYPE html>
        <html>
        <head>
            <title>Singh Automation Pipeline Report</title>
            <style>
                body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.5; margin: 40px; color: #333; }
                h1 { color: #1a1a1a; border-bottom: 2px solid #9ACD32; padding-bottom: 10px; }
                h2 { color: #444; margin-top: 30px; }
                table { width: 100%; border-collapse: collapse; margin: 15px 0; }
                th { background: #f5f5f5; padding: 10px; text-align: left; border-bottom: 2px solid #ddd; }
                .summary { display: flex; gap: 20px; margin: 20px 0; }
                .stat-box { background: #f9f9f9; padding: 15px; border-radius: 8px; text-align: center; flex: 1; }
                .stat-value { font-size: 24pt; font-weight: bold; color: #9ACD32; }
                .stat-label { font-size: 10pt; color: #666; }
                .go { color: #22c55e; }
                .review { color: #f59e0b; }
                .nogo { color: #ef4444; }
                @media print { body { margin: 20px; } }
            </style>
        </head>
        <body>
            <h1>üè≠ Singh Automation - Pipeline Report</h1>
            <p><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            
            <div class="summary">
                <div class="stat-box">
                    <div class="stat-value">${pipelineEntries.length}</div>
                    <div class="stat-label">Total Opportunities</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value go">${goItems.length}</div>
                    <div class="stat-label">GO Decisions</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value review">${reviewItems.length}</div>
                    <div class="stat-label">Under Review</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value">${formatValue(totalValue)}</div>
                    <div class="stat-label">Pipeline Value</div>
                </div>
            </div>
            
            ${goItems.length > 0 ? `
                <h2 class="go">üü¢ GO - Ready to Pursue (${goItems.length})</h2>
                <p>Total Value: ${formatValue(goValue)}</p>
                <table>
                    <thead><tr><th>Opportunity</th><th>Agency</th><th>Value</th><th>Close Date</th><th>Status</th></tr></thead>
                    <tbody>${goItems.map(renderOpp).join('')}</tbody>
                </table>
            ` : ''}
            
            ${reviewItems.length > 0 ? `
                <h2 class="review">üü° REVIEW - Needs Evaluation (${reviewItems.length})</h2>
                <p>Total Value: ${formatValue(reviewValue)}</p>
                <table>
                    <thead><tr><th>Opportunity</th><th>Agency</th><th>Value</th><th>Close Date</th><th>Status</th></tr></thead>
                    <tbody>${reviewItems.map(renderOpp).join('')}</tbody>
                </table>
            ` : ''}
            
            ${nogoItems.length > 0 ? `
                <h2 class="nogo">üî¥ NO-GO - Declined (${nogoItems.length})</h2>
                <table>
                    <thead><tr><th>Opportunity</th><th>Agency</th><th>Value</th><th>Close Date</th><th>Status</th></tr></thead>
                    <tbody>${nogoItems.map(renderOpp).join('')}</tbody>
                </table>
            ` : ''}
            
            <hr style="margin-top: 40px;">
            <p style="font-size: 9pt; color: #999;">Singh Automation LLC | CAGE: 86VF7 | UEI: GJ1DPYQ3X8K5<br>
            Generated by Singh Automation Platform</p>
        </body>
        </html>
    `;
    
    // Open in new window for print/save as PDF
    const printWindow = window.open('', '_blank');
    printWindow.document.write(html);
    printWindow.document.close();
    
    // Trigger print dialog after content loads
    printWindow.onload = () => {
        printWindow.print();
    };
    
    log(`Opened PDF export with ${pipelineEntries.length} opportunities`, 'success');
}

function clearStoredData() {
    if (!confirm('Clear ALL stored data including:\n‚Ä¢ Pipeline entries\n‚Ä¢ Win/loss records\n‚Ä¢ User preferences\n\nThis cannot be undone. Continue?')) return;
    
    try {
        // PRODUCTION: No API keys stored - only user data
        localStorage.removeItem('pipeline');
        localStorage.removeItem('bidOutcomes');
        localStorage.removeItem('seenOpportunities');
        localStorage.removeItem('revenueGoal');
        localStorage.removeItem('winRate');
        
        // Reset in-memory state
        pipeline = {};
        outcomes = {};
        
        // Reset UI preferences
        document.getElementById('revenueGoal').value = '500000';
        document.getElementById('winRate').value = '25';
        
        updatePipelineStats();
        updateRevenueCalculator();
        updateWinLossStats();
        
        log('All stored data cleared', 'success');
        alert('All stored data has been cleared.');
    } catch (e) {
        log('Error clearing data: ' + e.message, 'error');
    }
}

function showSecurityInfo() {
    const modal = document.createElement('div');
    modal.id = 'securityInfoModal';
    modal.style.cssText = 'position: fixed; inset: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; z-index: 1000;';
    modal.innerHTML = `
        <div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; padding: 1.5rem; max-width: 500px; margin: 1rem;">
            <h2 style="color: var(--green); margin: 0 0 1rem; font-size: 1.1rem;">üîí Production Security</h2>
            
            <div style="margin-bottom: 1rem;">
                <h3 style="color: var(--green); font-size: 0.85rem; margin: 0 0 0.5rem;">‚úÖ Server-Side Key Management</h3>
                <p style="color: var(--gray); font-size: 0.8rem; margin: 0; line-height: 1.5;">
                    In production mode, API keys are managed server-side:
                </p>
                <ul style="color: var(--gray); font-size: 0.75rem; margin: 0.5rem 0; padding-left: 1.25rem; line-height: 1.6;">
                    <li>Claude API key stored in backend environment</li>
                    <li>SAM.gov API credentials server-side</li>
                    <li>No secrets in client-side code or localStorage</li>
                </ul>
            </div>
            
            <div style="margin-bottom: 1rem;">
                <h3 style="color: var(--blue); font-size: 0.85rem; margin: 0 0 0.5rem;">üì¶ Local Storage (Non-Secrets Only)</h3>
                <ul style="color: var(--gray); font-size: 0.75rem; margin: 0; padding-left: 1.25rem; line-height: 1.6;">
                    <li>Pipeline status (GO/Review/No-Go)</li>
                    <li>Win/loss tracking records</li>
                    <li>User preferences (revenue goal, win rate)</li>
                </ul>
            </div>
            
            <div style="background: rgba(154,205,50,0.1); border: 1px solid var(--green); border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
                <h3 style="color: var(--green); font-size: 0.85rem; margin: 0 0 0.5rem;">üîê Authentication Required</h3>
                <p style="color: var(--gray); font-size: 0.75rem; margin: 0; line-height: 1.5;">
                    Backend endpoints require authentication. Unauthorized requests will fail with HTTP 401/403.
                </p>
            </div>
            
            <div style="display: flex; justify-content: flex-end; gap: 0.5rem;">
                <button class="btn btn-secondary" onclick="clearStoredData(); document.getElementById('securityInfoModal').remove();">üóëÔ∏è Clear User Data</button>
                <button class="btn btn-primary" onclick="document.getElementById('securityInfoModal').remove();">Close</button>
            </div>
        </div>
    `;
    modal.addEventListener('click', (e) => { if (e.target === modal) modal.remove(); });
    document.body.appendChild(modal);
}

function updateRevenueCalculator() {
    const goalInput = document.getElementById('revenueGoal');
    const winRateInput = document.getElementById('winRate');
    if (!goalInput || !winRateInput) return;
    
    // Parse goal (handle formats like "500000", "500K", "1M", "$500,000")
    let goalStr = goalInput.value.replace(/[$,]/g, '').toUpperCase();
    let goal = parseFloat(goalStr);
    if (goalStr.includes('K')) goal = parseFloat(goalStr) * 1000;
    if (goalStr.includes('M')) goal = parseFloat(goalStr) * 1000000;
    if (isNaN(goal)) goal = 500000;
    
    const winRate = Math.max(1, Math.min(100, parseInt(winRateInput.value) || 25)) / 100;
    
    // Calculate pipeline needed (goal / win rate)
    const pipelineNeeded = goal / winRate;
    
    // Calculate current GO pipeline value
    let currentValue = 0;
    Object.entries(pipeline).forEach(([id, p]) => {
        if (p.status === 'go') {
            const opp = opportunities.find(o => o.id === id);
            currentValue += parseFloat(opp?.value || p.value) || 0;
        }
    });
    
    // Calculate gap
    const gap = pipelineNeeded - currentValue;
    const percentComplete = pipelineNeeded > 0 ? Math.min(100, (currentValue / pipelineNeeded) * 100) : 0;
    
    // Update display
    document.getElementById('pipelineNeeded').textContent = fmtCurrency(pipelineNeeded);
    document.getElementById('currentPipeline').textContent = fmtCurrency(currentValue);
    
    const gapMsg = document.getElementById('pipelineGapMsg');
    if (gap <= 0) {
        gapMsg.innerHTML = `<span style="color: var(--green);">‚úÖ Target met! ${Math.round(percentComplete)}% of goal</span>`;
    } else {
        gapMsg.innerHTML = `<span style="color: var(--orange);">Gap: ${fmtCurrency(gap)} needed</span>
            <div style="background: #333; height: 4px; border-radius: 2px; margin-top: 0.3rem; overflow: hidden;">
                <div style="background: var(--green); height: 100%; width: ${percentComplete}%; transition: width 0.3s;"></div>
            </div>
            <div style="font-size: 0.6rem; color: var(--gray); margin-top: 0.2rem;">${Math.round(percentComplete)}% of pipeline target</div>`;
    }
}

// ========== WIN/LOSS OUTCOME TRACKING ==========
function openOutcomeModal() {
    const modal = document.getElementById('outcomeModal');
    const select = document.getElementById('outcomeOppSelect');
    
    // Populate with GO opportunities
    const goOpps = Object.entries(pipeline)
        .filter(([id, p]) => p.status === 'go')
        .map(([id, p]) => {
            const opp = opportunities.find(o => o.id === id);
            return opp ? { id, title: opp.title, value: opp.value } : null;
        })
        .filter(Boolean);
    
    select.innerHTML = '<option value="">-- Select GO opportunity --</option>' +
        goOpps.map(o => `<option value="${o.id}">${o.title.substring(0,40)}... | ${fmtCurrency(o.value)}</option>`).join('');
    
    // Clear previous values
    document.getElementById('outcomeResult').value = '';
    document.getElementById('outcomeValue').value = '';
    document.getElementById('outcomeLessons').value = '';
    
    modal.style.display = 'flex';
}

function closeOutcomeModal() {
    document.getElementById('outcomeModal').style.display = 'none';
}

function saveOutcome() {
    const oppId = document.getElementById('outcomeOppSelect').value;
    const result = document.getElementById('outcomeResult').value;
    const value = document.getElementById('outcomeValue').value;
    const lessons = document.getElementById('outcomeLessons').value;
    
    if (!oppId || !result) {
        alert('Please select an opportunity and outcome.');
        return;
    }
    
    const opp = opportunities.find(o => o.id === oppId);
    
    outcomes[oppId] = {
        result,
        value: value || null,
        lessons: lessons || null,
        recordedAt: new Date().toISOString(),
        matchScore: opp?.matchScore || 0,
        title: opp?.title || 'Unknown',
        agency: opp?.agency || 'Unknown'
    };
    
    safeStorage('bidOutcomes', outcomes);
    updateWinLossStats();
    closeOutcomeModal();
    log(`Outcome recorded: ${result} for ${opp?.title?.substring(0, 30)}...`, 'success');
}

function updateWinLossStats() {
    const allOutcomes = Object.values(outcomes);
    const submitted = allOutcomes.filter(o => o.result === 'submitted').length;
    const won = allOutcomes.filter(o => o.result === 'won').length;
    const lost = allOutcomes.filter(o => o.result === 'lost').length;
    const decided = won + lost; // Only count decided outcomes for win rate
    
    document.getElementById('outcomeSubmitted').textContent = submitted;
    document.getElementById('outcomeWon').textContent = won;
    document.getElementById('outcomeLost').textContent = lost;
    
    const actualWinRate = decided > 0 ? Math.round((won / decided) * 100) : '--';
    document.getElementById('actualWinRate').textContent = decided > 0 ? actualWinRate + '%' : '--';
    
    // If we have real data, suggest updating the win rate input
    if (decided >= 3) {
        const winRateInput = document.getElementById('winRate');
        const currentRate = parseInt(winRateInput.value) || 25;
        if (Math.abs(currentRate - actualWinRate) > 10) {
            // Show hint that actual rate differs significantly
            document.getElementById('actualWinRate').innerHTML = `${actualWinRate}% <span style="font-size: 0.6rem; color: var(--orange);" title="Your actual win rate differs from your target. Consider updating.">‚ö†Ô∏è</span>`;
        }
    }
    
    // Calculate won revenue
    const wonRevenue = allOutcomes
        .filter(o => o.result === 'won' && o.value)
        .reduce((sum, o) => {
            let v = String(o.value).replace(/[$,]/g, '').toUpperCase();
            let n = parseFloat(v);
            if (v.includes('K')) n = parseFloat(v) * 1000;
            if (v.includes('M')) n = parseFloat(v) * 1000000;
            return sum + (isNaN(n) ? 0 : n);
        }, 0);
    
    if (wonRevenue > 0) {
        document.getElementById('outcomeWon').innerHTML = `${won} <span style="font-size: 0.6rem; color: var(--green);">(${fmtCurrency(wonRevenue)})</span>`;
    }
}

// ========== MODAL & VALIDATION ==========
function showDetail(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) return;
    
    const pipelineStatus = pipeline[o.id]?.status;
    const validation = pipeline[o.id]?.validation;
    
    // CANONICAL: Use ONLY o.eligibility (single source of truth)
    const eligStatus = o.eligibility.status; // GO, REVIEW, or NO-GO
    const eligReason = o.eligibility.reason;
    const canPursue = o.eligibility.canPursue;
    const canQuote = o.eligibility.canQuote;
    
    document.getElementById('modalTitle').textContent = o.title;
    
    // Analyze Purchasing Eligibility
    const purchasingElig = analyzePurchasingEligibility(o);
    
    // Determine banner style based on CANONICAL eligibility + pipeline override
    let bannerClass, bannerIcon, bannerTitle;
    
    // Pipeline status can override eligibility display (user marked it)
    if (pipelineStatus === 'nogo') {
        bannerClass = 'nogo';
        bannerIcon = 'üö´';
        bannerTitle = 'NO-GO (User Marked)';
    } else if (pipelineStatus === 'go' && eligStatus === 'GO') {
        bannerClass = 'go';
        bannerIcon = '‚úÖ';
        bannerTitle = 'GO - PURSUE';
    } else if (pipelineStatus === 'review') {
        bannerClass = 'review';
        bannerIcon = 'üîç';
        bannerTitle = 'REVIEW (User Marked)';
    } else if (eligStatus === 'NO-GO') {
        bannerClass = 'nogo';
        bannerIcon = 'üö´';
        bannerTitle = 'NO-GO';
    } else if (eligStatus === 'REVIEW') {
        bannerClass = 'review';
        bannerIcon = 'üîç';
        bannerTitle = 'NEEDS REVIEW';
    } else {
        bannerClass = 'go';
        bannerIcon = '‚úÖ';
        bannerTitle = 'GO - PURSUE';
    }
    
    let body = `
        <!-- PURCHASING ELIGIBILITY SECTION -->
        <div style="background: ${purchasingElig.eligible ? 'rgba(59,130,246,0.1)' : 'rgba(100,100,100,0.1)'}; border: 1px solid ${purchasingElig.eligible ? 'var(--blue)' : '#555'}; border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
            <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                <span style="font-size: 1rem;">${purchasingElig.eligible ? 'üõí' : 'üìã'}</span>
                <strong style="color: ${purchasingElig.eligible ? 'var(--blue)' : '#888'}; font-size: 0.9rem;">Purchasing Eligibility</strong>
            </div>
            <div style="font-size: 0.8rem; display: flex; flex-direction: column; gap: 0.3rem;">
                <div><strong>Eligible:</strong> <span style="color: ${purchasingElig.eligible ? 'var(--green)' : 'var(--gray)'}; font-weight: 600;">${purchasingElig.eligible ? 'YES' : 'NO'}</span></div>
                <div><strong>Category:</strong> <span style="color: var(--blue);">${purchasingElig.category}</span></div>
                <div><strong>Reason:</strong> <span style="color: var(--gray);">${purchasingElig.reason}</span></div>
            </div>
        </div>
        
        <div class="eligibility-banner ${bannerClass}">
            <div class="icon">${bannerIcon}</div>
            <div class="text">
                <strong>${bannerTitle}</strong>
                <p>${eligReason}</p>
                ${eligStatus !== 'GO' ? `<p style="font-size: 0.7rem; color: var(--orange); margin-top: 0.3rem;">Source: ${o.eligibility.source || 'analysis'}</p>` : ''}
            </div>
        </div>
        
        <div class="modal-grid">
            <div class="modal-item"><label>Type</label><strong>${(o.type||'contract').toUpperCase()}</strong></div>
            <div class="modal-item"><label>Source</label><strong>${o.source||'SAM.gov'}</strong></div>
            <div class="modal-item"><label>Solicitation</label><strong>${o.solicitation||'N/A'}</strong></div>
            <div class="modal-item"><label>Value</label><strong>${fmtCurrency(o.value)}</strong></div>
            <div class="modal-item"><label>Closes</label><strong>${fmtDate(o.closeDate)} (${daysUntil(o.closeDate)}d)</strong></div>
            <div class="modal-item"><label>Set-Aside</label><strong>${o.setAside||'Full & Open'}</strong></div>
            <div class="modal-item"><label>Agency</label><strong>${(o.agency||'Federal').substring(0,50)}</strong></div>
            <div class="modal-item"><label>NAICS</label><strong>${o.naicsCode||'N/A'}</strong></div>
        </div>
        
        <!-- Match Breakdown Section -->
        ${(o.matchBreakdown && o.matchBreakdown.length > 0) ? `
        <div style="background: rgba(154,205,50,0.1); padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem; border: 1px solid rgba(154,205,50,0.3);">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem;">
                <strong style="font-size: 0.75rem; color: var(--green);">üìä Match Score: ${o.matchScore}%</strong>
            </div>
            <div style="display: flex; flex-direction: column; gap: 0.25rem;">
                ${o.matchBreakdown.map(b => b.info 
                    ? `<div style="display: flex; justify-content: space-between; font-size: 0.75rem; color: var(--blue);"><span>${b.label}</span><span>‚ÑπÔ∏è</span></div>`
                    : `<div style="display: flex; justify-content: space-between; font-size: 0.75rem;">
                        <span style="color: var(--gray);">${b.label}</span>
                        <span style="color: ${b.points >= 0 ? 'var(--green)' : 'var(--red)'}; font-weight: 600;">${b.points >= 0 ? '+' : ''}${b.points}</span>
                       </div>`
                ).join('')}
            </div>
        </div>
        ` : ''}
        
        <div style="background: #1a1a1a; padding: 0.75rem; border-radius: 6px; margin-bottom: 1rem;">
            <strong style="font-size: 0.75rem; color: var(--gray);">Description</strong>
            <p style="font-size: 0.8rem; margin-top: 0.4rem; line-height: 1.5;">${o.description||'No description'}</p>
        </div>
    `;
    
    // Show validation results if available
    if (validation) {
        // PRODUCTION: Always backend validated - no demo indicator
        const requestId = pipeline[o.id]?.requestId || 'N/A';
        body += `
            <div class="validation-section">
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <h3>üìã Validation Checks</h3>
                    <span style="font-size: 0.7rem; color: var(--green); background: rgba(154,205,50,0.1); padding: 0.2rem 0.5rem; border-radius: 4px;">üîå Backend Validated</span>
                </div>
                <div style="font-size: 0.65rem; color: var(--gray); margin-bottom: 0.5rem;">Request ID: ${requestId}</div>
                <div class="check-list">
                    ${validation.checks.map(c => `
                        <div class="check-item">
                            <div class="check-status ${c.status.toLowerCase()}">${c.status === 'PASS' ? '‚úì' : c.status === 'FAIL' ? '‚úó' : '!'}</div>
                            <div class="check-content">
                                <strong>${c.name}</strong>
                                <span>${c.detail}</span>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
        
        if (validation.timeline?.milestones) {
            body += `
                <div class="validation-section">
                    <h3>üìÖ Timeline</h3>
                    ${validation.timeline.milestones.map(m => `
                        <div class="timeline-item ${m.critical ? 'critical' : ''}">
                            <div class="timeline-date">${m.date}</div>
                            <div>
                                <div class="timeline-task">${m.task}</div>
                                <div class="timeline-days">${m.daysFromNow > 0 ? m.daysFromNow + ' days away' : 'Past'}</div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        
        if (validation.nextSteps?.length) {
            body += `
                <div class="validation-section">
                    <h3>üìå Next Steps</h3>
                    <div class="next-steps">
                        ${validation.nextSteps.map(s => `<div class="next-step">${s}</div>`).join('')}
                    </div>
                </div>
            `;
        }
    }
    
    body += `
        <div style="background: #1a1a1a; padding: 0.5rem; border-radius: 4px;">
            <label style="font-size: 0.6rem; color: var(--gray);">üîó Source Link</label><br>
            ${o.link ? `<a href="${o.link}" target="_blank" rel="noopener noreferrer" style="color: var(--green); font-size: 0.75rem;">${o.link.length > 60 ? o.link.substring(0, 60) + '...' : o.link}</a>` : '<span style="color: var(--gray); font-size: 0.75rem;">No direct link available</span>'}
        </div>
    `;
    
    document.getElementById('modalBody').innerHTML = body;
    
    // Check if Quote button should show
    const quoteBtn = checkQuoteEligibility(o) 
        ? `<button class="btn btn-quote btn-sm" onclick="openQuoteRequest('${o.id}')" title="Prepare a non-binding distributor RFQ for pricing validation.">üìã Request Distributor Quote</button>`
        : '';
    
    const viewSourceBtn = o.link 
        ? `<button class="btn btn-primary" onclick="window.open('${o.link}','_blank')">üîó View Source</button>`
        : `<button class="btn btn-primary" disabled title="No source link available">üîó View Source</button>`;
    
    document.getElementById('modalFooter').innerHTML = `
        ${viewSourceBtn}
        <button class="btn btn-secondary" onclick="runValidation('${o.id}')" ${!o.eligibility.ok?'disabled':''} data-testid="btn-validate">üîç Validate</button>
        <button class="btn btn-go btn-sm" onclick="setPipelineStatus('${o.id}','go')" ${!o.eligibility.ok?'disabled':''} data-testid="btn-go">‚úÖ GO</button>
        <button class="btn btn-review btn-sm" onclick="setPipelineStatus('${o.id}','review')" data-testid="btn-review">üîç Review</button>
        <button class="btn btn-nogo btn-sm" onclick="setPipelineStatus('${o.id}','nogo')" data-testid="btn-nogo">üö´ No-Go</button>
        ${quoteBtn}
        <button class="btn btn-proposal btn-sm" onclick="goToProposal('${o.id}')" ${!o.eligibility.ok?'disabled':''} data-testid="btn-proposal">üìù Proposal</button>
        <button class="btn btn-sm" style="background: linear-gradient(135deg, #1B4F72, #2E86AB); color: #fff;" onclick="downloadBeautifulProposal('${o.id}')" data-testid="btn-download-proposal">üìÑ Download Proposal</button>
        <button class="btn btn-sm" style="background: linear-gradient(135deg, var(--green), #2E86AB); color: #fff;" onclick="askAgentAboutOpp('${o.id}')" data-testid="btn-ask-agent">ü§ñ Ask Agent_SAM</button>
        <button class="btn btn-secondary" onclick="closeModal()" data-testid="btn-close-modal">Close</button>
    `;
    
    document.getElementById('detailModal').classList.add('active');
}

function closeModal() { document.getElementById('detailModal').classList.remove('active'); }

// Ask Agent_SAM about a specific opportunity from the modal
function askAgentAboutOpp(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) return;
    
    // Close the modal
    closeModal();
    
    // Navigate to Agent_SAM page
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-page="agent"]').classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-agent').classList.add('active');
    
    // Set the context dropdown to this opportunity
    const select = document.getElementById('agentContext');
    if (select) {
        select.value = id;
        agentContext = o;
        
        // Update the selected opp info
        const infoEl = document.getElementById('selectedOppInfo');
        if (infoEl) {
            infoEl.innerHTML = `
                <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px;">
                    <div style="color: var(--green); font-weight: 600;">${o.matchScore}% Match</div>
                    <div style="color: #fff; font-size: 0.65rem; margin-top: 0.25rem;">üí∞ ${fmtCurrency(o.value)} | üèõÔ∏è ${(o.agency || '').substring(0, 25)}</div>
                    <div style="color: var(--gray); font-size: 0.6rem; margin-top: 0.25rem;">üìÖ Closes: ${fmtDate(o.closeDate)}</div>
                </div>
            `;
        }
    }
    
    // Ask Agent_SAM to analyze this opportunity
    const question = `Analyze this opportunity and give me a GO/NO-GO recommendation:

**${o.title}**
- Agency: ${o.agency}
- Value: ${fmtCurrency(o.value)}
- NAICS: ${o.naicsCode || 'N/A'}
- Set-Aside: ${o.setAside || 'None'}
- Match Score: ${o.matchScore}%
- Closes: ${fmtDate(o.closeDate)}

Description: ${(o.description || '').substring(0, 500)}

Give me:
1. GO/NO-GO recommendation with confidence level
2. Key win factors for Singh Automation
3. Major risks or concerns
4. Recommended next steps`;
    
    document.getElementById('agentInput').value = question;
    setTimeout(() => sendToAgent(), 300);
}

// NEW: Generate proposal directly from modal - now uses Agent_SAM
function goToProposal(id) {
    // Set status to GO if not already set
    if (!pipeline[id]?.status || pipeline[id].status === 'review') {
        pipeline[id] = pipeline[id] || {};
        pipeline[id].status = 'go';
        pipeline[id].timestamp = new Date().toISOString();
        safeStorage('pipeline', pipeline);
    }
    
    // Close modal
    closeModal();
    
    // Navigate to Agent_SAM page
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-page="agent"]').classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-agent').classList.add('active');
    
    // Set Agent_SAM context to this opportunity
    const contextSelect = document.getElementById('agentContext');
    if (contextSelect) {
        contextSelect.value = id;
        const o = opportunities.find(x => x.id === id);
        if (o) {
            agentContext = o;
            // Add message to agent chat
            addAgentMessage(`üìç Context set to: <strong>${o.title}</strong>. Ready to help with analysis and proposal.`, 'agent');
            // Auto-ask for analysis
            setTimeout(() => {
                askAgent('Give me a GO/NO-GO recommendation and key win themes for this opportunity');
            }, 500);
        }
    }
    
    // Scroll to top
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

// Generate proposal for specific ID (called from modal)
// Legacy function - kept for compatibility but now uses Agent_SAM workflow
async function generateProposalForId(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) { alert('Opportunity not found'); return; }
    
    // Redirect to Agent_SAM for proposal help
    log(`Redirecting to Agent_SAM for: ${o.title}`, 'info');
    
    // Set context and navigate to Agent_SAM
    document.getElementById('agentContext').value = id;
    agentContext = o;
    addAgentMessage(`üìç Context set to: <strong>${o.title}</strong>`, 'agent');
    askAgent('Help me create a winning proposal for this opportunity. What are the key discriminators and win themes?');
}

// Download beautiful formatted proposal as Word document
async function downloadBeautifulProposal(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) { alert('Opportunity not found'); return; }
    
    // Show loading state
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '‚è≥ Generating...';
    btn.disabled = true;
    
    try {
        const response = await fetch('https://singh-automation.vercel.app/api/generate-proposal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                opportunity: {
                    title: o.title,
                    solicitation: o.solicitation || o.noticeId || o.id,
                    agency: o.agency,
                    value: o.value,
                    naicsCode: o.naicsCode,
                    description: o.description || o.fullDescription || ''
                }
            })
        });
        
        if (!response.ok) {
            throw new Error('Failed to generate proposal');
        }
        
        // Get the blob and download
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Singh_Proposal_${o.title.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50)}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        log(`Downloaded proposal for: ${o.title}`, 'success');
        
    } catch (e) {
        console.error('Error downloading proposal:', e);
        alert('Failed to generate proposal: ' + e.message);
        log('Proposal download failed: ' + e.message, 'error');
    }
    
    btn.innerHTML = originalText;
    btn.disabled = false;
}

async function runValidation(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) {
        alert('Opportunity not found');
        return;
    }
    
    // PRODUCTION: No demo mode check - always use live backend
    const backendUrl = BACKEND_BASE + '/api/validate';
    const requestId = crypto.randomUUID();
    
    showLoading('Running validation agent...', true);
    log('Validating: ' + o.title, 'info');
    updateLoadingProgress('Connecting to validation service...');
    
    const controller = new AbortController();
    const TIMEOUT_MS = 60000; // 60 seconds for validation
    
    try {
        const r = await fetch(backendUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Request-ID': requestId
            },
            signal: AbortSignal.any([controller.signal, AbortSignal.timeout(TIMEOUT_MS)]),
            body: JSON.stringify({ 
                opportunity: o,
                requestId: requestId
            })
        });
        
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        
        const text = await r.text();
        let d;
        try {
            d = JSON.parse(text);
        } catch (parseErr) {
            throw new Error('Invalid JSON response from validation service');
        }
        
        // Schema validation
        if (!d.success) {
            throw new Error(d.error || 'Validation service returned success=false');
        }
        if (!d.analysis?.validation?.recommendation) {
            throw new Error('Invalid response schema: missing validation.recommendation');
        }
        
        pipeline[o.id] = {
            status: d.analysis.validation.recommendation.toLowerCase(),
            validation: d.analysis.validation,
            checklist: d.analysis.checklist,
            timeline: d.analysis.timeline,
            timestamp: new Date().toISOString(),
            title: o.title,
            agency: o.agency,
            value: o.value,
            backendValidated: true,
            requestId: requestId
        };
        safeStorage('pipeline', pipeline);
        
        log(`Validation complete: ${d.analysis.validation.recommendation}`, 'success');
        hideLoading();
        showDetail(id);
        renderOpps();
        updatePipelineStats();
        
    } catch (e) {
        hideLoading();
        log(`HARD FAILURE: Validation failed - ${e.message}`, 'error');
        
        // Show hard error in modal
        const errorHtml = showHardError(
            'Validation Service',
            backendUrl,
            e.message,
            'Validation cannot proceed without backend service.',
            requestId
        );
        
        alert(`VALIDATION BLOCKED\n\nEndpoint: ${backendUrl}\nError: ${e.message}\nRequest ID: ${requestId}\n\nValidation requires live backend service.`);
    }
}

// PRODUCTION: Demo validation removed - runDemoValidation is intentionally absent

function setPipelineStatus(id, status) {
    const opp = opportunities.find(o => o.id === id);
    pipeline[id] = pipeline[id] || {};
    pipeline[id].status = status;
    pipeline[id].timestamp = new Date().toISOString();
    // Store key details for pipeline view even when opportunities not loaded
    if (opp) {
        pipeline[id].title = opp.title;
        pipeline[id].agency = opp.agency;
        pipeline[id].value = opp.value;
    }
    safeStorage('pipeline', pipeline);
    
    log(`Set ${id} to ${status.toUpperCase()}`, 'success');
    closeModal();
    renderOpps();
    updatePipelineStats();
    renderQualifiedList();
    updateOppSelect(); // Update dropdown when status changes
}

// ========== AGENT_SAM - AI BD ASSISTANT ==========
let agentContext = null; // Currently selected opportunity for context

function updateAgentStats() {
    const goCount = Object.values(pipeline).filter(p => p.status === 'go').length;
    const reviewCount = Object.values(pipeline).filter(p => p.status === 'review').length;
    const totalValue = opportunities
        .filter(o => pipeline[o.id]?.status === 'go')
        .reduce((sum, o) => sum + (parseFloat(o.value) || 0), 0);
    const now = new Date();
    const urgentCount = opportunities.filter(o => {
        if (!o.closeDate) return false;
        const close = new Date(o.closeDate);
        const days = Math.ceil((close - now) / (1000 * 60 * 60 * 24));
        return days > 0 && days <= 14;
    }).length;
    
    document.getElementById('agentGoCount').textContent = goCount;
    document.getElementById('agentReviewCount').textContent = reviewCount;
    document.getElementById('agentTotalValue').textContent = '$' + (totalValue / 1000000).toFixed(1) + 'M';
    document.getElementById('agentUrgentCount').textContent = urgentCount;
}

function updateAgentContextDropdown() {
    const select = document.getElementById('agentContext');
    const goOpps = opportunities.filter(o => pipeline[o.id]?.status === 'go' || o.matchScore >= 60);
    
    select.innerHTML = '<option value="">General - All Opportunities</option>' +
        goOpps.sort((a, b) => b.matchScore - a.matchScore)
            .slice(0, 20)
            .map(o => `<option value="${o.id}">${o.title.substring(0, 40)}... (${o.matchScore}%)</option>`)
            .join('');
}

function updateAgentContext() {
    const id = document.getElementById('agentContext').value;
    const infoEl = document.getElementById('selectedOppInfo');
    
    if (id) {
        agentContext = opportunities.find(o => o.id === id);
        if (agentContext) {
            // Show opportunity info
            infoEl.innerHTML = `
                <div style="background: #0a0a0a; padding: 0.5rem; border-radius: 4px; margin-top: 0.5rem;">
                    <div style="color: var(--green); font-weight: 600;">${agentContext.matchScore}% Match</div>
                    <div style="color: #fff; font-size: 0.65rem; margin-top: 0.25rem;">üí∞ ${fmtCurrency(agentContext.value)} | üèõÔ∏è ${(agentContext.agency || '').substring(0, 25)}</div>
                    <div style="color: var(--gray); font-size: 0.6rem; margin-top: 0.25rem;">üìÖ Closes: ${fmtDate(agentContext.closeDate)}</div>
                </div>
            `;
            addAgentMessage(`üìç Context set to: <strong>${agentContext.title}</strong>. I'll focus my analysis on this opportunity.`, 'agent');
        }
    } else {
        agentContext = null;
        infoEl.innerHTML = '<span style="color: var(--gray);">Select an opportunity to analyze</span>';
        addAgentMessage('üìç Context cleared. I\'ll provide general pipeline advice.', 'agent');
    }
}

function addAgentMessage(content, type = 'agent') {
    const chat = document.getElementById('agentChat');
    const div = document.createElement('div');
    div.className = type === 'user' ? 'user-message' : 'agent-message';
    
    if (type === 'user') {
        div.innerHTML = `
            <div style="display: flex; gap: 0.5rem; align-items: flex-start; justify-content: flex-end;">
                <div style="background: var(--green); color: #000; border-radius: 12px; border-top-right-radius: 4px; padding: 0.75rem 1rem; max-width: 85%;">
                    <div style="font-size: 0.85rem; line-height: 1.5;">${content}</div>
                </div>
                <div style="width: 28px; height: 28px; background: var(--card); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0; border: 1px solid var(--border);">üë§</div>
            </div>`;
    } else {
        div.innerHTML = `
            <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
                <div style="width: 28px; height: 28px; background: linear-gradient(135deg, var(--green), #2E86AB); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0;">ü§ñ</div>
                <div style="background: #1a1a1a; border-radius: 12px; border-top-left-radius: 4px; padding: 0.75rem 1rem; max-width: 85%;">
                    <div style="font-size: 0.85rem; line-height: 1.5;">${content}</div>
                </div>
            </div>`;
    }
    
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function addTypingIndicator() {
    const chat = document.getElementById('agentChat');
    const div = document.createElement('div');
    div.id = 'typingIndicator';
    div.innerHTML = `
        <div style="display: flex; gap: 0.5rem; align-items: flex-start;">
            <div style="width: 28px; height: 28px; background: linear-gradient(135deg, var(--green), #2E86AB); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; flex-shrink: 0;">ü§ñ</div>
            <div style="background: #1a1a1a; border-radius: 12px; border-top-left-radius: 4px; padding: 0.75rem 1rem;">
                <div style="display: flex; gap: 4px;">
                    <span style="width: 8px; height: 8px; background: var(--gray); border-radius: 50%; animation: bounce 1s infinite;"></span>
                    <span style="width: 8px; height: 8px; background: var(--gray); border-radius: 50%; animation: bounce 1s infinite 0.2s;"></span>
                    <span style="width: 8px; height: 8px; background: var(--gray); border-radius: 50%; animation: bounce 1s infinite 0.4s;"></span>
                </div>
            </div>
        </div>`;
    chat.appendChild(div);
    chat.scrollTop = chat.scrollHeight;
}

function removeTypingIndicator() {
    const indicator = document.getElementById('typingIndicator');
    if (indicator) indicator.remove();
}

function formatAgentResponse(text) {
    // Convert markdown-style formatting to HTML
    return text
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/^### (.*$)/gm, '<h4 style="color: var(--green); margin: 0.75rem 0 0.5rem;">$1</h4>')
        .replace(/^## (.*$)/gm, '<h3 style="color: var(--green); margin: 1rem 0 0.5rem;">$1</h3>')
        .replace(/^# (.*$)/gm, '<h2 style="color: var(--green); margin: 1rem 0 0.5rem;">$1</h2>')
        .replace(/^- (.*$)/gm, '<li style="margin-left: 1rem;">$1</li>')
        .replace(/^(\d+)\. (.*$)/gm, '<li style="margin-left: 1rem;"><strong>$1.</strong> $2</li>')
        .replace(/‚úÖ/g, '<span style="color: var(--green);">‚úÖ</span>')
        .replace(/‚ùå/g, '<span style="color: var(--red);">‚ùå</span>')
        .replace(/‚ö†Ô∏è/g, '<span style="color: var(--orange);">‚ö†Ô∏è</span>')
        .replace(/üéØ/g, '<span>üéØ</span>')
        .replace(/\n\n/g, '<br><br>')
        .replace(/\n/g, '<br>');
}

async function sendToAgent() {
    const input = document.getElementById('agentInput');
    const message = input.value.trim();
    if (!message) return;
    
    // Clear input
    input.value = '';
    
    // Add user message
    addAgentMessage(message, 'user');
    
    // Show typing indicator
    addTypingIndicator();
    
    // Disable send button
    const btn = document.getElementById('agentSendBtn');
    btn.disabled = true;
    btn.textContent = '...';
    
    try {
        const response = await fetch('https://singh-automation.vercel.app/api/agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: message,
                context: {
                    opportunities: opportunities,
                    pipeline: pipeline,
                    currentOpportunity: agentContext,
                    subcontracting: typeof subOpportunities !== 'undefined' ? subOpportunities : [],
                    priceCatalog: typeof PRICE_CATALOG !== 'undefined' ? PRICE_CATALOG : {},
                    // Agent Memory - training data
                    memory: {
                        pastPerformance: agentMemory?.pastPerformance || [],
                        winThemes: agentMemory?.winThemes || [],
                        lessons: agentMemory?.lessons || [],
                        documents: (agentMemory?.documents || []).map(d => ({ name: d.name, content: d.content?.substring(0, 5000) })),
                        outcomes: agentMemory?.outcomes || [],
                        proposalTemplates: (agentMemory?.proposalTemplates || []).map(t => ({ name: t.name, type: t.type, content: t.content }))
                    }
                }
            })
        });
        
        const data = await response.json();
        
        removeTypingIndicator();
        
        if (data.success) {
            addAgentMessage(formatAgentResponse(data.response), 'agent');
        } else {
            addAgentMessage(`<span style="color: var(--red);">Error: ${data.error || 'Failed to get response'}</span>`, 'agent');
        }
        
    } catch (error) {
        removeTypingIndicator();
        addAgentMessage(`<span style="color: var(--red);">Connection error: ${error.message}. Make sure the backend is deployed.</span>`, 'agent');
    }
    
    btn.disabled = false;
    btn.textContent = 'Send ‚Üí';
}

function askAgent(question) {
    document.getElementById('agentInput').value = question;
    sendToAgent();
}

// Store current proposal text for copy/download
let agentProposalText = '';

// Generate proposal preview in Agent_SAM panel - PROPER GOVERNMENT FORMAT
async function generateProposalInAgent() {
    const id = document.getElementById('agentContext').value;
    if (!id) {
        addAgentMessage('‚ö†Ô∏è Please select an opportunity first.', 'agent');
        return;
    }
    
    const o = opportunities.find(x => x.id === id);
    if (!o) {
        addAgentMessage('<span style="color: var(--red);">Opportunity not found</span>', 'agent');
        return;
    }
    
    const previewEl = document.getElementById('agentProposalPreview');
    const btn = document.getElementById('agentGenerateBtn');
    
    // Show loading state
    btn.disabled = true;
    btn.innerHTML = '‚è≥ Generating...';
    previewEl.innerHTML = '<div style="color: #888; text-align: center; padding: 2rem;"><div class="spinner" style="border: 3px solid #ccc; border-top-color: #1B4F72; width: 30px; height: 30px; margin: 0 auto 1rem;"></div>Generating proposal...</div>';
    
    addAgentMessage(`üöÄ Generating proposal for <strong>${o.title}</strong>...`, 'agent');
    
    // Generate proper government proposal format locally
    const title = o.title || 'Government Contract';
    const solicitation = o.solicitation || o.noticeId || '[SOLICITATION #]';
    const agency = o.agency || 'Government Agency';
    const value = o.value ? `$${Number(o.value).toLocaleString()}` : 'TBD';
    const naics = o.naicsCode || '333249';
    const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    
    agentProposalText = `TECHNICAL AND MANAGEMENT PROPOSAL
${title}
Singh Automation LLC

CAGE: 86VF7 | UEI: GJ1DPYQ3X8K5
Solicitation: ${solicitation}
Submitted to: ${agency}
Date: ${today}
Estimated Value: ${value}

---

TABLE OF CONTENTS
1. Executive Summary
2. Technical Approach
3. Management Approach
4. Key Personnel
5. Quality Assurance Plan
6. Risk Management Plan
7. Past Performance
8. Price Proposal (Separate Volume)
9. Attachments and Certifications

---

1. EXECUTIVE SUMMARY

1.1 Understanding of Requirements
Singh Automation LLC proposes a turnkey automation solution designed to modernize operations, enhance system reliability, and reduce risks associated with manual processes for ${agency}. This proposal demonstrates our comprehensive understanding of the requirements, outlines a technical approach leveraging proven industrial automation technologies, details a disciplined project management plan, and establishes quality and risk controls to ensure delivery of an on-time, compliant system.

Based on the solicitation and Performance Work Statement (PWS), the Government requires an automated system that must integrate with existing facility infrastructure and controls, be installed with minimal operational disruption, and include training, documentation, acceptance testing, and warranty support.

1.2 Proposed Solution Overview
Our baseline solution features industrial-grade automation equipment with integrated safety systems, PLC controls, and interface capabilities for seamless facility integration. The system will be engineered, staged, and tested at our facility prior to delivery. Installation, commissioning, and validation will occur on site, with Government witness testing to ensure compliance.

1.3 Value and Differentiators
‚Ä¢ FANUC Authorized System Integrator with OEM-backed support
‚Ä¢ Universal Robots Certified Systems Partner
‚Ä¢ Proven track record with federal and state contracts
‚Ä¢ Michigan headquarters with California sales office for national coverage
‚Ä¢ Small business with MBE and WBENC certifications

---

2. TECHNICAL APPROACH

2.1 System Architecture (Baseline)
The baseline equipment and major subsystems include:

‚Ä¢ Robot/Automation: FANUC or Universal Robots platform (final model per approved design)
‚Ä¢ Controller: Current generation with application software package
‚Ä¢ Integration: PLC interface to existing facility controls (Rockwell/Allen-Bradley or site standard)
‚Ä¢ Safety: Category-rated guarding and safety devices per applicable standards
‚Ä¢ Vision (if applicable): Cognex or Keyence systems with AI/ML pattern recognition

2.2 Integration and Interfaces
Singh Automation will conduct an initial site survey to validate space, utilities, access, and control interfaces. Following this, we will produce an approved design package, including layout, electrical, safety, I/O list, and integration plan, prior to procurement and fabrication.

2.3 Implementation Methodology

Phase 1 ‚Äì Planning and Design (Weeks 1-4):
‚Ä¢ Site survey and requirements validation
‚Ä¢ Design package: 2D/3D layouts, electrical schematics, safety concept, I/O list
‚Ä¢ Government design review and approval checkpoint

Phase 2 ‚Äì Build, Stage, and Factory Testing (Weeks 5-12):
‚Ä¢ Procurement of long-lead components and fabrication
‚Ä¢ Integration and programming in staging environment
‚Ä¢ Factory Acceptance Test (FAT) with documented results

Phase 3 ‚Äì Installation, Commissioning, and Acceptance (Weeks 13-16):
‚Ä¢ Delivery and installation with coordinated downtime windows
‚Ä¢ Site Acceptance Test (SAT) to verify functional and performance requirements
‚Ä¢ Training, as-built documentation, and transition to operations

2.4 Deliverables
‚Ä¢ Site Assessment Report and Requirements Validation Summary
‚Ä¢ Design Package for Government approval (layout, electrical, safety, controls interface)
‚Ä¢ Factory Acceptance Test (FAT) procedures and results
‚Ä¢ Installed System (hardware, software, safety systems)
‚Ä¢ Site Acceptance Test (SAT) procedures and results; acceptance certificate
‚Ä¢ Training materials and completion records
‚Ä¢ Operations and Maintenance (O&M) manuals; as-built drawings; spare parts list
‚Ä¢ Warranty and support plan; service response process

2.5 Requirements Traceability Matrix
[To be populated with actual solicitation/PWS sections and acceptance criteria]

---

3. MANAGEMENT APPROACH

3.1 Program Management and Governance
Singh Automation will appoint a Program Manager to serve as the primary point of contact, responsible for overseeing cost, schedule, scope, and quality. Weekly status reports and a maintained issue/risk register will ensure transparent project oversight.

3.2 Organizational Structure and Roles
‚Ä¢ Program Manager: Contract POC; schedule, budget, reporting, change control
‚Ä¢ Technical Lead: Engineering authority for design, programming, commissioning
‚Ä¢ Quality Lead: QA/QC planning, inspection, test documentation control
‚Ä¢ Safety Lead: Safety design review, hazard analysis, site safety coordination
‚Ä¢ Installation Technicians: Mechanical/electrical installation and on-site support

3.3 Communications and Reporting
‚Ä¢ Weekly Status Reports: Progress updates with milestone tracking
‚Ä¢ Bi-weekly Steering Committee Meetings: Executive-level project reviews
‚Ä¢ Daily Standups: Technical team coordination and issue resolution
‚Ä¢ Issue/Risk Register: Maintained and reported weekly

3.4 Schedule Management
Baseline schedule will be submitted after award and kickoff, incorporating long-lead procurement times and Government review windows.

---

4. KEY PERSONNEL

[Resumes to be included in final submission per solicitation requirements]

| Role | Proposed Individual | Qualifications |
|------|---------------------|----------------|
| Program Manager | David Mih | COO/GM, PMP-eligible, 15+ years |
| Technical Lead | Soorya Sridhar | PM Electrical, Controls specialist |
| Operations Lead | Sonny Singh | Operations Manager, Mechanical systems |
| Quality Lead | Ricardo del Olmo Parrado | Resource & Compliance Manager |
| Executive Sponsor | Gurdeep Singh | Owner & Chairman |
| Primary Contact | Albert Mizuno | Principal/CEO, 786-344-8955 |

---

5. QUALITY ASSURANCE PLAN

5.1 Quality Control Checkpoints
| Phase | Checkpoint | Acceptance Criteria |
|-------|------------|---------------------|
| Design | Design Review | Government approval |
| Build | FAT | Functional test pass |
| Install | SAT | Performance requirements met |
| Closeout | Final Acceptance | Documentation complete |

5.2 Nonconformance and Corrective Action
Any nonconformance identified during design, FAT, installation, or SAT will be documented, including root cause analysis, corrective action, and verification of closure prior to acceptance.

---

6. RISK MANAGEMENT PLAN

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Long-lead procurement delays | Schedule | Medium | Early ordering, alternative suppliers |
| Site access coordination | Schedule | Low | Pre-coordination with facility |
| Integration complexity | Technical | Medium | Detailed site survey, design reviews |
| Safety compliance | Technical | Low | Third-party safety validation |

---

7. PAST PERFORMANCE

Project 1: [PROJECT NAME]
‚Ä¢ Client: [Client Name]
‚Ä¢ Contract Value: $XXX,XXX
‚Ä¢ Period of Performance: [Dates]
‚Ä¢ Scope: [Description]
‚Ä¢ Results: [Quantified outcomes]
‚Ä¢ Reference: [Name, Title, Phone, Email]

Project 2: [PROJECT NAME]
[Similar format - include 3-5 relevant projects]

---

8. PRICE PROPOSAL

[Submitted as separate volume per solicitation instructions]

| Category | Amount | % |
|----------|--------|---|
| Engineering & Design | ${value !== 'TBD' ? '$' + Math.round(parseFloat(value.replace(/[$,]/g,'')) * 0.15).toLocaleString() : 'TBD'} | 15% |
| Equipment & Materials | ${value !== 'TBD' ? '$' + Math.round(parseFloat(value.replace(/[$,]/g,'')) * 0.45).toLocaleString() : 'TBD'} | 45% |
| Integration & Programming | ${value !== 'TBD' ? '$' + Math.round(parseFloat(value.replace(/[$,]/g,'')) * 0.25).toLocaleString() : 'TBD'} | 25% |
| Installation & Commissioning | ${value !== 'TBD' ? '$' + Math.round(parseFloat(value.replace(/[$,]/g,'')) * 0.10).toLocaleString() : 'TBD'} | 10% |
| Training & Documentation | ${value !== 'TBD' ? '$' + Math.round(parseFloat(value.replace(/[$,]/g,'')) * 0.05).toLocaleString() : 'TBD'} | 5% |
| **Total Proposed Price** | **${value}** | **100%** |

---

9. ATTACHMENTS AND CERTIFICATIONS (Checklist)

‚òê Signed cover letter and completed solicitation forms
‚òê Key personnel resumes and commitment letters
‚òê OEM/Partner certifications (FANUC ASI, Universal Robots CSP)
‚òê Safety plan / hazard analysis summary
‚òê Quality plan and sample test procedures (FAT/SAT)
‚òê Past performance references and supporting letters
‚òê Insurance certificates
‚òê State registrations (if applicable)

---

Singh Automation LLC
CAGE: 86VF7 | UEI: GJ1DPYQ3X8K5
Headquarters: 7804 S Sprinkle Road, Portage, MI 49002
California Office: 300 Spectrum Center Dr, Suite 400, Irvine, CA 92618
Contact: albert@singhautomation.com | 786-344-8955
`;
    
    previewEl.innerHTML = mdToHtml(agentProposalText);
    addAgentMessage(`‚úÖ Proposal generated in proper government format! Review and fill in the bracketed sections [like this] before submission.`, 'agent');
    
    btn.disabled = false;
    btn.innerHTML = 'üöÄ Generate';
}

// Copy proposal to clipboard
function copyProposal() {
    if (!agentProposalText) {
        addAgentMessage('‚ö†Ô∏è Generate a proposal first.', 'agent');
        return;
    }
    
    navigator.clipboard.writeText(agentProposalText).then(() => {
        addAgentMessage('‚úÖ Proposal copied to clipboard!', 'agent');
    }).catch(err => {
        addAgentMessage(`<span style="color: var(--red);">Failed to copy: ${err.message}</span>`, 'agent');
    });
}

// Download proposal as TXT
function downloadProposalTxt() {
    if (!agentProposalText) {
        addAgentMessage('‚ö†Ô∏è Generate a proposal first.', 'agent');
        return;
    }
    
    const id = document.getElementById('agentContext').value;
    const o = opportunities.find(x => x.id === id);
    const filename = o ? o.title.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30) : 'Proposal';
    
    const blob = new Blob([agentProposalText], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Singh_Proposal_${filename}.txt`;
    a.click();
    URL.revokeObjectURL(a.href);
    
    addAgentMessage('‚úÖ Proposal downloaded as .txt!', 'agent');
}

// Edit proposal with AI
async function editProposal() {
    const editInput = document.getElementById('proposalEditInput');
    const instruction = editInput.value.trim();
    
    if (!instruction) {
        addAgentMessage('‚ö†Ô∏è Enter an edit instruction first.', 'agent');
        return;
    }
    
    if (!agentProposalText) {
        addAgentMessage('‚ö†Ô∏è Generate a proposal first, then edit it.', 'agent');
        return;
    }
    
    editInput.value = '';
    addAgentMessage(`‚ú® Editing proposal: "${instruction}"...`, 'agent');
    
    const previewEl = document.getElementById('agentProposalPreview');
    
    try {
        const response = await fetch('https://singh-automation.vercel.app/api/agent', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                message: `Here is the current proposal text:\n\n${agentProposalText}\n\n---\n\nPlease apply this edit: "${instruction}"\n\nReturn the COMPLETE updated proposal with the requested changes. Keep all sections but apply the edit. Output the full proposal text.`,
                context: {
                    opportunities: opportunities,
                    pipeline: pipeline,
                    currentOpportunity: agentContext
                }
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            agentProposalText = data.response;
            previewEl.innerHTML = mdToHtml(data.response);
            addAgentMessage(`‚úÖ Proposal updated! Applied: "${instruction}"`, 'agent');
        } else {
            throw new Error(data.error || 'Edit failed');
        }
        
    } catch (error) {
        addAgentMessage(`<span style="color: var(--red);">Edit failed: ${error.message}</span>`, 'agent');
    }
}

// Quick edit proposal with preset instruction
function quickEditProposal(instruction) {
    document.getElementById('proposalEditInput').value = instruction;
    editProposal();
}

async function downloadProposalFromAgent() {
    const id = document.getElementById('agentContext').value;
    if (!id) {
        addAgentMessage('‚ö†Ô∏è Please select an opportunity from the dropdown first, then click Download again.', 'agent');
        return;
    }
    
    const o = opportunities.find(x => x.id === id);
    if (!o) {
        addAgentMessage('<span style="color: var(--red);">Opportunity not found</span>', 'agent');
        return;
    }
    
    addAgentMessage(`üìÑ Generating Word document for <strong>${o.title}</strong>...`, 'agent');
    
    try {
        const response = await fetch('https://singh-automation.vercel.app/api/generate-proposal', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ 
                opportunity: {
                    title: o.title,
                    solicitation: o.solicitation || o.noticeId || o.id,
                    agency: o.agency,
                    value: o.value,
                    naicsCode: o.naicsCode,
                    description: o.description || o.fullDescription || ''
                }
            })
        });
        
        if (!response.ok) throw new Error('Generation failed');
        
        const blob = await response.blob();
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Singh_Proposal_${o.title.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 50)}.docx`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
        
        addAgentMessage(`‚úÖ Word document downloaded! Remember to fill in the <strong>ACTION REQUIRED</strong> sections before submission.`, 'agent');
        
    } catch (error) {
        addAgentMessage(`<span style="color: var(--red);">Failed to generate document: ${error.message}</span>`, 'agent');
    }
}

// Initialize agent when page loads
function initAgent() {
    updateAgentStats();
    updateAgentContextDropdown();
    
    // Pre-load subcontracting data so Agent_SAM always has access
    if (subOpportunities.length === 0 && typeof getSubDemoData === 'function') {
        subOpportunities = getSubDemoData();
        console.log('Agent_SAM: Pre-loaded', subOpportunities.length, 'subcontracting opportunities');
    }
}

// ========== PROPOSAL GENERATION ==========
let proposalController = null; // AbortController for proposal generation

// PRODUCTION: checkAiBackendStatus removed - no demo mode
// PRODUCTION: generateDemoProposal removed - no template fallbacks

// Legacy function - kept for compatibility
async function generateProposal() {
    const selectEl = document.getElementById('oppSelect');
    const id = selectEl?.value;
    if (!id) { 
        alert('Select an opportunity first'); 
        return; 
    }
    const o = opportunities.find(x => x.id === id || x.noticeId === id);
    if (!o) { 
        alert('Opportunity not found'); 
        return; 
    }
    
    // Check if old UI elements exist, if not redirect to Agent_SAM
    const previewEl = document.getElementById('proposalPreview');
    const outputEl = document.getElementById('proposalOutput');
    if (!previewEl || !outputEl) {
        // Redirect to Agent_SAM
        document.getElementById('agentContext').value = o.id;
        agentContext = o;
        addAgentMessage(`üìç Context set to: <strong>${o.title}</strong>`, 'agent');
        askAgent('Help me create a winning proposal for this opportunity');
        return;
    }
    
    // PRODUCTION: No demo mode, no client-side key
    const backendUrl = BACKEND_BASE + '/api/generate';
    const requestId = crypto.randomUUID();
    
    // Cancel any existing request
    if (proposalController) {
        proposalController.abort();
    }
    proposalController = new AbortController();
    
    showLoading('Generating AI proposal...', true);
    updateLoadingProgress('Connecting to proposal service...');
    log(`Generating proposal for: ${o.title}`, 'info');
    
    const TIMEOUT_MS = 120000; // 2 minutes for proposal generation
    
    try {
        const r = await fetch(backendUrl, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                'X-Request-ID': requestId
            },
            signal: AbortSignal.any([proposalController.signal, AbortSignal.timeout(TIMEOUT_MS)]),
            body: JSON.stringify({ 
                title: o.title,
                solicitation: o.solicitation || o.noticeId,
                agency: o.agency,
                value: o.value || 0,
                naics: o.naicsCode || '',
                setAside: o.setAside || '',
                description: o.description || '',
                category: o.category || 'Federal',
                requestId: requestId
                // PRODUCTION: Claude key is server-side, not passed from client
            })
        });
        
        if (!r.ok) {
            throw new Error(`HTTP ${r.status}: ${r.statusText}`);
        }
        
        const d = await r.json();
        
        // Schema validation
        if (!d.success) {
            throw new Error(d.error || 'Proposal service returned success=false');
        }
        if (!d.proposal || typeof d.proposal !== 'string') {
            throw new Error('Invalid response schema: missing proposal content');
        }
        
        currentProposal = d.proposal;
        
        // Build the preview HTML
        let previewHtml = `
            <div style="background: rgba(154,205,50,0.1); border: 1px solid var(--green); border-radius: 6px; padding: 0.75rem; margin-bottom: 1rem;">
                <strong style="color: var(--green);">‚úÖ Backend Generated</strong>
                <span style="font-size: 0.75rem; color: var(--gray); margin-left: 0.5rem;">Request ID: ${requestId}</span>
            </div>
        `;
        
        // Show context used (if any)
        if (d.contextUsed && d.contextUsed.length > 0) {
            previewHtml += `<div class="context-summary">
                <strong>üìö Context Used:</strong> ${d.contextUsed.join(' ‚Ä¢ ')}
            </div>`;
        }
        
        // Show the proposal
        previewHtml += mdToHtml(d.proposal);
        
        // Show compliance checklist (if any)
        if (d.complianceChecklist && d.complianceChecklist.length > 0) {
            previewHtml += `<div class="compliance-checklist">
                <h3>‚úÖ Compliance Checklist</h3>
                <ul>${d.complianceChecklist.map(c => 
                    `<li>${c.status} ${c.item}</li>`
                ).join('')}</ul>
            </div>`;
        }
        
        // Show generation info
        if (d.method === 'claude-ai') {
            previewHtml += `<div class="gen-info">
                <small>Generated with Claude AI ‚Ä¢ Tokens: ${d.tokensUsed?.input || 0} in / ${d.tokensUsed?.output || 0} out ‚Ä¢ Est. cost: ${d.estimatedCost || 'N/A'}</small>
            </div>`;
        }
        
        const previewElement = document.getElementById('proposalPreview');
        const outputElement = document.getElementById('proposalOutput');
        const downloadWord = document.getElementById('downloadWordBtn');
        const downloadTxt = document.getElementById('downloadTxtBtn');
        
        if (previewElement) previewElement.innerHTML = previewHtml;
        if (outputElement) outputElement.style.display = 'block';
        if (downloadWord) downloadWord.disabled = false;
        if (downloadTxt) downloadTxt.disabled = false;
        
        hideLoading();
        log(`Proposal generated (${d.method || 'backend'})${d.estimatedCost ? ' - ' + d.estimatedCost : ''}`, 'success');
        
    } catch (e) {
        proposalController = null;
        hideLoading();
        
        log(`HARD FAILURE: Proposal generation failed - ${e.message}`, 'error');
        
        // Show hard error in output area
        const errorHtml = showHardError(
            'AI Proposal Generator',
            backendUrl,
            e.message,
            'Proposal generation requires live backend with Claude API.',
            requestId
        );
        
        const errorPreview = document.getElementById('proposalPreview');
        const errorOutput = document.getElementById('proposalOutput');
        const errorDownloadWord = document.getElementById('downloadWordBtn');
        const errorDownloadTxt = document.getElementById('downloadTxtBtn');
        
        if (errorPreview) errorPreview.innerHTML = errorHtml;
        if (errorOutput) errorOutput.style.display = 'block';
        if (errorDownloadWord) errorDownloadWord.disabled = true;
        if (errorDownloadTxt) errorDownloadTxt.disabled = true;
        
        // Also show alert
        alert(`PROPOSAL BLOCKED\n\nEndpoint: ${backendUrl}\nError: ${e.message}\nRequest ID: ${requestId}\n\nProposal generation requires live backend service.`);
    }
}

async function downloadProposal() {
    const select = document.getElementById('oppSelect');
    if (!select || !select.value) { alert('Select an opportunity first'); return; }
    
    const opp = opportunities.find(o => o.id === select.value || o.noticeId === select.value);
    if (!opp) { alert('Opportunity not found'); return; }
    
    if (!currentProposal) {
        alert('Please generate a proposal first');
        return;
    }
    
    log('Creating Word document...', 'info');
    
    const html = `
        <html xmlns:o="urn:schemas-microsoft-com:office:office" 
              xmlns:w="urn:schemas-microsoft-com:office:word"
              xmlns="http://www.w3.org/TR/REC-html40">
        <head>
            <meta charset="utf-8">
            <title>Singh Automation Proposal</title>
            <style>
                body { font-family: Arial, sans-serif; font-size: 11pt; line-height: 1.6; margin: 1in; }
                h1 { color: #1B4F72; font-size: 18pt; border-bottom: 2px solid #1B4F72; padding-bottom: 5pt; margin-top: 24pt; }
                h2 { color: #2E86AB; font-size: 14pt; margin-top: 18pt; }
                h3 { color: #333; font-size: 12pt; margin-top: 12pt; }
                table { border-collapse: collapse; width: 100%; margin: 12pt 0; }
                th, td { border: 1px solid #ccc; padding: 8pt; text-align: left; }
                th { background-color: #1B4F72; color: white; }
                ul, ol { margin-left: 20pt; }
                p { margin: 6pt 0; }
            </style>
        </head>
        <body>${mdToHtml(currentProposal)}</body>
        </html>
    `;
    const blob = new Blob([html], { type: 'application/msword' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Singh_Proposal_${opp.title.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30)}.doc`;
    a.click();
    log('Word document downloaded!', 'success');
}

// Download TXT
function downloadTXT() {
    if (!currentProposal) {
        alert('Please generate a proposal first');
        return;
    }
    
    const select = document.getElementById('oppSelect');
    const opp = opportunities.find(o => o.id === select.value || o.noticeId === select.value);
    const filename = opp ? opp.title.replace(/[^a-zA-Z0-9]/g, '_').substring(0, 30) : 'Proposal';
    
    const blob = new Blob([currentProposal], { type: 'text/plain' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `Singh_Proposal_${filename}.txt`;
    a.click();
    log('TXT file downloaded!', 'success');
}

function mdToHtml(md) {
    return md
        .replace(/^### (.*)$/gm, '<h3>$1</h3>')
        .replace(/^## (.*)$/gm, '<h2>$1</h2>')
        .replace(/^# (.*)$/gm, '<h1>$1</h1>')
        .replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>')
        .replace(/^\| (.+) \|$/gm, (match, content) => {
            const cells = content.split(' | ').map(c => `<td>${c.trim()}</td>`).join('');
            return `<tr>${cells}</tr>`;
        })
        .replace(/^\|[-\s|]+\|$/gm, '') // Remove table separator lines
        .replace(/(<tr>[\s\S]*?<\/tr>)+/g, '<table border="1">$&</table>')
        .replace(/^- (.+)$/gm, '<li>$1</li>')
        .replace(/(<li>[\s\S]*?<\/li>)+/g, '<ul>$&</ul>')
        .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
        .replace(/\n\n/g, '</p><p>')
        .replace(/^---$/gm, '<hr>')
        .replace(/\n/g, '<br>');
}

// ========== SETTINGS ==========
// PRODUCTION: loadSettings - only non-secret user preferences
function loadSettings() {
    try {
        // PRODUCTION: API/Claude keys are NOT stored in localStorage
        // Keys must be provided by server-side configuration
        
        const revenueGoal = localStorage.getItem('revenueGoal');
        const winRate = localStorage.getItem('winRate');
        
        if (revenueGoal) document.getElementById('revenueGoal').value = revenueGoal;
        if (winRate) document.getElementById('winRate').value = winRate;
        
        // Only persist non-secret settings
        document.getElementById('revenueGoal')?.addEventListener('change', function() {
            safeStorage('revenueGoal', this.value);
        });
        document.getElementById('winRate')?.addEventListener('change', function() {
            safeStorage('winRate', this.value);
        });
    } catch (e) {
        console.warn('localStorage unavailable:', e);
        log('Settings persistence unavailable', 'info');
    }
}

// Safe localStorage wrapper
function safeStorage(key, value) {
    // PRODUCTION: Block storage of secrets
    const blockedKeys = ['claudeKey', 'apiKey', 'token', 'secret', 'password'];
    if (blockedKeys.some(k => key.toLowerCase().includes(k))) {
        console.warn('BLOCKED: Attempted to store secret in localStorage:', key);
        return false;
    }
    
    try {
        if (value === null || value === undefined) {
            localStorage.removeItem(key);
        } else if (typeof value === 'object') {
            localStorage.setItem(key, JSON.stringify(value));
        } else {
            localStorage.setItem(key, value);
        }
        return true;
    } catch (e) {
        console.warn('localStorage write failed:', e);
        return false;
    }
}

function safeStorageGet(key, defaultValue = null) {
    try {
        const val = localStorage.getItem(key);
        if (val === null) return defaultValue;
        try { return JSON.parse(val); } catch { return val; }
    } catch (e) {
        console.warn('localStorage read failed:', e);
        return defaultValue;
    }
}

// PRODUCTION: setupKeySync removed - no client-side key management
function setupKeySync() {
    // INTENTIONALLY EMPTY - keys managed server-side in production
    console.log('PRODUCTION: Key sync disabled - keys managed server-side');
}

// ========== EVENTS ==========
document.addEventListener('click', e => {
    if (e.target.classList.contains('nav-btn')) {
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        e.target.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById('page-' + e.target.dataset.page).classList.add('active');
        
        // Render pipeline when switching to that page
        if (e.target.dataset.page === 'pipeline') {
            renderPipelinePage();
        }
    }
    if (e.target.classList.contains('tab') && e.target.dataset.tab) {
        currentTab = e.target.dataset.tab;
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        e.target.classList.add('active');
        renderOpps();
    }
    if (e.target.classList.contains('filter-pill') && e.target.dataset.filter) {
        currentFilter = e.target.dataset.filter;
        document.querySelectorAll('.filter-pill[data-filter]').forEach(p => p.classList.remove('active'));
        e.target.classList.add('active');
        renderOpps();
    }
    if (e.target.closest('.opp-card')) {
        const card = e.target.closest('.opp-card');
        if (card.dataset.id) showDetail(card.dataset.id);
    }
});

document.getElementById('searchInput')?.addEventListener('keyup', renderOpps);

// ========== SUBCONTRACTING ==========
let subOpportunities = [];
let currentSubFilter = 'all';

// ========== PURCHASING PAGE ==========
let purchasingOpportunities = [];
let currentPurchFilter = 'all';

async function loadPurchasing() {
    const list = document.getElementById('purchasingList');
    list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><div class="spinner"></div><p>Analyzing opportunities...</p></div>';
    
    // If no opportunities loaded, scan first
    if (opportunities.length === 0) {
        await scanAll();
    }
    
    // Analyze all opportunities for purchasing eligibility
    purchasingOpportunities = opportunities.map(o => ({
        ...o,
        purchasing: analyzePurchasingEligibility(o)
    })).filter(o => o.purchasing.eligible);
    
    // Sort by match score
    purchasingOpportunities.sort((a, b) => b.matchScore - a.matchScore);
    
    updatePurchasingStats();
    renderPurchasing();
}

function updatePurchasingStats() {
    const total = purchasingOpportunities.length;
    const plc = purchasingOpportunities.filter(o => o.purchasing.category === 'PLC/Controls').length;
    const robotics = purchasingOpportunities.filter(o => o.purchasing.category === 'Robotics').length;
    const vision = purchasingOpportunities.filter(o => o.purchasing.category === 'Vision/Sensors').length;
    const motion = purchasingOpportunities.filter(o => o.purchasing.category === 'Motion/VFD').length;
    
    document.getElementById('purchTotal').textContent = total;
    document.getElementById('purchPLC').textContent = plc;
    document.getElementById('purchRobotics').textContent = robotics;
    document.getElementById('purchVision').textContent = vision;
    document.getElementById('purchMotion').textContent = motion;
}

function filterPurchasing(filter, btn) {
    currentPurchFilter = filter;
    document.querySelectorAll('[data-purchfilter]').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    renderPurchasing();
}

function renderPurchasing() {
    const list = document.getElementById('purchasingList');
    
    let filtered = purchasingOpportunities;
    if (currentPurchFilter !== 'all') {
        filtered = purchasingOpportunities.filter(o => o.purchasing.category === currentPurchFilter);
    }
    
    if (filtered.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><p>No opportunities found for this category</p></div>';
        return;
    }
    
    list.innerHTML = filtered.map(o => {
        const catColors = {
            'PLC/Controls': { bg: 'rgba(59,130,246,0.2)', color: '#60a5fa' },
            'Robotics': { bg: 'rgba(139,92,246,0.2)', color: '#a78bfa' },
            'Vision/Sensors': { bg: 'rgba(16,185,129,0.2)', color: '#34d399' },
            'Motion/VFD': { bg: 'rgba(245,158,11,0.2)', color: '#fbbf24' },
            'Mixed': { bg: 'rgba(154,205,50,0.2)', color: 'var(--green)' },
            'Unknown': { bg: 'rgba(100,100,100,0.2)', color: '#888' }
        };
        const catStyle = catColors[o.purchasing.category] || catColors['Unknown'];
        const scoreClass = o.matchScore >= 70 ? '' : o.matchScore >= 50 ? 'medium' : 'low';
        
        return `
        <div class="opp-card qualified" data-id="${o.id}">
            <div class="opp-header">
                <div class="opp-title">${o.title}</div>
                <div class="match-score ${scoreClass}">${o.matchScore}%</div>
            </div>
            <div class="opp-meta">
                <span>üèõÔ∏è ${(o.agency||'Agency').substring(0,35)}</span>
                <span>üí∞ ${fmtCurrency(o.value)}</span>
                <span>üìÖ ${fmtDate(o.closeDate)}</span>
            </div>
            <div class="opp-desc">${(o.description||'').substring(0,120)}...</div>
            <div style="display: flex; gap: 0.5rem; align-items: center; margin-top: 0.5rem; flex-wrap: wrap;">
                <span style="background: ${catStyle.bg}; color: ${catStyle.color}; padding: 0.2rem 0.6rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                    üõí ${o.purchasing.category}
                </span>
                <span style="font-size: 0.7rem; color: var(--gray);">${o.purchasing.reason}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                ${o.link ? `<a href="${o.link}" target="_blank" rel="noopener noreferrer" style="font-size: 0.7rem; color: var(--green);">View Source ‚Üí</a>` : '<span style="font-size: 0.7rem; color: var(--gray);">No direct link</span>'}
                ${o.matchScore >= 65 ? `<button class="btn btn-sm btn-quote" onclick="event.stopPropagation(); openQuoteRequest('${o.id}')">üìã Request Quote</button>` : ''}
            </div>
        </div>
        `;
    }).join('');
}

async function loadSubcontracting() {
    const list = document.getElementById('subList');
    list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><div class="loading-spinner"></div><p>Loading opportunities...</p></div>';
    
    try {
        const response = await fetch('/api/subcontracting');
        if (response.ok) {
            const data = await response.json();
            if (data.success && data.opportunities?.length > 0) {
                subOpportunities = data.opportunities;
                document.getElementById('subSource').innerHTML = 'üü¢ Live';
                document.getElementById('subSource').style.color = 'var(--green)';
                renderSubOpportunities();
                return;
            }
        }
    } catch(e) {
        console.log('Subcontracting API unavailable, using demo');
    }
    
    // Fallback to demo data
    subOpportunities = getSubDemoData();
    document.getElementById('subSource').innerHTML = 'üìä Demo';
    document.getElementById('subSource').style.color = 'var(--orange)';
    renderSubOpportunities();
}

function getSubDemoData() {
    return [
        { id: 'SUB-001', prime: 'Turner Construction', award_amount: 8200000, agency: 'Army Corps of Engineers', description: 'Military base modernization with automated material handling systems', location: 'Fort Liberty, NC', naics: '236220', match_score: 87, tier: 'hot', signals: ['automation scope', 'material handling', 'DoD prime'], contact: { email: 'subcontracting@turnerconstruction.com', portal: 'https://www.turnerconstruction.com/subcontractors' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_W912DY24C0001' },
        { id: 'SUB-002', prime: 'Hensel Phelps', award_amount: 12400000, agency: 'Department of Veterans Affairs', description: 'VA hospital renovation including robotic pharmacy and logistics systems', location: 'San Diego, CA', naics: '236220', match_score: 84, tier: 'hot', signals: ['robotic pharmacy', 'logistics automation', 'healthcare'], contact: { email: 'suppliers@henselphelps.com', portal: 'https://www.henselphelps.com/subcontractors/' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_36C24624C0002' },
        { id: 'SUB-003', prime: 'Clark Construction', award_amount: 6800000, agency: 'GSA', description: 'Federal building upgrade with smart building automation', location: 'Chicago, IL', naics: '236220', match_score: 78, tier: 'hot', signals: ['building automation', 'smart systems', 'controls'], contact: { email: 'subcontractors@clarkconstruction.com', portal: 'https://www.clarkconstruction.com/subcontractors' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_GS09P24BTC0003' },
        { id: 'SUB-004', prime: 'Leidos', award_amount: 5700000, agency: 'DoD', description: 'Defense logistics automation and AI systems integration', location: 'Huntsville, AL', naics: '541512', match_score: 62, tier: 'warm', signals: ['AI integration', 'logistics', 'defense'], contact: { email: 'small.business@leidos.com', portal: 'https://www.leidos.com/suppliers' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_W58RGZ24C0004' },
        { id: 'SUB-005', prime: 'Jacobs Engineering', award_amount: 4800000, agency: 'NASA', description: 'Facility systems integration for launch complex', location: 'Cape Canaveral, FL', naics: '541330', match_score: 58, tier: 'warm', signals: ['systems integration', 'NASA', 'facility automation'], contact: { email: 'supplier.diversity@jacobs.com', portal: 'https://www.jacobs.com/suppliers' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_NNK24MA0005' },
        { id: 'SUB-006', prime: 'KBR Inc', award_amount: 6100000, agency: 'Army', description: 'Base infrastructure modernization project', location: 'Fort Hood, TX', naics: '541330', match_score: 55, tier: 'warm', signals: ['infrastructure', 'modernization', 'DoD'], contact: { email: 'supplierdiversity@kbr.com', portal: 'https://www.kbr.com/en/about-us/suppliers' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_W911KB24C0006' },
        { id: 'SUB-007', prime: 'AECOM', award_amount: 3200000, agency: 'Air Force', description: 'Hangar facility improvements', location: 'Edwards AFB, CA', naics: '236220', match_score: 42, tier: 'cold', signals: ['facility', 'Air Force'], contact: { email: 'suppliers@aecom.com', portal: 'https://aecom.com/about-aecom/suppliers/' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_FA930824C0007' },
        { id: 'SUB-008', prime: 'Parsons Corporation', award_amount: 5200000, agency: 'DHS', description: 'Border security technology systems', location: 'El Paso, TX', naics: '541512', match_score: 38, tier: 'cold', signals: ['security systems', 'technology'], contact: { email: 'suppliers@parsons.com', portal: 'https://www.parsons.com/suppliers/' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_HSBP1024C0008' },
        // San Diego Defense Opportunities
        { id: 'SUB-009', prime: 'General Dynamics NASSCO', award_amount: 18500000, agency: 'Navy', description: 'Ship repair and modernization - welding automation, material handling systems', location: 'San Diego, CA', naics: '336611', match_score: 92, tier: 'hot', signals: ['welding automation', 'shipyard', 'Navy', 'material handling'], contact: { email: 'smallbusiness@nassco.com', portal: 'https://www.nassco.com/suppliers' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_N0002424C0009' },
        { id: 'SUB-010', prime: 'General Atomics', award_amount: 7800000, agency: 'Navy', description: 'Unmanned systems manufacturing support - robotic assembly, precision automation', location: 'Poway, CA', naics: '336411', match_score: 85, tier: 'hot', signals: ['robotics', 'precision automation', 'defense manufacturing'], contact: { email: 'small.business@ga.com', portal: 'https://www.ga.com/small-business' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_N0001924C0010' },
        { id: 'SUB-011', prime: 'BAE Systems San Diego Ship Repair', award_amount: 9200000, agency: 'Navy', description: 'Destroyer maintenance and repair - automated welding, robotic inspection', location: 'San Diego, CA', naics: '336611', match_score: 88, tier: 'hot', signals: ['welding', 'ship repair', 'robotic inspection', 'Navy'], contact: { email: 'supplier.management@baesystems.com', portal: 'https://www.baesystems.com/en/our-company/about-us/suppliers' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_N0002424C0011' },
        { id: 'SUB-012', prime: 'NAVWAR/SPAWAR', award_amount: 4500000, agency: 'Navy', description: 'Command and control systems integration - PLC/SCADA, industrial controls', location: 'San Diego, CA', naics: '541512', match_score: 72, tier: 'warm', signals: ['SCADA', 'controls integration', 'Navy C2'], contact: { email: 'navwar.smallbusiness@navy.mil', portal: 'https://www.navwar.navy.mil/OSBP/' }, contract_link: 'https://usaspending.gov/award/CONT_AWD_N6600124C0012' }
    ];
}

function renderSubOpportunities() {
    const list = document.getElementById('subList');
    let filtered = subOpportunities;
    
    if (currentSubFilter !== 'all') {
        filtered = subOpportunities.filter(o => (o.tier || o.priority || 'warm') === currentSubFilter);
    }
    
    if (filtered.length === 0) {
        list.innerHTML = '<div style="text-align: center; padding: 2rem; color: var(--gray);"><p>No opportunities found</p></div>';
        return;
    }
    
    list.innerHTML = filtered.map(opp => {
        // Normalize field names - handle both API formats
        const prime = opp.prime || opp.recipient_name || opp.recipientName || opp.prime_contractor || opp.Recipient_Name || 'Unknown Prime';
        const amount = opp.award_amount || opp.awardAmount || opp.Award_Amount || opp.total_obligation || opp.amount || 0;
        const agency = opp.agency || opp.awarding_agency || opp.Awarding_Agency || opp.funding_agency || 'Federal Agency';
        const desc = opp.description || opp.Description || opp.award_description || 'Contract award - potential subcontracting opportunity';
        const loc = opp.location || opp.place_of_performance || opp.recipient_location || opp.Place_of_Performance || '';
        const naicsCode = opp.naics || opp.naics_code || opp.naicsCode || opp.NAICS || opp.naics_description || '';
        const score = opp.match_score || opp.score || opp.relevance_score || 75;
        const tier = opp.tier || opp.priority || (score >= 70 ? 'hot' : score >= 50 ? 'warm' : 'cold');
        const signals = opp.signals || opp.keywords || opp.tags || ['federal contract'];
        const contractLink = opp.contract_link || opp.usaspending_link || opp.usaSpendingUrl || opp.award_link || (opp.generated_internal_id ? `https://usaspending.gov/award/${opp.generated_internal_id}` : 'https://usaspending.gov');
        const contactEmail = opp.contact?.email || opp.email || '';
        
        const tierClass = tier === 'hot' ? 'background: var(--red);' : tier === 'warm' ? 'background: var(--orange);' : 'background: var(--gray);';
        const tierColor = tier === 'hot' || tier === 'cold' ? 'color: #fff;' : 'color: #000;';
        const amountDisplay = amount >= 1000000 ? `$${(amount / 1000000).toFixed(1)}M` : `$${(amount / 1000).toFixed(0)}K`;
        
        return `
        <div class="opp-card qualified">
            <div class="opp-header">
                <div class="opp-title">${prime}</div>
                <div class="opp-type" style="position: absolute; right: 0.75rem; top: 0.75rem; ${tierClass} ${tierColor}">
                    ${score}%
                </div>
            </div>
            <div class="opp-meta">
                <span>üèõÔ∏è ${agency}</span>
                <span>üí∞ ${amountDisplay}</span>
                <span>üìç ${loc || 'USA'}</span>
                <span>üìã ${naicsCode || 'N/A'}</span>
            </div>
            <div class="opp-desc">${desc}</div>
            <div class="opp-tags">
                <span class="tag" style="${tierClass} ${tierColor}">${tier.toUpperCase()}</span>
                ${Array.isArray(signals) ? signals.slice(0,4).map(s => `<span class="tag">${s}</span>`).join('') : `<span class="tag">${signals}</span>`}
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem; padding-top: 0.5rem; border-top: 1px solid var(--border);">
                <a href="${contractLink}" target="_blank" rel="noopener noreferrer" style="font-size: 0.7rem; color: var(--green);">View on USASpending ‚Üí</a>
                <button class="btn btn-sm btn-primary" onclick="showSubOutreach(${subOpportunities.indexOf(opp)})">üìß Draft Outreach</button>
            </div>
        </div>
        `;
    }).join('');
}

function filterSubs(filter, btn) {
    currentSubFilter = filter;
    document.querySelectorAll('[data-subfilter]').forEach(el => el.classList.remove('active'));
    btn.classList.add('active');
    renderSubOpportunities();
}

function showSubOutreach(idx) {
    const opp = subOpportunities[idx];
    
    // Normalize field names
    const prime = opp.prime || opp.recipient_name || opp.recipientName || opp.prime_contractor || 'Prime Contractor';
    const agency = opp.agency || opp.awarding_agency || opp.funding_agency || 'Federal Agency';
    const desc = opp.description || opp.award_description || 'federal contract';
    
    // Known prime contractor contact database
    const primeContacts = {
        'turner construction': { email: 'subcontracting@turnerconstruction.com', portal: 'https://www.turnerconstruction.com/subcontractors' },
        'hensel phelps': { email: 'suppliers@henselphelps.com', portal: 'https://www.henselphelps.com/subcontractors/' },
        'clark construction': { email: 'subcontractors@clarkconstruction.com', portal: 'https://www.clarkconstruction.com/subcontractors' },
        'leidos': { email: 'small.business@leidos.com', portal: 'https://www.leidos.com/suppliers' },
        'jacobs': { email: 'supplier.diversity@jacobs.com', portal: 'https://www.jacobs.com/suppliers' },
        'jacobs engineering': { email: 'supplier.diversity@jacobs.com', portal: 'https://www.jacobs.com/suppliers' },
        'kbr': { email: 'supplierdiversity@kbr.com', portal: 'https://www.kbr.com/en/about-us/suppliers' },
        'kbr inc': { email: 'supplierdiversity@kbr.com', portal: 'https://www.kbr.com/en/about-us/suppliers' },
        'aecom': { email: 'suppliers@aecom.com', portal: 'https://aecom.com/about-aecom/suppliers/' },
        'parsons': { email: 'suppliers@parsons.com', portal: 'https://www.parsons.com/suppliers/' },
        'parsons corporation': { email: 'suppliers@parsons.com', portal: 'https://www.parsons.com/suppliers/' },
        'lockheed martin': { email: 'suppliers@lmco.com', portal: 'https://www.lockheedmartin.com/en-us/suppliers.html' },
        'northrop grumman': { email: 'supplierdiversity@ngc.com', portal: 'https://www.northropgrumman.com/suppliers/' },
        'raytheon': { email: 'smallbusiness@rtx.com', portal: 'https://www.rtx.com/suppliers' },
        'general dynamics': { email: 'suppliers@gd.com', portal: 'https://www.gd.com/suppliers' },
        'bae systems': { email: 'supplier.management@baesystems.com', portal: 'https://www.baesystems.com/en/our-company/about-us/suppliers' },
        'booz allen': { email: 'supplierdiversity@bah.com', portal: 'https://www.boozallen.com/about/supplier-diversity.html' },
        'booz allen hamilton': { email: 'supplierdiversity@bah.com', portal: 'https://www.boozallen.com/about/supplier-diversity.html' },
        'saic': { email: 'small.business@saic.com', portal: 'https://www.saic.com/who-we-are/suppliers' },
        'caci': { email: 'subcontracts@caci.com', portal: 'https://www.caci.com/teaming' },
        'peraton': { email: 'smallbusiness@peraton.com', portal: 'https://www.peraton.com/suppliers/' },
        // San Diego Defense Contractors
        'general atomics': { email: 'small.business@ga.com', portal: 'https://www.ga.com/small-business' },
        'general atomics aeronautical': { email: 'small.business@ga.com', portal: 'https://www.ga.com/small-business' },
        'ga-asi': { email: 'small.business@ga.com', portal: 'https://www.ga.com/small-business' },
        'cubic': { email: 'suppliers@cubic.com', portal: 'https://www.cubic.com/suppliers' },
        'cubic corporation': { email: 'suppliers@cubic.com', portal: 'https://www.cubic.com/suppliers' },
        'viasat': { email: 'supplier.diversity@viasat.com', portal: 'https://www.viasat.com/about/suppliers/' },
        'kratos': { email: 'subcontracts@kratosdefense.com', portal: 'https://www.kratosdefense.com/about/suppliers' },
        'kratos defense': { email: 'subcontracts@kratosdefense.com', portal: 'https://www.kratosdefense.com/about/suppliers' },
        'spawar': { email: 'navwar.smallbusiness@navy.mil', portal: 'https://www.navwar.navy.mil/OSBP/' },
        'navwar': { email: 'navwar.smallbusiness@navy.mil', portal: 'https://www.navwar.navy.mil/OSBP/' },
        'nassco': { email: 'smallbusiness@nassco.com', portal: 'https://www.nassco.com/suppliers' },
        'general dynamics nassco': { email: 'smallbusiness@nassco.com', portal: 'https://www.nassco.com/suppliers' },
        'bae systems san diego': { email: 'supplier.management@baesystems.com', portal: 'https://www.baesystems.com/en/our-company/about-us/suppliers' },
        'l3harris san diego': { email: 'supplierdiversity@l3harris.com', portal: 'https://www.l3harris.com/company/suppliers' },
        'fluor': { email: 'supplier.diversity@fluor.com', portal: 'https://www.fluor.com/sustainability/community/supplier-diversity' },
        'bechtel': { email: 'supplierdiversity@bechtel.com', portal: 'https://www.bechtel.com/suppliers/' },
        'skanska': { email: 'subcontractors@skanska.com', portal: 'https://www.usa.skanska.com/subcontractors/' },
        'mortenson': { email: 'supplier.diversity@mortenson.com', portal: 'https://www.mortenson.com/subcontractors' },
        'whiting-turner': { email: 'subcontractors@whiting-turner.com', portal: 'https://www.whiting-turner.com/subcontractors/' },
        'mccarthy': { email: 'subcontractors@mccarthy.com', portal: 'https://www.mccarthy.com/subcontractors' },
        'balfour beatty': { email: 'suppliers@balfourbeattyus.com', portal: 'https://www.balfourbeattyus.com/suppliers' },
        'granite construction': { email: 'supplierdiversity@gfrainc.com', portal: 'https://www.graniteconstruction.com/suppliers' },
        'accenture': { email: 'supplier.inclusion@accenture.com', portal: 'https://www.accenture.com/us-en/about/company/supplier-inclusion-diversity' },
        'deloitte': { email: 'supplierdiversity@deloitte.com', portal: 'https://www2.deloitte.com/us/en/pages/about-deloitte/articles/supplier-diversity.html' },
        'ibm': { email: 'supplierdiversity@us.ibm.com', portal: 'https://www.ibm.com/impact/be-equal/supplier-diversity' },
        'microsoft': { email: 'msdiversity@microsoft.com', portal: 'https://www.microsoft.com/en-us/procurement/supplier-diversity' }
    };
    
    // Look up contact or generate guess
    const primeLower = prime.toLowerCase().trim();
    let contactEmail = opp.contact?.email || opp.email || '';
    let portalUrl = opp.contact?.portal || '';
    
    // Check known database
    for (const [key, value] of Object.entries(primeContacts)) {
        if (primeLower.includes(key) || key.includes(primeLower.split(' ')[0].toLowerCase())) {
            contactEmail = contactEmail || value.email;
            portalUrl = portalUrl || value.portal;
            break;
        }
    }
    
    // If still no email, generate educated guess
    if (!contactEmail && prime !== 'Prime Contractor') {
        const companySlug = prime.toLowerCase()
            .replace(/,?\s*(llc|inc|corp|corporation|company|co|ltd|group)\.?$/i, '')
            .trim()
            .replace(/\s+/g, '');
        contactEmail = `subcontracting@${companySlug}.com`;
    }
    
    const email = generateSubEmail({ prime, agency, description: desc });
    
    // Create modal for outreach
    const modal = document.createElement('div');
    modal.id = 'outreachModal';
    modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1000; display: flex; justify-content: center; align-items: center; padding: 1rem;';
    modal.innerHTML = `
        <div class="outreach-content" style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; width: 100%; max-width: 600px; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-bottom: 1px solid var(--border);">
                <h3 style="font-size: 1rem;">üìß Outreach to ${prime}</h3>
                <button class="close-outreach-btn" style="background: none; border: none; color: var(--gray); font-size: 1.5rem; cursor: pointer; padding: 0.25rem 0.5rem;">&times;</button>
            </div>
            <div style="padding: 1rem;">
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">To: ${!opp.contact?.email ? '<span style="color: var(--orange);">(estimated - verify before sending)</span>' : ''}</label>
                    <input type="text" id="outreachTo" value="${contactEmail}" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                    ${portalUrl ? `<a href="${portalUrl}" target="_blank" style="font-size: 0.7rem; color: var(--blue); margin-top: 0.25rem; display: inline-block;">üîó Supplier Portal</a>` : '<span style="font-size: 0.7rem; color: var(--gray); margin-top: 0.25rem; display: inline-block;">üí° Tip: Search "[Company] supplier portal" to find official contact</span>'}
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">Subject:</label>
                    <input type="text" id="outreachSubject" value="Singh Automation - Subcontracting Inquiry: ${agency} Project" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                </div>
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; font-size: 0.75rem; color: var(--gray); margin-bottom: 0.25rem;">Body:</label>
                    <textarea id="outreachBody" style="width: 100%; min-height: 280px; padding: 0.75rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff; font-family: inherit; line-height: 1.5; resize: vertical;">${email}</textarea>
                </div>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end; padding: 1rem; border-top: 1px solid var(--border);">
                <button class="btn btn-secondary close-outreach-btn">Close</button>
                <button class="btn btn-sm" style="background: linear-gradient(135deg, var(--green), #2E86AB); color: #fff;" onclick="askAgentAboutOutreach(${idx})">ü§ñ Ask Agent_SAM</button>
                <button class="btn btn-secondary" onclick="copyOutreachEmail()">üìã Copy</button>
                <button class="btn btn-primary" onclick="openOutreachEmail()">üìß Open in Email</button>
            </div>
        </div>
    `;
    
    // Close handlers
    modal.querySelectorAll('.close-outreach-btn').forEach(btn => {
        btn.addEventListener('click', () => modal.remove());
    });
    modal.addEventListener('click', (e) => {
        if (e.target === modal) modal.remove();
    });
    
    document.body.appendChild(modal);
}

function generateSubEmail(opp) {
    return `Dear ${opp.prime} Team,

I noticed your company was recently awarded a contract with ${opp.agency} involving ${opp.description.toLowerCase()}.

Singh Automation is a FANUC and Universal Robots authorized integrator specializing in industrial robotics and automation systems. If your team needs support executing the robotics, automation, or vision systems portion of this contract, we'd welcome the opportunity to discuss teaming.

Our qualifications:
‚Ä¢ FANUC Authorized System Integrator (ASI)
‚Ä¢ Universal Robots Certified System Partner (CSP)
‚Ä¢ CAGE Code: 86VF7 | UEI: GJ1DPYQ3X8K5
‚Ä¢ Certified Small Business, MBE, WBENC
‚Ä¢ NAICS: 333249, 541330, 541512, 541715

We have facilities in both Michigan and California and can mobilize quickly for projects nationwide.

Would you be available for a brief call this week to explore potential collaboration?

Best regards,

Singh Automation
www.singhautomation.com
(269) 381-6236
2400 E Cork Street, Kalamazoo, MI 49001`;
}

function copyOutreachEmail() {
    const subject = document.getElementById('outreachSubject').value;
    const body = document.getElementById('outreachBody').value;
    navigator.clipboard.writeText(`Subject: ${subject}\n\n${body}`).then(() => alert('Copied to clipboard!'));
}

// Ask Agent_SAM to review/improve outreach email
function askAgentAboutOutreach(idx) {
    const opp = subOpportunities[idx];
    const subject = document.getElementById('outreachSubject').value;
    const body = document.getElementById('outreachBody').value;
    
    // Close the outreach modal
    const modal = document.getElementById('outreachModal');
    if (modal) modal.remove();
    
    // Navigate to Agent_SAM page
    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    document.querySelector('[data-page="agent"]').classList.add('active');
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById('page-agent').classList.add('active');
    
    // Store the outreach context
    window.currentOutreach = { opp, subject, body };
    
    // Ask Agent_SAM to review
    const prime = opp.prime || opp.recipient_name || 'Prime Contractor';
    const question = `Please review and improve this subcontracting outreach email to ${prime}:

SUBJECT: ${subject}

BODY:
${body}

---
Give me specific suggestions to make this more compelling and increase response rate. Also suggest any personalization based on their contract.`;
    
    document.getElementById('agentInput').value = question;
    setTimeout(() => sendToAgent(), 300);
}

// Rewrite outreach with Agent_SAM suggestions
function rewriteOutreach(newBody) {
    // Navigate back to subcontracting and update the email
    if (window.currentOutreach) {
        addAgentMessage(`‚úÖ I've prepared an improved version. Copy it above or click the Subcontracting tab to draft a new outreach.`, 'agent');
    }
}

function openOutreachEmail() {
    const to = document.getElementById('outreachTo').value;
    const subject = encodeURIComponent(document.getElementById('outreachSubject').value);
    const body = encodeURIComponent(document.getElementById('outreachBody').value);
    window.open(`mailto:${to}?subject=${subject}&body=${body}`, '_blank');
}

// ========== EMAIL ALERTS ==========
async function testDigest() {
    const statusEl = document.getElementById('digestStatus');
    statusEl.innerHTML = '<span style="color: var(--blue);">‚è≥ Triggering digest...</span>';
    
    try {
        const r = await fetch(BACKEND_BASE + '/api/cron/daily-scan', {
            method: 'GET',
            headers: { 'X-Request-ID': crypto.randomUUID() }
        });
        
        const data = await r.json();
        
        if (data.success) {
            statusEl.innerHTML = `<span style="color: var(--green);">‚úÖ Digest sent! ${data.stats?.go || 0} GO, ${data.stats?.urgent || 0} urgent</span>`;
            log(`Digest sent: ${data.stats?.go || 0} GO opportunities, ${data.stats?.urgent || 0} urgent`, 'success');
        } else {
            throw new Error(data.error || 'Unknown error');
        }
    } catch (e) {
        statusEl.innerHTML = `<span style="color: var(--red);">‚ùå ${e.message}</span>`;
        log('Digest test failed: ' + e.message, 'error');
    }
}

async function subscribeAlerts() {
    const email = document.getElementById('alertEmail').value;
    const frequency = document.getElementById('alertFreq').value;
    
    if (!email || !email.includes('@')) {
        alert('Please enter a valid email address');
        return;
    }
    
    try {
        const backendUrl = document.getElementById('apiUrl').value;
        const r = await fetch(backendUrl, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                email,
                frequency,
                filters: {
                    federal: true,
                    sbir: true,
                    state: true,
                    dibbs: true,
                    minValue: 50000,
                    naicsCodes: ['333249', '333922', '541330', '541512', '541715', '238210']
                }
            })
        });
        const data = await r.json();
        
        if (data.success) {
            log(`‚úÖ Subscribed ${email} for ${frequency} alerts`, 'success');
            alert(`Success! You'll receive ${frequency} alerts at ${email}`);
            document.getElementById('alertEmail').value = '';
        } else {
            throw new Error(data.error);
        }
    } catch (e) {
        log('Email subscription failed: ' + e.message, 'error');
        alert('Subscription failed. Please try again.');
    }
}

// ========== CATEGORY BADGES ==========
function getCategoryBadge(type) {
    const badges = {
        'contract': '<span class="badge" style="background: #1a5f7a;">Federal</span>',
        'sbir': '<span class="badge" style="background: #7b2cbf;">SBIR</span>',
        'grant': '<span class="badge" style="background: #d4a017;">Grant</span>',
        'state': '<span class="badge" style="background: #2d6a4f;">State</span>',
        'dibbs': '<span class="badge" style="background: #9c6644;">DIBBS</span>',
        'forecast': '<span class="badge" style="background: #555;">Forecast</span>'
    };
    return badges[type] || '';
}

function getTypeBadgeColor(type) {
    const colors = {
        'contract': { bg: '#1a5f7a', color: '#fff' },
        'sbir': { bg: '#7b2cbf', color: '#fff' },
        'grant': { bg: '#d4a017', color: '#fff' },
        'state': { bg: '#2d6a4f', color: '#fff' },
        'dibbs': { bg: '#9c6644', color: '#fff' },
        'forecast': { bg: '#555', color: '#ccc' }
    };
    return colors[type] || { bg: '#1a5f7a', color: '#fff' };
}

// ========== DISTRIBUTOR QUOTE REQUEST FEATURE ==========
const QUOTE_AUTOMATION_KEYWORDS = [
    'plc', 'hmi', 'controls', 'controller', 'vfd', 'servo', 'motion', 
    'drive', 'sensor', 'vision', 'camera', 'robot', 'robotic', 'fanuc', 
    'universal robot', 'cobot', 'eoat', 'gripper', 'automation', 
    'conveyor', 'actuator', 'encoder', 'motor', 'pneumatic', 'valve'
];

// ========== PURCHASING ELIGIBILITY ANALYSIS ==========
function analyzePurchasingEligibility(o) {
    const text = ((o.title || '') + ' ' + (o.description || '')).toLowerCase();
    
    // Category keywords - specific equipment terms
    const categories = {
        'PLC/Controls': ['plc', 'hmi', 'scada', 'control panel', 'allen-bradley', 'siemens s7', 'programmable logic', 'controllogix', 'compactlogix'],
        'Robotics': ['robot', 'robotic', 'manipulator', 'cobot', 'fanuc', 'universal robot', 'kuka', 'abb robot', 'yaskawa', 'ur10', 'ur5'],
        'Vision/Sensors': ['vision system', 'camera', 'cognex', 'keyence', 'machine vision', 'barcode scanner', 'optical sensor', 'photoelectric'],
        'Motion/VFD': ['vfd', 'servo', 'variable frequency drive', 'motor drive', 'motion control', 'encoder', 'inverter', 'powerflex'],
        'Safety': ['safety system', 'light curtain', 'e-stop', 'safety relay', 'interlock', 'safety plc', 'pilz'],
        'EOAT': ['eoat', 'gripper', 'end effector', 'tooling', 'end-of-arm', 'vacuum gripper', 'schunk']
    };
    
    // Services-only indicators (stronger detection)
    const servicesOnly = ['consulting', 'advisory', 'study', 'assessment', 'audit', 'training only', 'staffing', 
                          'labor hours', 'professional services', 'support services', 'maintenance contract'];
    
    // Check if services-only
    const isServicesOnly = servicesOnly.some(s => text.includes(s)) && 
                          !['equipment', 'hardware', 'install', 'robot', 'plc', 'sensor', 'system integration'].some(h => text.includes(h));
    
    if (isServicesOnly) {
        return {
            eligible: false,
            category: 'Services Only',
            reason: 'Opportunity appears to be services or consulting only. No hardware component detected.'
        };
    }
    
    // Find matching categories with confidence
    const matchedCategories = [];
    for (const [cat, keywords] of Object.entries(categories)) {
        if (keywords.some(kw => text.includes(kw))) {
            matchedCategories.push(cat);
        }
    }
    
    // Determine category and eligibility
    if (matchedCategories.length === 0) {
        // Check for general automation/hardware terms (lower confidence)
        const generalHardware = ['equipment', 'hardware', 'upgrade', 'replacement', 'automation equipment'];
        const hasGeneralHardware = generalHardware.some(h => text.includes(h));
        
        if (hasGeneralHardware) {
            // Has general terms but no specific category - NEEDS REVIEW
            return {
                eligible: false,  // CONSERVATIVE: Default to NOT eligible
                category: 'Needs Review',
                reason: 'General equipment terms detected but no specific hardware category. Manual review required.'
            };
        }
        
        // No hardware signals at all - NOT eligible
        return {
            eligible: false,
            category: 'Unknown',
            reason: 'No hardware or equipment keywords detected. Does not appear to be a purchasing opportunity.'
        };
    }
    
    // Has specific category matches - ELIGIBLE
    let category, reason;
    if (matchedCategories.length === 1) {
        category = matchedCategories[0];
        reason = `Detected ${category.toLowerCase()} hardware. Specific equipment keywords found.`;
    } else {
        category = 'Mixed';
        reason = `Multiple categories: ${matchedCategories.join(', ')}. May require component breakdown.`;
    }
    
    return {
        eligible: true,
        category,
        reason
    };
}

/**
 * QUOTE ELIGIBILITY - Requires ALL conditions to be met
 * This gates the Request Distributor Quote button
 */
function checkQuoteEligibility(o) {
    // === CONDITION 1: Canonical eligibility must be GO ===
    // Cannot generate quotes for NO-GO or REVIEW opportunities
    if (!o.eligibility || o.eligibility.status !== 'GO') {
        return false;
    }
    
    // Also check canQuote flag from canonical eligibility
    if (o.eligibility.canQuote === false) {
        return false;
    }
    
    // === CONDITION 2: Purchasing eligibility must be true ===
    const purchasing = analyzePurchasingEligibility(o);
    if (!purchasing.eligible) {
        return false;
    }
    
    // === CONDITION 3: Must be pre-award (not post-award notice) ===
    const type = (o.type || o.noticeType || '').toLowerCase();
    if (type.includes('award') && !type.includes('pre')) {
        return false;
    }
    
    // === CONDITION 4: Minimum match score threshold ===
    const score = o.matchScore || o.match_score || 0;
    if (score < 50) {
        return false;
    }
    
    // === CONDITION 5: Has automation/hardware keywords ===
    const text = ((o.title || '') + ' ' + (o.description || '')).toLowerCase();
    const hasAutomation = QUOTE_AUTOMATION_KEYWORDS.some(kw => text.includes(kw));
    if (!hasAutomation) {
        return false;
    }
    
    // All conditions met
    return true;
}

function openQuoteRequest(id) {
    const o = opportunities.find(x => x.id === id);
    if (!o) { alert('Opportunity not found'); return; }
    
    // Close detail modal first
    closeModal();
    
    // Generate quote data
    const quoteData = generateQuoteData(o);
    
    // Show quote modal
    showQuoteModal(o, quoteData);
}

function generateQuoteData(o) {
    const desc = (o.description || '').toLowerCase();
    const title = (o.title || '').toLowerCase();
    const combined = desc + ' ' + title;
    
    // Extract line items with price lookups
    const lineItems = [];
    const keywordMap = {
        'plc': { category: 'plc', classification: 'Distributor-sourcable', classKey: 'dist' },
        'hmi': { category: 'hmi', classification: 'Distributor-sourcable', classKey: 'dist' },
        'vfd': { category: 'vfd', classification: 'Distributor-sourcable', classKey: 'dist' },
        'servo': { category: 'servo', classification: 'Distributor-sourcable', classKey: 'dist' },
        'robot': { category: 'robot', classification: 'Integrator-required', classKey: 'integ' },
        'vision': { category: 'vision', classification: 'Distributor-sourcable', classKey: 'dist' },
        'automation': { category: null, classification: 'Integrator-required', classKey: 'integ' },
        'conveyor': { category: null, classification: 'Integrator-required', classKey: 'integ' },
        'sensor': { category: 'vision', classification: 'Distributor-sourcable', classKey: 'dist' },
        'controller': { category: 'plc', classification: 'Distributor-sourcable', classKey: 'dist' },
        'motor': { category: 'servo', classification: 'Distributor-sourcable', classKey: 'dist' },
        'drive': { category: 'vfd', classification: 'Distributor-sourcable', classKey: 'dist' },
        'fanuc': { category: 'robot', classification: 'Integrator-required', classKey: 'integ' },
        'universal robot': { category: 'robot', classification: 'Integrator-required', classKey: 'integ' },
        'cobot': { category: 'robot', classification: 'Integrator-required', classKey: 'integ' }
    };
    
    Object.entries(keywordMap).forEach(([kw, config]) => {
        if (combined.includes(kw)) {
            // Look up suggested products from catalog
            const catalogItems = config.category ? (PRICE_CATALOG[config.category] || []) : [];
            const suggestedProduct = catalogItems.length > 0 ? catalogItems[0] : null;
            
            // Estimate quantity based on contract value
            const estimatedValue = parseFloat(o.value) || 0;
            let estimatedQty = 'TBD';
            if (suggestedProduct && estimatedValue > 0) {
                const roughQty = Math.max(1, Math.floor(estimatedValue * 0.3 / suggestedProduct.price)); // Assume 30% is material
                estimatedQty = roughQty > 10 ? '~' + roughQty : roughQty.toString();
            }
            
            lineItems.push({
                description: `${kw.toUpperCase()} system/components`,
                quantity: estimatedQty,
                classification: config.classification,
                classKey: config.classKey,
                confidence: suggestedProduct ? 'High' : 'Medium',
                notes: suggestedProduct ? `Suggested: ${suggestedProduct.name}` : 'Verify specific requirements',
                suggestedProduct,
                catalogOptions: catalogItems
            });
        }
    });
    
    // Calculate estimated material cost
    let estimatedMaterialCost = 0;
    lineItems.forEach(item => {
        if (item.suggestedProduct && item.quantity !== 'TBD') {
            const qty = parseInt(item.quantity.replace('~', '')) || 1;
            estimatedMaterialCost += item.suggestedProduct.price * qty;
        }
    });
    
    // Missing fields
    const missingFields = [];
    if (!o.solicitation && !o.noticeId) missingFields.push('Solicitation Number');
    if (!o.closeDate) missingFields.push('Due Date');
    if (!o.placeOfPerformance && !o.location) missingFields.push('Delivery Location');
    if (lineItems.length === 0) missingFields.push('Specific Line Items');
    
    // Confidence score
    let confidence = 50;
    if (lineItems.length > 0) confidence += 20;
    if (missingFields.length <= 2) confidence += 15;
    if (o.closeDate && daysUntil(o.closeDate) > 14) confidence += 10;
    if (estimatedMaterialCost > 0) confidence += 5;
    confidence = Math.min(90, confidence);
    
    return { lineItems, missingFields, confidence, estimatedMaterialCost };
}

function showQuoteModal(o, data) {
    const today = new Date().toISOString().split('T')[0];
    const confLevel = data.confidence >= 70 ? 'High' : data.confidence >= 50 ? 'Medium' : 'Low';
    const confColor = data.confidence >= 70 ? 'var(--green)' : data.confidence >= 50 ? 'var(--orange)' : 'var(--red)';
    
    const rfqDraft = generateRFQDraft(o, data);
    
    const modal = document.createElement('div');
    modal.id = 'quoteRequestModal';
    modal.innerHTML = `
        <div class="quote-modal">
            <div class="quote-modal-header">
                <div>
                    <h2 style="font-size: 1.1rem; color: var(--green); margin: 0;">üìã Distributor Quote Request</h2>
                    <p style="font-size: 0.75rem; color: var(--gray); margin: 0.25rem 0 0 0;">Pre-Award Pricing Validation Draft</p>
                </div>
                <div style="text-align: right;">
                    <div style="font-size: 0.7rem; color: var(--gray);">Fulfillment Confidence</div>
                    <div style="font-size: 1.25rem; font-weight: 700; color: ${confColor};">${data.confidence}% ${confLevel}</div>
                </div>
            </div>
            
            <div class="quote-modal-body">
                <div class="quote-warning">
                    <div style="display: flex; align-items: center; gap: 0.5rem; color: var(--orange); font-weight: 600;">
                        ‚ö†Ô∏è FOR PRICING VALIDATION ONLY
                    </div>
                    <p style="color: #d4a100; margin: 0.5rem 0 0 0; font-size: 0.8rem;">
                        This is a draft RFQ. No purchase order is authorized. Human approval required before sending.
                    </p>
                </div>
                
                <div id="quoteMissingInfo" style="background: rgba(239,68,68,0.1); border: 1px solid var(--red); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem; ${data.missingFields.length === 0 ? 'display: none;' : ''}">
                    <h4 style="color: var(--red); margin: 0 0 0.5rem 0; font-size: 0.85rem;">‚ö†Ô∏è Missing Information</h4>
                    <p id="quoteMissingList" style="color: #fca5a5; margin: 0; font-size: 0.8rem;">${data.missingFields.join(' ‚Ä¢ ')}</p>
                </div>
                
                <div style="background: rgba(59,130,246,0.1); border: 1px solid var(--blue); border-radius: 8px; padding: 0.75rem; margin-bottom: 1rem;">
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                        <div style="flex: 1; min-width: 200px;">
                            <label style="display: block; font-size: 0.7rem; color: var(--blue); margin-bottom: 0.25rem;">üìç Delivery Location <span style="color: var(--gray);">(required)</span></label>
                            <select id="quoteDeliveryLocation" 
                                   style="width: 100%; padding: 0.4rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.75rem;"
                                   onchange="updateRfqDeliveryLocation(this.value)">
                                <option value="">-- Select delivery location --</option>
                                <option value="Singh Automation - Kalamazoo, MI 49001">Singh HQ - Kalamazoo, MI</option>
                                <option value="Singh Automation - Irvine, CA 92618">Singh West - Irvine, CA</option>
                                <option value="Customer site - TBD">Customer Site (TBD)</option>
                                <option value="Government facility - per contract">Gov Facility (per contract)</option>
                            </select>
                            <input type="text" id="quoteDeliveryCustom" placeholder="Or enter custom address..." 
                                   style="width: 100%; padding: 0.4rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.7rem; margin-top: 0.25rem;"
                                   onchange="updateRfqDeliveryLocation(this.value)">
                        </div>
                        <div style="flex: 1; min-width: 150px;">
                            <label style="display: block; font-size: 0.7rem; color: var(--blue); margin-bottom: 0.25rem;">üìÖ Required By <span style="color: var(--gray);">(for quote validity)</span></label>
                            <input type="date" id="quoteRequiredDate" 
                                   min="${new Date().toISOString().split('T')[0]}"
                                   value="${o.closeDate ? new Date(new Date(o.closeDate).getTime() - 14*86400000).toISOString().split('T')[0] : ''}"
                                   style="width: 100%; padding: 0.4rem; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #fff; font-size: 0.75rem;"
                                   onchange="validateAndUpdateDate(this)">
                            <div id="dateWarning" style="font-size: 0.65rem; color: var(--orange); margin-top: 0.25rem; display: none;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="quote-section">
                    <h4 style="color: var(--green); margin: 0 0 0.75rem 0; font-size: 0.85rem;">üì¶ Parsed Line Items</h4>
                    <table class="quote-items-table">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Qty</th>
                                <th>Type</th>
                                <th>Est. Unit Price</th>
                                <th>Suggested Product</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.lineItems.length > 0 
                                ? data.lineItems.map(item => `
                                    <tr>
                                        <td style="color: #ccc;">${item.description}</td>
                                        <td style="color: #ccc;">${item.quantity}</td>
                                        <td><span class="quote-type-badge ${item.classKey}">${item.classification}</span></td>
                                        <td style="color: var(--green);">${item.suggestedProduct ? '$' + item.suggestedProduct.price.toLocaleString() : '--'}</td>
                                        <td style="color: var(--gray); font-size: 0.7rem;">${item.suggestedProduct ? item.suggestedProduct.name : 'Manual lookup required'}</td>
                                    </tr>
                                `).join('')
                                : '<tr><td colspan="5" style="text-align: center; color: var(--gray); padding: 1rem;">No items parsed - manual entry required</td></tr>'
                            }
                        </tbody>
                    </table>
                    ${data.estimatedMaterialCost > 0 ? `
                        <div style="margin-top: 0.75rem; padding: 0.5rem; background: rgba(154,205,50,0.1); border: 1px solid var(--green); border-radius: 4px;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <span style="font-size: 0.75rem; color: var(--gray);">üí∞ Estimated Material Cost:</span>
                                <span style="font-size: 1rem; font-weight: 700; color: var(--green);">$${data.estimatedMaterialCost.toLocaleString()}</span>
                            </div>
                            <div style="font-size: 0.65rem; color: var(--gray); margin-top: 0.25rem;">
                                Based on Singh catalog pricing. Actual costs may vary by quantity and lead time.
                            </div>
                        </div>
                    ` : ''}
                </div>
                
                <div class="quote-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h4 style="color: var(--green); margin: 0; font-size: 0.85rem;">üìù Draft RFQ (Editable)</h4>
                        <button class="btn btn-sm btn-secondary" onclick="copyQuoteRFQ()">üìã Copy</button>
                    </div>
                    <textarea id="quoteRfqText" style="width: 100%; height: 300px; background: #0a0a0a; border: 1px solid var(--border); border-radius: 4px; color: #ccc; font-family: monospace; font-size: 0.75rem; padding: 1rem; resize: vertical;">${rfqDraft}</textarea>
                </div>
            </div>
            
            <div class="quote-modal-footer">
                <p style="color: var(--gray); font-size: 0.65rem; margin: 0; max-width: 55%;">
                    This request is for pre-award pricing validation only. No purchase authorization is implied. Pricing subject to change and government award.
                </p>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="btn btn-secondary" onclick="closeQuoteModal()">Cancel</button>
                    <button class="btn btn-primary" onclick="downloadQuoteRFQ()">üì• Download Draft</button>
                </div>
            </div>
        </div>
    `;
    
    modal.onclick = (e) => { if (e.target === modal) closeQuoteModal(); };
    document.body.appendChild(modal);
}

function generateRFQDraft(o, data) {
    const today = new Date().toISOString().split('T')[0];
    const distItems = data.lineItems.filter(i => i.classification === 'Distributor-sourcable');
    
    return `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
           DISTRIBUTOR RFQ REQUEST - DRAFT
              ‚ö†Ô∏è FOR PRICING VALIDATION ONLY ‚ö†Ô∏è
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

üìã REQUEST INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Request Date:        ${today}
Request Type:        Pre-Award Pricing Validation
Status:              DRAFT - PENDING HUMAN APPROVAL

‚ö†Ô∏è IMPORTANT NOTICE:
This request is for pricing validation only.
No purchase order is authorized.
Pricing subject to government award.

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üì¶ OPPORTUNITY DETAILS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Opportunity ID:      ${o.solicitation || o.noticeId || 'Not specified'}
Title:               ${(o.title || '').substring(0, 80)}
Agency:              ${o.agency || 'Not specified'}
Response Due:        ${o.closeDate ? fmtDate(o.closeDate) : 'Not specified'}
Delivery Location:   ${o.placeOfPerformance || o.location || 'Not specified'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üì¶ IDENTIFIED LINE ITEMS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
${data.lineItems.length > 0 
    ? data.lineItems.map((item, i) => `
Item ${i + 1}: ${item.description}
  Quantity:     ${item.quantity}
  Type:         ${item.classification}
`).join('') 
    : '  No specific items identified - manual review required\n'}

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üìù QUOTE REQUEST TERMS
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
‚Ä¢ Pricing valid for: 30 days from quote date
‚Ä¢ Payment terms: Net 30 (subject to government flow-down)
‚Ä¢ Shipping: FOB Destination
‚Ä¢ Lead time: Please specify for each item

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
üè¢ REQUESTOR INFORMATION
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
Company:         Singh Automation
CAGE Code:       86VF7
UEI:             GJ1DPYQ3X8K5
Contact:         Albert Mizuno
Phone:           786-344-8955
Email:           albert@singhautomation.com

‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
‚ö†Ô∏è REQUIRED FOOTER - DO NOT REMOVE
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
This request is for pre-award pricing validation only. 
No purchase authorization is implied. 
Pricing subject to change and government award.
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê`;
}

function closeQuoteModal() {
    const modal = document.getElementById('quoteRequestModal');
    if (modal) modal.remove();
}

function updateRfqDeliveryLocation(location) {
    const textarea = document.getElementById('quoteRfqText');
    if (!textarea || !location) return;
    
    let text = textarea.value;
    // Update or add delivery location line
    if (text.includes('DELIVERY LOCATION:')) {
        text = text.replace(/DELIVERY LOCATION:.*\n/, `DELIVERY LOCATION: ${location}\n`);
    } else if (text.includes('DELIVERY REQUIREMENTS')) {
        text = text.replace('DELIVERY REQUIREMENTS', `DELIVERY LOCATION: ${location}\n\nDELIVERY REQUIREMENTS`);
    }
    textarea.value = text;
    
    // Clear the other input
    const select = document.getElementById('quoteDeliveryLocation');
    const custom = document.getElementById('quoteDeliveryCustom');
    if (select && custom) {
        if (location && !['Singh Automation', 'Customer site', 'Government facility'].some(p => location.includes(p))) {
            select.value = '';
        } else {
            custom.value = '';
        }
    }
    
    // Update missing info banner
    updateQuoteMissingInfo();
}

function updateQuoteMissingInfo() {
    const missingBanner = document.getElementById('quoteMissingInfo');
    const missingList = document.getElementById('quoteMissingList');
    if (!missingBanner || !missingList) return;
    
    const missingFields = [];
    
    // Check delivery location
    const deliverySelect = document.getElementById('quoteDeliveryLocation');
    const deliveryCustom = document.getElementById('quoteDeliveryCustom');
    const hasDelivery = (deliverySelect && deliverySelect.value) || (deliveryCustom && deliveryCustom.value.trim());
    if (!hasDelivery) missingFields.push('Delivery Location');
    
    // Check required date
    const dateInput = document.getElementById('quoteRequiredDate');
    if (!dateInput || !dateInput.value) missingFields.push('Required By Date');
    
    // Update banner visibility and content
    if (missingFields.length === 0) {
        missingBanner.style.display = 'none';
    } else {
        missingBanner.style.display = 'block';
        missingList.textContent = missingFields.join(' ‚Ä¢ ');
    }
}

function validateAndUpdateDate(input) {
    const dateWarning = document.getElementById('dateWarning');
    const selectedDate = new Date(input.value);
    const today = new Date();
    const daysOut = Math.ceil((selectedDate - today) / 86400000);
    
    // Check for validation issues
    if (daysOut < 0) {
        dateWarning.textContent = '‚ö†Ô∏è Date is in the past';
        dateWarning.style.display = 'block';
        input.style.borderColor = 'var(--red)';
        return;
    } else if (daysOut < 7) {
        dateWarning.textContent = '‚ö†Ô∏è Very short lead time - suppliers may not be able to respond';
        dateWarning.style.display = 'block';
        input.style.borderColor = 'var(--orange)';
    } else if (daysOut < 14) {
        dateWarning.textContent = '‚ÑπÔ∏è Tight timeline - consider allowing more lead time';
        dateWarning.style.display = 'block';
        input.style.borderColor = 'var(--orange)';
    } else {
        dateWarning.style.display = 'none';
        input.style.borderColor = 'var(--border)';
    }
    
    updateRfqRequiredDate(input.value);
    updateQuoteMissingInfo(); // Also update missing info banner
}

function updateRfqRequiredDate(date) {
    const textarea = document.getElementById('quoteRfqText');
    if (!textarea || !date) return;
    
    const formatted = new Date(date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    let text = textarea.value;
    // Update or add required date line
    if (text.includes('REQUIRED BY:')) {
        text = text.replace(/REQUIRED BY:.*\n/, `REQUIRED BY: ${formatted}\n`);
    } else if (text.includes('DELIVERY REQUIREMENTS')) {
        text = text.replace('DELIVERY REQUIREMENTS', `REQUIRED BY: ${formatted}\n\nDELIVERY REQUIREMENTS`);
    }
    textarea.value = text;
}

function copyQuoteRFQ() {
    const textarea = document.getElementById('quoteRfqText');
    if (textarea) {
        textarea.select();
        document.execCommand('copy');
        alert('RFQ draft copied to clipboard!');
    }
}

function downloadQuoteRFQ() {
    const textarea = document.getElementById('quoteRfqText');
    if (!textarea) return;
    
    const content = textarea.value;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    a.href = url;
    a.download = `RFQ_Draft_${new Date().toISOString().split('T')[0]}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    log('RFQ draft downloaded', 'success');
}
// ========== AGENT TRAINING & MEMORY SYSTEM ==========

// Initialize agent memory from localStorage
let agentMemory = {
    pastPerformance: [],
    winThemes: [],
    lessons: [],
    documents: [],
    outcomes: [],
    proposalTemplates: []
};

// Singh's actual proposal template (pre-loaded)
const SINGH_PROPOSAL_TEMPLATE = `TECHNICAL AND MANAGEMENT PROPOSAL
[PROJECT TITLE]
Singh Automation LLC

CAGE: 86VF7 | UEI: GJ1DPYQ3X8K5
Solicitation: [SOLICITATION NUMBER]
Submitted to: [AGENCY]
Date: [DATE]
Estimated Value: [VALUE]

Headquarters: Kalamazoo, Michigan
Sales Office: Irvine, California
Primary Point of Contact: Albert Mizuno
Email: albert@singhautomation.com | Phone: 786-344-8955
Proposal Validity: 90 days unless otherwise stated

---

TABLE OF CONTENTS
1. Executive Summary
2. Technical Approach
3. Management Approach
4. Key Personnel and Staffing
5. Quality Assurance Plan
6. Risk Management Plan
7. Security and Data Handling
8. Past Performance
9. Price Proposal (Separate Volume)
10. Attachments and Certifications

---

1. EXECUTIVE SUMMARY

1.1 Understanding of Requirements
Singh Automation LLC proposes a turnkey [automation/robotics] solution designed to modernize operations, enhance [weld consistency/system reliability], and reduce risks associated with manual [handling/processes] at the [FACILITY NAME]. This proposal demonstrates our comprehensive understanding of the requirements, outlines a technical approach leveraging proven industrial robotics, details a disciplined project management plan, and establishes quality and risk controls to ensure delivery of an on-time, compliant system.

Based on the solicitation and the Performance Work Statement (PWS), the Government requires an automated [robotic welding system/automation system]. The system must integrate with existing facility infrastructure and controls, be installed with minimal operational disruption, and include training, documentation, acceptance testing, and warranty support.

1.2 Proposed Solution Overview
Our baseline solution is a [FANUC Arc Mate robotic welding cell/industrial automation system] featuring an integrated safety system, [welding power source], servo positioner, and PLC interface for seamless shop-floor integration. The system will be engineered, staged, and tested prior to delivery. Installation, commissioning, and validation will occur on site, with Government witness testing to ensure compliance.

1.3 Value and Differentiators
[NOTE: Only include claims that can be substantiated with verifiable references]
‚Ä¢ FANUC Authorized System Integrator with OEM-backed support
‚Ä¢ Universal Robots Certified Systems Partner
‚Ä¢ Proven track record with federal and state contracts
‚Ä¢ Michigan headquarters with California sales office for national coverage
‚Ä¢ Small business with MBE and WBENC certifications

---

2. TECHNICAL APPROACH

2.1 System Architecture (Baseline)
The baseline equipment and major subsystems include:
‚Ä¢ Robot: FANUC Arc Mate series robot (final model to match approved design and reach requirements)
‚Ä¢ Controller: FANUC R-30iB Plus (or current equivalent) with [welding/application] software package
‚Ä¢ [Welding power source: Lincoln Electric Power Wave class (final model per weld process requirements)]
‚Ä¢ Positioner: 2-axis servo positioner sized for Government parts and fixtures
‚Ä¢ Safety: Category-rated guarding and safety scanning/light curtains per applicable standards
‚Ä¢ Controls integration: PLC interface to existing facility controls (Rockwell/Allen-Bradley or site standard)

2.2 Integration and Interfaces
Singh Automation will conduct an initial site survey to validate space, utilities, access, and control interfaces. Following this, we will produce an approved design package, including layout, electrical, safety, I/O list, and integration plan, prior to procurement and fabrication.

2.3 Implementation Methodology
The project will be executed in three controlled phases:

Phase 1 ‚Äì Planning and Design:
‚Ä¢ Site survey and requirements validation
‚Ä¢ Preparation of design package: 2D/3D layouts, electrical schematics, safety concept, I/O list, PLC interface design
‚Ä¢ Government design review and approval checkpoint

Phase 2 ‚Äì Build, Stage, and Factory Testing:
‚Ä¢ Procurement of long-lead components and fabrication of cell enclosure/fixtures
‚Ä¢ Integration and programming of the cell in a staging environment
‚Ä¢ Factory Acceptance Test (FAT) with documented results and corrective actions

Phase 3 ‚Äì Installation, Commissioning, and Acceptance:
‚Ä¢ Delivery and installation on site with coordinated downtime windows
‚Ä¢ Site Acceptance Test (SAT) to verify functional and performance requirements
‚Ä¢ Training, as-built documentation, and transition to operations

2.4 Deliverables
‚Ä¢ Site Assessment Report and Requirements Validation Summary
‚Ä¢ Design Package for Government approval (layout, electrical, safety, controls interface)
‚Ä¢ Factory Acceptance Test (FAT) procedures and results
‚Ä¢ Installed [Robotic Welding Cell/System] (hardware, software, safety systems)
‚Ä¢ Site Acceptance Test (SAT) procedures and results; acceptance certificate
‚Ä¢ Training materials and completion records
‚Ä¢ Operations and Maintenance (O&M) manuals; as-built drawings; spare parts list
‚Ä¢ Warranty and support plan; service response process

2.5 Requirements Traceability Matrix
[To be populated with actual solicitation/PWS sections and acceptance criteria]

---

3. MANAGEMENT APPROACH

3.1 Program Management and Governance
Singh Automation will appoint a Program Manager to serve as the primary point of contact, responsible for overseeing cost, schedule, scope, and quality. Weekly status reports and a maintained issue/risk register will ensure transparent project oversight.

3.2 Organizational Structure and Roles
‚Ä¢ Program Manager: Contract point of contact; responsible for schedule, budget, reporting, and change control
‚Ä¢ Technical Lead: Engineering authority for cell design, programming, and commissioning
‚Ä¢ Quality Lead: QA/QC planning, inspection, and test documentation control
‚Ä¢ Safety Lead: Safety design review, hazard analysis, and site safety coordination
‚Ä¢ Installation Technicians: Mechanical/electrical installation and on-site support

3.3 Communications and Reporting
‚Ä¢ Weekly Status Reports: Progress updates with milestone tracking
‚Ä¢ Bi-weekly Steering Committee Meetings: Executive-level project reviews
‚Ä¢ Daily Standups: Technical team coordination and issue resolution
‚Ä¢ Issue/Risk Register: Maintained and reported weekly

3.4 Schedule Management
The baseline schedule will be submitted after award and kickoff and will incorporate long-lead procurement times and Government review windows.

---

4. KEY PERSONNEL AND STAFFING

| Role | Proposed Individual | Qualifications |
|------|---------------------|----------------|
| Program Manager | David Mih | COO/GM, PMP-eligible, 15+ years |
| Technical Lead | Soorya Sridhar | PM Electrical, Controls specialist |
| Operations Lead | Sonny Singh | Operations Manager, Mechanical systems |
| Quality Lead | Ricardo del Olmo Parrado | Resource & Compliance Manager |
| Executive Sponsor | Gurdeep Singh | Owner & Chairman |
| Primary Contact | Albert Mizuno | Principal/CEO, 786-344-8955 |

[Resumes to be included in final submission per solicitation requirements]

---

5. QUALITY ASSURANCE PLAN

5.1 Quality Control Checkpoints
| Phase | Checkpoint | Acceptance Criteria |
|-------|------------|---------------------|
| Design | Design Review | Government approval |
| Build | FAT | Functional test pass |
| Install | SAT | Performance requirements met |
| Closeout | Final Acceptance | Documentation complete |

5.2 Nonconformance and Corrective Action
Any nonconformance identified during design, FAT, installation, or SAT will be documented, including root cause analysis, corrective action, and verification of closure prior to acceptance.

---

6. RISK MANAGEMENT PLAN

| Risk | Impact | Likelihood | Mitigation |
|------|--------|------------|------------|
| Long-lead procurement delays | Schedule | Medium | Early ordering, alternative suppliers |
| Site access coordination | Schedule | Low | Pre-coordination with facility |
| Integration complexity | Technical | Medium | Detailed site survey, design reviews |
| Safety compliance | Technical | Low | Third-party safety validation |

---

7. SECURITY AND DATA HANDLING
If the project involves Government data, facility access controls, or network integration, Singh Automation will comply with all security and cybersecurity requirements specified in the solicitation and contract.

---

8. PAST PERFORMANCE
[Include 3-5 relevant projects with:
‚Ä¢ Client name
‚Ä¢ Contract value
‚Ä¢ Period of performance
‚Ä¢ Scope description
‚Ä¢ Quantified results
‚Ä¢ Reference contact (name, title, phone, email)]

---

9. PRICE PROPOSAL (Separate Volume)
| Category | Amount | % |
|----------|--------|---|
| Engineering & Design | [15%] | 15% |
| Equipment & Materials | [45%] | 45% |
| Integration & Programming | [25%] | 25% |
| Installation & Commissioning | [10%] | 10% |
| Training & Documentation | [5%] | 5% |
| **Total** | **[VALUE]** | **100%** |

---

10. ATTACHMENTS AND CERTIFICATIONS
‚òê Signed cover letter and completed solicitation forms
‚òê Key personnel resumes and commitment letters
‚òê OEM/Partner certifications (FANUC ASI, Universal Robots CSP)
‚òê Safety plan / hazard analysis summary
‚òê Quality plan and sample test procedures (FAT/SAT)
‚òê Past performance references and supporting letters
‚òê Insurance certificates
‚òê State registrations (if applicable)

---

Singh Automation LLC
CAGE: 86VF7 | UEI: GJ1DPYQ3X8K5
Headquarters: 7804 S Sprinkle Road, Portage, MI 49002
California Office: 300 Spectrum Center Dr, Suite 400, Irvine, CA 92618
Contact: albert@singhautomation.com | 786-344-8955
`;

function loadAgentMemory() {
    try {
        const saved = localStorage.getItem('singhAgentMemory');
        if (saved) {
            agentMemory = JSON.parse(saved);
            // Ensure proposalTemplates array exists (migration)
            if (!agentMemory.proposalTemplates) {
                agentMemory.proposalTemplates = [];
            }
        } else {
            // Initialize with default data including proposal template
            agentMemory = {
                pastPerformance: [
                    { id: 'pp-1', title: 'Robotic Welding Cell - Automotive Tier-1', client: 'Major Automotive Supplier', value: 425000, year: 2024, outcome: 'won', sector: 'automotive', techAreas: ['welding', 'robotics', 'vision'], metrics: '35% cycle time reduction, 99.8% first-pass quality', winFactors: 'FANUC expertise, competitive pricing, local support' },
                    { id: 'pp-2', title: 'PLC/SCADA Modernization', client: 'Industrial Manufacturer', value: 185000, year: 2024, outcome: 'won', sector: 'manufacturing', techAreas: ['plc', 'scada', 'controls'], metrics: 'Zero-downtime cutover, 99.9% uptime', winFactors: 'Allen-Bradley expertise, migration experience' },
                    { id: 'pp-3', title: 'GSA Robotic Depaint System', client: 'GSA (via Prime)', value: 485000, year: 2023, outcome: 'won', sector: 'federal', techAreas: ['robotics', 'integration'], metrics: '45% processing time reduction, zero hazardous waste', winFactors: 'Federal experience, environmental compliance' }
                ],
                winThemes: [
                    { id: 'wt-1', theme: 'Zero-downtime implementation', description: 'Proven methodology for live system migrations without operational disruption', usedIn: ['PLC/SCADA Modernization'] },
                    { id: 'wt-2', theme: 'FANUC OEM Partnership', description: 'Authorized System Integrator with direct factory support and training', usedIn: ['Robotic Welding Cell'] },
                    { id: 'wt-3', theme: '35% cycle time reduction', description: 'Demonstrated ability to significantly improve throughput with automation', usedIn: ['Robotic Welding Cell', 'Material Handling'] },
                    { id: 'wt-4', theme: 'Small business agility', description: 'Fast response, direct access to decision-makers, competitive pricing', usedIn: ['All projects'] },
                    { id: 'wt-5', theme: 'Dual-coast presence', description: 'Michigan HQ + California office enables nationwide rapid deployment', usedIn: ['Federal projects'] }
                ],
                lessons: [
                    { id: 'ls-1', lesson: 'State contracts require vendor registration BEFORE bidding', context: 'Lost Michigan DTMB opportunity due to SIGMA registration delay', actionable: 'Register with state portals proactively: SIGMA (MI), Cal eProcure (CA), etc.' },
                    { id: 'ls-2', lesson: 'Past performance references must be contactable', context: 'Almost disqualified when reference contact had changed', actionable: 'Verify all reference contact info before each submission' },
                    { id: 'ls-3', lesson: 'Price is often 40-50% of evaluation weight', context: 'Technical was strong but lost on price to competitor', actionable: 'Research incumbent pricing, consider teaming to reduce costs' }
                ],
                documents: [],
                outcomes: [],
                proposalTemplates: [
                    { id: 'pt-1', name: 'Singh Standard Technical Proposal', type: 'technical', content: SINGH_PROPOSAL_TEMPLATE, notes: 'Standard government technical proposal template with all required sections' }
                ]
            };
            saveAgentMemory();
        }
    } catch (e) {
        console.error('Failed to load agent memory:', e);
    }
    renderTrainingData();
}

function saveAgentMemory() {
    try {
        localStorage.setItem('singhAgentMemory', JSON.stringify(agentMemory));
        updateMemoryStats();
    } catch (e) {
        console.error('Failed to save agent memory:', e);
    }
}

function updateMemoryStats() {
    const el = id => document.getElementById(id);
    if (el('memoryPPCount')) el('memoryPPCount').textContent = agentMemory.pastPerformance.length;
    if (el('memoryWTCount')) el('memoryWTCount').textContent = agentMemory.winThemes.length;
    if (el('memoryDocCount')) el('memoryDocCount').textContent = agentMemory.documents.length;
    if (el('memoryTemplateCount')) el('memoryTemplateCount').textContent = (agentMemory.proposalTemplates || []).length;
    
    // Update outcome stats
    const won = agentMemory.outcomes.filter(o => o.outcome === 'won').length + agentMemory.pastPerformance.filter(p => p.outcome === 'won').length;
    const lost = agentMemory.outcomes.filter(o => o.outcome === 'lost').length + agentMemory.pastPerformance.filter(p => p.outcome === 'lost').length;
    const pending = agentMemory.outcomes.filter(o => o.outcome === 'pending').length;
    const total = won + lost;
    const winRate = total > 0 ? Math.round((won / total) * 100) : 0;
    
    if (el('trainWonCount')) el('trainWonCount').textContent = won;
    if (el('trainLostCount')) el('trainLostCount').textContent = lost;
    if (el('trainPendingCount')) el('trainPendingCount').textContent = pending;
    if (el('trainWinRate')) el('trainWinRate').textContent = winRate + '%';
}

function renderTrainingData() {
    renderPastPerformance();
    renderWinThemes();
    renderLessons();
    renderDocuments();
    renderProposalTemplates();
    renderOutcomes();
    updateMemoryStats();
}

// Past Performance
function renderPastPerformance() {
    const list = document.getElementById('pastPerformanceList');
    if (!list) return;
    
    if (agentMemory.pastPerformance.length === 0) {
        list.innerHTML = '<div style="color: var(--gray); text-align: center; padding: 1rem;">No past performance added yet</div>';
        return;
    }
    
    list.innerHTML = agentMemory.pastPerformance.map(pp => `
        <div style="background: #0a0a0a; border-radius: 6px; padding: 0.75rem; margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: start;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #fff;">${pp.title}</div>
                    <div style="font-size: 0.75rem; color: var(--gray);">${pp.client} ‚Ä¢ ${pp.year} ‚Ä¢ $${(pp.value/1000).toFixed(0)}K</div>
                    <div style="font-size: 0.7rem; color: var(--green); margin-top: 0.25rem;">üìä ${pp.metrics}</div>
                </div>
                <div style="display: flex; gap: 0.25rem; align-items: center;">
                    <span class="badge ${pp.outcome === 'won' ? 'badge-go' : pp.outcome === 'lost' ? 'badge-nogo' : 'badge-review'}">${pp.outcome?.toUpperCase() || 'N/A'}</span>
                    <button onclick="editPastPerformance('${pp.id}')" style="background: none; border: none; color: var(--gray); cursor: pointer;">‚úèÔ∏è</button>
                    <button onclick="deletePastPerformance('${pp.id}')" style="background: none; border: none; color: var(--red); cursor: pointer;">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `).join('');
}

function addPastPerformance() {
    const html = `
        <div style="padding: 1rem;">
            <h3 style="margin-bottom: 1rem;">Add Past Performance</h3>
            <div style="display: grid; gap: 0.75rem;">
                <input type="text" id="ppTitle" placeholder="Project Title" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                <input type="text" id="ppClient" placeholder="Client Name" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.5rem;">
                    <input type="number" id="ppValue" placeholder="Value ($)" style="padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                    <input type="number" id="ppYear" placeholder="Year" value="2024" style="padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                    <select id="ppOutcome" style="padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                        <option value="won">WON</option>
                        <option value="lost">LOST</option>
                        <option value="pending">PENDING</option>
                    </select>
                </div>
                <input type="text" id="ppSector" placeholder="Sector (e.g., automotive, federal, manufacturing)" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                <input type="text" id="ppTechAreas" placeholder="Tech Areas (comma-separated: welding, robotics, vision)" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                <input type="text" id="ppMetrics" placeholder="Key Metrics (e.g., 35% cycle time reduction)" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                <textarea id="ppWinFactors" placeholder="Win Factors / Why we won (or lost)" rows="2" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeTrainModal()">Cancel</button>
                <button class="btn btn-primary" onclick="savePastPerformance()">Save</button>
            </div>
        </div>
    `;
    showTrainModal(html);
}

function savePastPerformance(editId = null) {
    const pp = {
        id: editId || 'pp-' + Date.now(),
        title: document.getElementById('ppTitle').value,
        client: document.getElementById('ppClient').value,
        value: parseInt(document.getElementById('ppValue').value) || 0,
        year: parseInt(document.getElementById('ppYear').value) || 2024,
        outcome: document.getElementById('ppOutcome').value,
        sector: document.getElementById('ppSector').value,
        techAreas: document.getElementById('ppTechAreas').value.split(',').map(s => s.trim()).filter(Boolean),
        metrics: document.getElementById('ppMetrics').value,
        winFactors: document.getElementById('ppWinFactors').value
    };
    
    if (!pp.title) { alert('Title required'); return; }
    
    if (editId) {
        const idx = agentMemory.pastPerformance.findIndex(p => p.id === editId);
        if (idx >= 0) agentMemory.pastPerformance[idx] = pp;
    } else {
        agentMemory.pastPerformance.push(pp);
    }
    
    saveAgentMemory();
    renderPastPerformance();
    closeTrainModal();
}

function editPastPerformance(id) {
    const pp = agentMemory.pastPerformance.find(p => p.id === id);
    if (!pp) return;
    addPastPerformance();
    setTimeout(() => {
        document.getElementById('ppTitle').value = pp.title || '';
        document.getElementById('ppClient').value = pp.client || '';
        document.getElementById('ppValue').value = pp.value || '';
        document.getElementById('ppYear').value = pp.year || 2024;
        document.getElementById('ppOutcome').value = pp.outcome || 'won';
        document.getElementById('ppSector').value = pp.sector || '';
        document.getElementById('ppTechAreas').value = (pp.techAreas || []).join(', ');
        document.getElementById('ppMetrics').value = pp.metrics || '';
        document.getElementById('ppWinFactors').value = pp.winFactors || '';
        // Update save button to edit mode
        document.querySelector('#trainModal .btn-primary').onclick = () => savePastPerformance(id);
    }, 100);
}

function deletePastPerformance(id) {
    if (!confirm('Delete this past performance?')) return;
    agentMemory.pastPerformance = agentMemory.pastPerformance.filter(p => p.id !== id);
    saveAgentMemory();
    renderPastPerformance();
}

// Win Themes
function renderWinThemes() {
    const list = document.getElementById('winThemesList');
    if (!list) return;
    
    if (agentMemory.winThemes.length === 0) {
        list.innerHTML = '<div style="color: var(--gray); text-align: center; padding: 1rem;">No win themes added yet</div>';
        return;
    }
    
    list.innerHTML = agentMemory.winThemes.map(wt => `
        <div style="background: #0a0a0a; border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-weight: 600; color: var(--green);">üí° ${wt.theme}</div>
                <div style="font-size: 0.7rem; color: var(--gray);">${wt.description}</div>
            </div>
            <button onclick="deleteWinTheme('${wt.id}')" style="background: none; border: none; color: var(--red); cursor: pointer;">üóëÔ∏è</button>
        </div>
    `).join('');
}

function addWinTheme() {
    const html = `
        <div style="padding: 1rem;">
            <h3 style="margin-bottom: 1rem;">Add Win Theme</h3>
            <div style="display: grid; gap: 0.75rem;">
                <input type="text" id="wtTheme" placeholder="Win Theme (e.g., Zero-downtime implementation)" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                <textarea id="wtDescription" placeholder="Description - why this resonates with evaluators" rows="3" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeTrainModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveWinTheme()">Save</button>
            </div>
        </div>
    `;
    showTrainModal(html);
}

function saveWinTheme() {
    const theme = document.getElementById('wtTheme').value;
    const description = document.getElementById('wtDescription').value;
    if (!theme) { alert('Theme required'); return; }
    
    agentMemory.winThemes.push({
        id: 'wt-' + Date.now(),
        theme,
        description,
        usedIn: []
    });
    saveAgentMemory();
    renderWinThemes();
    closeTrainModal();
}

function deleteWinTheme(id) {
    if (!confirm('Delete this win theme?')) return;
    agentMemory.winThemes = agentMemory.winThemes.filter(w => w.id !== id);
    saveAgentMemory();
    renderWinThemes();
}

// Lessons Learned
function renderLessons() {
    const list = document.getElementById('lessonsList');
    if (!list) return;
    
    if (agentMemory.lessons.length === 0) {
        list.innerHTML = '<div style="color: var(--gray); text-align: center; padding: 1rem;">No lessons added yet</div>';
        return;
    }
    
    list.innerHTML = agentMemory.lessons.map(ls => `
        <div style="background: #0a0a0a; border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between;">
                <div style="font-weight: 600; color: var(--orange);">üìö ${ls.lesson}</div>
                <button onclick="deleteLesson('${ls.id}')" style="background: none; border: none; color: var(--red); cursor: pointer;">üóëÔ∏è</button>
            </div>
            <div style="font-size: 0.7rem; color: var(--gray);">${ls.actionable}</div>
        </div>
    `).join('');
}

function addLesson() {
    const html = `
        <div style="padding: 1rem;">
            <h3 style="margin-bottom: 1rem;">Add Lesson Learned</h3>
            <div style="display: grid; gap: 0.75rem;">
                <input type="text" id="lsLesson" placeholder="Lesson (e.g., State contracts require pre-registration)" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                <textarea id="lsContext" placeholder="Context - what happened" rows="2" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;"></textarea>
                <textarea id="lsActionable" placeholder="Actionable takeaway - what to do differently" rows="2" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;"></textarea>
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeTrainModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveLesson()">Save</button>
            </div>
        </div>
    `;
    showTrainModal(html);
}

function saveLesson() {
    const lesson = document.getElementById('lsLesson').value;
    const context = document.getElementById('lsContext').value;
    const actionable = document.getElementById('lsActionable').value;
    if (!lesson) { alert('Lesson required'); return; }
    
    agentMemory.lessons.push({
        id: 'ls-' + Date.now(),
        lesson,
        context,
        actionable
    });
    saveAgentMemory();
    renderLessons();
    closeTrainModal();
}

function deleteLesson(id) {
    if (!confirm('Delete this lesson?')) return;
    agentMemory.lessons = agentMemory.lessons.filter(l => l.id !== id);
    saveAgentMemory();
    renderLessons();
}

// Documents
function renderDocuments() {
    const list = document.getElementById('documentsList');
    if (!list) return;
    
    if (agentMemory.documents.length === 0) {
        list.innerHTML = '';
        return;
    }
    
    list.innerHTML = agentMemory.documents.map(doc => {
        const charCount = doc.charCount || doc.content?.length || 0;
        const hasContent = charCount > 100;
        const statusColor = hasContent ? 'var(--green)' : 'var(--red)';
        const statusIcon = hasContent ? '‚úÖ' : '‚ö†Ô∏è';
        
        return `
        <div style="background: #0a0a0a; border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: #fff;">üìÑ ${doc.name}</div>
                    <div style="font-size: 0.7rem; color: var(--gray);">
                        ${(doc.size/1024).toFixed(1)}KB ‚Ä¢ ${new Date(doc.uploaded).toLocaleDateString()}
                        ‚Ä¢ <span style="color: ${statusColor};">${statusIcon} ${charCount.toLocaleString()} chars extracted</span>
                    </div>
                </div>
                <div style="display: flex; gap: 0.25rem;">
                    <button onclick="previewDocument('${doc.id}')" style="background: none; border: none; color: var(--gray); cursor: pointer;" title="Preview">üëÅÔ∏è</button>
                    <button onclick="deleteDocument('${doc.id}')" style="background: none; border: none; color: var(--red); cursor: pointer;" title="Delete">üóëÔ∏è</button>
                </div>
            </div>
        </div>
    `}).join('');
}

// Preview document content
function previewDocument(id) {
    const doc = agentMemory.documents.find(d => d.id === id);
    if (!doc) return;
    
    const preview = doc.content?.substring(0, 3000) || '[No content extracted]';
    const html = `
        <div style="padding: 1rem;">
            <h3 style="margin-bottom: 0.5rem;">üìÑ ${doc.name}</h3>
            <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 1rem;">
                ${(doc.charCount || doc.content?.length || 0).toLocaleString()} characters extracted
            </div>
            <div style="max-height: 400px; overflow-y: auto; background: #0a0a0a; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.75rem; white-space: pre-wrap; color: var(--gray);">${preview}${doc.content?.length > 3000 ? '\n\n... [truncated]' : ''}</div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeTrainModal()">Close</button>
            </div>
        </div>
    `;
    showTrainModal(html);
}

function handleDocumentUpload(event) {
    const files = event.target.files;
    processFiles(files);
}

function handleDocumentDrop(event) {
    event.preventDefault();
    event.target.style.borderColor = 'var(--border)';
    event.target.style.background = 'transparent';
    const files = event.dataTransfer.files;
    processFiles(files);
}

async function processFiles(files) {
    for (const file of files) {
        if (file.size > 5 * 1024 * 1024) {
            alert(`${file.name} is too large (max 5MB)`);
            continue;
        }
        
        try {
            let text = '';
            const fileName = file.name.toLowerCase();
            
            // Handle different file types
            if (fileName.endsWith('.pdf')) {
                text = await extractPdfText(file);
            } else if (fileName.endsWith('.docx')) {
                text = await extractDocxText(file);
            } else {
                // Plain text, markdown, etc.
                text = await readFileAsText(file);
            }
            
            if (!text || text.trim().length < 10) {
                alert(`Could not extract text from ${file.name}`);
                continue;
            }
            
            agentMemory.documents.push({
                id: 'doc-' + Date.now() + Math.random().toString(36).substr(2, 9),
                name: file.name,
                type: file.type || 'text/plain',
                size: file.size,
                uploaded: new Date().toISOString(),
                content: text.substring(0, 50000), // Limit content size
                charCount: text.length
            });
            
            console.log(`‚úÖ Extracted ${text.length} chars from ${file.name}`);
        } catch (e) {
            console.error('Failed to read file:', e);
            alert(`Failed to read ${file.name}: ${e.message}`);
        }
    }
    saveAgentMemory();
    renderDocuments();
}

// Extract text from PDF using pdf.js
async function extractPdfText(file) {
    const arrayBuffer = await file.arrayBuffer();
    
    // Set worker source
    if (typeof pdfjsLib !== 'undefined') {
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
    }
    
    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
    let fullText = '';
    
    for (let i = 1; i <= pdf.numPages; i++) {
        const page = await pdf.getPage(i);
        const textContent = await page.getTextContent();
        const pageText = textContent.items.map(item => item.str).join(' ');
        fullText += pageText + '\n\n';
    }
    
    return fullText.trim();
}

// Extract text from DOCX using mammoth.js
async function extractDocxText(file) {
    const arrayBuffer = await file.arrayBuffer();
    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
    return result.value;
}

function readFileAsText(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = reject;
        reader.readAsText(file);
    });
}

function deleteDocument(id) {
    if (!confirm('Delete this document?')) return;
    agentMemory.documents = agentMemory.documents.filter(d => d.id !== id);
    saveAgentMemory();
    renderDocuments();
}

// Outcomes
function renderOutcomes() {
    const list = document.getElementById('outcomesList');
    if (!list) return;
    
    // Combine pipeline outcomes with tracked outcomes
    const allOutcomes = [...agentMemory.outcomes];
    
    // Add from pipeline
    Object.entries(pipeline).forEach(([id, data]) => {
        if (data.outcome && !allOutcomes.find(o => o.oppId === id)) {
            const opp = opportunities.find(o => o.id === id);
            if (opp) {
                allOutcomes.push({
                    id: 'out-' + id,
                    oppId: id,
                    title: opp.title,
                    outcome: data.outcome,
                    date: data.outcomeDate || new Date().toISOString()
                });
            }
        }
    });
    
    if (allOutcomes.length === 0) {
        list.innerHTML = '<div style="color: var(--gray); text-align: center; padding: 1rem; font-size: 0.8rem;">Mark opportunities as WON/LOST in Pipeline to track outcomes</div>';
        return;
    }
    
    list.innerHTML = allOutcomes.map(out => `
        <div style="background: #0a0a0a; border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div>
                <div style="font-size: 0.85rem; color: #fff;">${out.title}</div>
                <div style="font-size: 0.7rem; color: var(--gray);">${new Date(out.date).toLocaleDateString()}</div>
            </div>
            <span class="badge ${out.outcome === 'won' ? 'badge-go' : out.outcome === 'lost' ? 'badge-nogo' : 'badge-review'}">${out.outcome?.toUpperCase()}</span>
        </div>
    `).join('');
}

// Proposal Templates
function renderProposalTemplates() {
    const list = document.getElementById('proposalTemplatesList');
    if (!list) return;
    
    if (!agentMemory.proposalTemplates || agentMemory.proposalTemplates.length === 0) {
        list.innerHTML = '<div style="color: var(--gray); text-align: center; padding: 0.5rem; font-size: 0.8rem;">No templates added yet</div>';
        return;
    }
    
    list.innerHTML = agentMemory.proposalTemplates.map(pt => `
        <div style="background: #0a0a0a; border-radius: 6px; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center;">
            <div style="flex: 1;">
                <div style="font-weight: 600; color: var(--blue);">üìù ${pt.name}</div>
                <div style="font-size: 0.7rem; color: var(--gray);">${pt.type || 'technical'} ‚Ä¢ ${(pt.content?.length || 0).toLocaleString()} chars</div>
            </div>
            <div style="display: flex; gap: 0.25rem;">
                <button onclick="viewProposalTemplate('${pt.id}')" style="background: none; border: none; color: var(--gray); cursor: pointer;" title="View">üëÅÔ∏è</button>
                <button onclick="deleteProposalTemplate('${pt.id}')" style="background: none; border: none; color: var(--red); cursor: pointer;" title="Delete">üóëÔ∏è</button>
            </div>
        </div>
    `).join('');
}

function addProposalTemplate() {
    const html = `
        <div style="padding: 1rem;">
            <h3 style="margin-bottom: 1rem;">Add Proposal Template</h3>
            <div style="display: grid; gap: 0.75rem;">
                <input type="text" id="ptName" placeholder="Template Name (e.g., Standard Technical Proposal)" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                <select id="ptType" style="padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
                    <option value="technical">Technical Proposal</option>
                    <option value="management">Management Proposal</option>
                    <option value="price">Price Proposal</option>
                    <option value="capability">Capability Statement</option>
                    <option value="past_performance">Past Performance</option>
                </select>
                <textarea id="ptContent" placeholder="Paste the full proposal template content here..." rows="12" style="width: 100%; padding: 0.75rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff; font-family: monospace; font-size: 0.8rem;"></textarea>
                <input type="text" id="ptNotes" placeholder="Notes (optional - when to use this template)" style="width: 100%; padding: 0.5rem; background: var(--dark); border: 1px solid var(--border); border-radius: 4px; color: #fff;">
            </div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeTrainModal()">Cancel</button>
                <button class="btn btn-primary" onclick="saveProposalTemplate()">Save Template</button>
            </div>
        </div>
    `;
    showTrainModal(html);
}

function saveProposalTemplate() {
    const name = document.getElementById('ptName').value;
    const type = document.getElementById('ptType').value;
    const content = document.getElementById('ptContent').value;
    const notes = document.getElementById('ptNotes').value;
    
    if (!name || !content) { alert('Name and content required'); return; }
    
    if (!agentMemory.proposalTemplates) agentMemory.proposalTemplates = [];
    
    agentMemory.proposalTemplates.push({
        id: 'pt-' + Date.now(),
        name,
        type,
        content,
        notes,
        added: new Date().toISOString()
    });
    saveAgentMemory();
    renderProposalTemplates();
    closeTrainModal();
}

function viewProposalTemplate(id) {
    const pt = agentMemory.proposalTemplates?.find(p => p.id === id);
    if (!pt) return;
    
    const html = `
        <div style="padding: 1rem;">
            <h3 style="margin-bottom: 0.5rem;">${pt.name}</h3>
            <div style="font-size: 0.75rem; color: var(--gray); margin-bottom: 1rem;">${pt.type} ‚Ä¢ ${pt.notes || 'No notes'}</div>
            <div style="max-height: 400px; overflow-y: auto; background: #0a0a0a; padding: 1rem; border-radius: 6px; font-family: monospace; font-size: 0.75rem; white-space: pre-wrap; color: var(--gray);">${pt.content}</div>
            <div style="display: flex; gap: 0.5rem; margin-top: 1rem; justify-content: flex-end;">
                <button class="btn btn-secondary" onclick="closeTrainModal()">Close</button>
            </div>
        </div>
    `;
    showTrainModal(html);
}

function deleteProposalTemplate(id) {
    if (!confirm('Delete this proposal template?')) return;
    agentMemory.proposalTemplates = agentMemory.proposalTemplates.filter(p => p.id !== id);
    saveAgentMemory();
    renderProposalTemplates();
}

// Export/Import Memory
function exportAgentMemory() {
    const data = JSON.stringify(agentMemory, null, 2);
    const blob = new Blob([data], { type: 'application/json' });
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `singh_agent_memory_${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(a.href);
}

function importAgentMemory(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const imported = JSON.parse(e.target.result);
            if (confirm('This will replace your current agent memory. Continue?')) {
                agentMemory = imported;
                saveAgentMemory();
                renderTrainingData();
                alert('Memory imported successfully!');
            }
        } catch (err) {
            alert('Invalid memory file');
        }
    };
    reader.readAsText(file);
}

function clearAgentMemory() {
    if (!confirm('This will delete ALL agent training data. This cannot be undone. Continue?')) return;
    agentMemory = { pastPerformance: [], winThemes: [], lessons: [], documents: [], outcomes: [] };
    saveAgentMemory();
    renderTrainingData();
}

// Modal helpers
function showTrainModal(html) {
    let modal = document.getElementById('trainModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'trainModal';
        modal.style.cssText = 'position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.85); z-index: 1001; display: flex; justify-content: center; align-items: center; padding: 1rem;';
        document.body.appendChild(modal);
    }
    modal.innerHTML = `<div style="background: var(--card); border: 1px solid var(--border); border-radius: 12px; width: 100%; max-width: 500px;">${html}</div>`;
    modal.style.display = 'flex';
    modal.onclick = e => { if (e.target === modal) closeTrainModal(); };
}

function closeTrainModal() {
    const modal = document.getElementById('trainModal');
    if (modal) modal.style.display = 'none';
}

// Initialize training data on page load
document.addEventListener('DOMContentLoaded', loadAgentMemory);

</script>
</body>
</html>
